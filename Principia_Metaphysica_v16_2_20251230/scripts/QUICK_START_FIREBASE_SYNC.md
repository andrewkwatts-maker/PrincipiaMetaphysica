# Quick Start: Firebase Sync

## TL;DR

```bash
# Sync theory constants with automatic diff and history
node scripts/firebase-sync-with-history.js

# Full upload (all data: constants, formulas, pages)
node scripts/firebase-upload-all.js

# Validated push (with OOM checks, derivation validation)
node scripts/firebase-push-validated.js
```

## What's New?

All Firebase uploads now include:
- **Smart diffing**: See exactly what changed before pushing
- **Version history**: Previous versions auto-backed up to `theory_constants/history/backups/`
- **No-change detection**: Won't upload if nothing changed
- **Safe rollback**: Can restore any previous version

## Quick Examples

### Scenario 1: You updated theory values

```bash
# After running simulations and updating theory_output.json:
node scripts/firebase-sync-with-history.js
```

**Output if changes exist**:
```
Changes detected: 3
  Changed: proton_decay.M_GUT (2.1e+16 → 2.12e+16)
  Changed: pmns_matrix.theta_12 (33.41 → 33.59)
  Added: dark_energy.new_parameter

✓ Backed up to history/backups/2025-12-13_14-30-45
✓ Updated theory_constants/current
```

**Output if no changes**:
```
No changes detected - Firebase is up to date
```

### Scenario 2: Full data upload

```bash
# Upload everything (constants, formulas, pages)
node scripts/firebase-upload-all.js
```

This now uses smart sync for theory constants automatically.

### Scenario 3: Production push with validation

```bash
# Full validation + smart sync
node scripts/firebase-push-validated.js
```

Validates:
- OOM accuracy for critical parameters
- Derivation chain integrity
- No regressions from previous version

## What Changed in Your Scripts?

### Before (old behavior):
```javascript
// Directly overwrites Firebase data
await db.collection('theory_constants').doc('current').set(data);
```

**Problem**: Lost previous version, couldn't see what changed

### After (new behavior):
```javascript
// Smart sync with diff and history
const result = await firebaseSyncWithHistory();
```

**Benefits**:
- Shows diff before overwriting
- Backs up current version
- Detects when no changes needed
- Can rollback if needed

## Files Created/Modified

### New Files:
- `scripts/firebase-sync-with-history.js` - Main sync script
- `scripts/FIREBASE_SYNC_README.md` - Full documentation
- `scripts/QUICK_START_FIREBASE_SYNC.md` - This file

### Modified Files:
- `scripts/firebase-upload-all.js` - Now uses sync for theory constants
- `scripts/firebase-push-validated.js` - Now uses sync for push

## Data Locations

### Local (Single Source of Truth):
```
theory-constants-enhanced.js   ← Edit this file
theory_output.json             ← Generated by simulations
```

### Firebase Structure:
```
theory_constants/
├── current                    ← Latest synced data
├── v12_7                      ← Version snapshots
└── history/
    └── backups/
        └── 2025-12-13_14-30-45  ← Auto backups
```

## Common Tasks

### Task: Update a single value
```bash
# 1. Edit theory-constants-enhanced.js
# 2. Run sync
node scripts/firebase-sync-with-history.js
```

### Task: See what would change (dry run)
```bash
# Run sync - it will show diff but ask for confirmation
node scripts/firebase-sync-with-history.js
# Review changes, then cancel if needed
```

### Task: Force show all changes (detailed output)
```bash
node scripts/firebase-sync-with-history.js --force
```

### Task: Rollback to previous version
```bash
# In Firebase Console:
# 1. Go to theory_constants/history/backups
# 2. Find the backup you want
# 3. Copy its data
# 4. Paste into theory_constants/current
```

## Troubleshooting

| Problem | Solution |
|---------|----------|
| "Service account key not found" | Download from Firebase Console > Project Settings > Service Accounts |
| "No changes detected" but you expect changes | Check theory-constants-enhanced.js was actually modified |
| Too many changes shown | Use `--force` to see all, or check if this is a major version update |
| Firestore depth limit error | Script auto-flattens deep objects, should not happen |

## Safety Features

✅ **Automatic backups** before every overwrite
✅ **Clear diff output** shows exactly what changes
✅ **Idempotent operations** (safe to run multiple times)
✅ **Fallback logic** if sync fails
✅ **Version tracking** in metadata

## Next Steps

1. ✅ Run `node scripts/firebase-sync-with-history.js` to test
2. ✅ Review the diff output
3. ✅ Check Firebase Console to see the history/backups collection
4. ✅ Try updating a value and re-running to see the diff

## Questions?

See full documentation: `scripts/FIREBASE_SYNC_README.md`

---

**Copyright (c) 2025-2026 Andrew Keith Watts. All rights reserved.**
