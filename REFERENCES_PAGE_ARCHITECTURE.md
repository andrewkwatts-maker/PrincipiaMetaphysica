# References Page Architecture

## Overview
This document explains how the references system works in Principia Metaphysica.

## File Structure

```
PrincipiaMetaphysica/
│
├── Pages/
│   └── references.html              [Frontend - Display Page]
│       • Fetches references data from AutoGenerated/
│       • Renders references grouped by decade
│       • Provides search and filter functionality
│       • Links citations to formulas
│
├── AutoGenerated/
│   ├── references.json              [Data - References Database]
│   │   • 34 academic references
│   │   • Includes DESI, NuFIT, PDG, Joyce, Acharya, etc.
│   │   • Each with id, authors, title, year, journal, links
│   │   • Citation tracking (formulas & parameters)
│   │
│   └── theory_output.json           [Data - Full Theory Data]
│       • Complete PM theory output
│       • Includes formulas, parameters, sections
│       • Does NOT have standalone references section
│
├── js/
│   ├── pm-header.js                 [UI - Navigation]
│   ├── pm-formula-loader.js         [Logic - Formula Display]
│   └── pm-constants-loader.js       [Logic - Constants Display]
│
└── Test Files/
    ├── test-references-loading.html [Test - Browser Test]
    ├── test_references_json.py      [Test - Python Validator]
    └── test-references-json.js      [Test - Node.js Validator]
```

## Data Flow

```
┌─────────────────────────────────────────────────────────────┐
│                    Browser (User)                           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ 1. User opens references.html
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              Pages/references.html                          │
│  ┌────────────────────────────────────────────────────┐    │
│  │  JavaScript: loadReferences()                      │    │
│  │  • Tries multiple paths:                           │    │
│  │    1. ../AutoGenerated/references.json  ✅          │    │
│  │    2. ./AutoGenerated/references.json              │    │
│  │    3. /AutoGenerated/references.json               │    │
│  │    4. Fallback to theory_output.json               │    │
│  └────────────────────┬───────────────────────────────┘    │
└───────────────────────┼─────────────────────────────────────┘
                        │
                        │ 2. Fetch request
                        ▼
┌─────────────────────────────────────────────────────────────┐
│         AutoGenerated/references.json                       │
│  {                                                          │
│    "desi2025_bao": {                                        │
│      "id": "desi2025_bao",                                  │
│      "authors": "DESI Collaboration",                       │
│      "title": "DESI 2025 VI...",                           │
│      "year": 2025,                                          │
│      "journal": "arXiv preprint",                           │
│      "arxiv": "2504.03613",                                 │
│      "citedByFormulas": [...],                              │
│      "citedByParams": [...]                                 │
│    },                                                       │
│    ...                                                      │
│  }                                                          │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ 3. JSON response
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              Pages/references.html                          │
│  ┌────────────────────────────────────────────────────┐    │
│  │  JavaScript: displayReferences()                   │    │
│  │  • Convert object to array                         │    │
│  │  • Group by decade                                 │    │
│  │  • Generate HTML for each reference                │    │
│  │  • Add citation badges                             │    │
│  │  • Create links (arXiv, DOI)                       │    │
│  │  • Enable search & filter                          │    │
│  └────────────────────┬───────────────────────────────┘    │
└───────────────────────┼─────────────────────────────────────┘
                        │
                        │ 4. Render to DOM
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                    Browser Display                          │
│                                                             │
│  ┌──────────────────────────────────────────────────┐      │
│  │ References                                        │      │
│  │                                                   │      │
│  │ [Search: ________________] [All | Year | Cited]  │      │
│  │                                                   │      │
│  │ 2020s                                             │      │
│  │ ┌──────────────────────────────────────────┐     │      │
│  │ │ DESI 2025 VI: Cosmological Constraints   │ 5   │      │
│  │ │ DESI Collaboration (2025)                │     │      │
│  │ │ arXiv: 2504.03613 → DOI: ... →          │     │      │
│  │ └──────────────────────────────────────────┘     │      │
│  │                                                   │      │
│  │ 2010s                                             │      │
│  │ ┌──────────────────────────────────────────┐     │      │
│  │ │ G₂-manifolds via semi-Fano 3-folds       │ 2   │      │
│  │ │ Corti et al. (2015)                      │     │      │
│  │ └──────────────────────────────────────────┘     │      │
│  └──────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## Reference Object Structure

Each reference in `references.json` follows this schema:

```javascript
{
  // Required Fields
  "id": "unique_identifier",        // Snake_case ID
  "authors": "Author names",         // String, comma-separated
  "title": "Full paper title",       // String
  "year": 2025,                      // Integer (not string!)
  "journal": "Journal or venue",     // String

  // Optional Fields
  "arxiv": "2504.03613",            // arXiv ID (without 'arxiv:' prefix)
  "doi": "10.1234/...",             // DOI (without 'https://doi.org/' prefix)
  "description": "Relevance to PM", // Rich text explanation

  // Citation Tracking
  "citedByFormulas": [              // Array of formula IDs
    "formula_id_1",
    "formula_id_2"
  ],
  "citedByParams": [                // Array of parameter paths
    "param.path.1",
    "param.path.2"
  ]
}
```

## Key Functions in references.html

### 1. `loadReferences()`
- **Purpose**: Fetch and parse references.json
- **Tries**: Multiple paths (relative, absolute, fallback)
- **Returns**: Object with reference data
- **Error Handling**: Shows user-friendly error message

### 2. `displayReferences(references)`
- **Purpose**: Render references to DOM
- **Groups**: By decade (2020s, 2010s, etc.)
- **Sorts**: By year (descending) within each decade
- **Generates**: HTML cards for each reference

### 3. `createReferenceHTML(ref)`
- **Purpose**: Generate HTML for single reference
- **Includes**:
  - Title and authors
  - Year and journal
  - arXiv and DOI links
  - Description
  - Citation badge (count)
  - Formula/parameter tags

### 4. `searchReferences(query)`
- **Purpose**: Filter references by search term
- **Searches**: Title, authors, description, ID
- **Case**: Insensitive
- **Updates**: Display in real-time

### 5. `sortReferences(sortBy)`
- **Purpose**: Sort and display references
- **Options**:
  - `'all'`: Group by decade
  - `'year'`: Sort by year (descending)
  - `'author'`: Sort alphabetically by author
  - `'cited'`: Sort by citation count

### 6. `updateStats()`
- **Purpose**: Calculate and display statistics
- **Shows**:
  - Total reference count
  - References with arXiv
  - References with DOI
  - Average publication year
  - Total citations
  - Most cited papers (top 5)

## Path Resolution

The page is located at `Pages/references.html`, so paths are resolved as:

```
From: h:\Github\PrincipiaMetaphysica\Pages\references.html
To:   h:\Github\PrincipiaMetaphysica\AutoGenerated\references.json

Relative Path: ../AutoGenerated/references.json
               └─ Go up one level to project root
                  └─ Enter AutoGenerated directory
                     └─ Access references.json
```

### Why Multiple Paths?

Different serving contexts require different paths:

1. **`../AutoGenerated/references.json`** - Local file system, subdirectory
2. **`./AutoGenerated/references.json`** - Served from root, relative
3. **`/AutoGenerated/references.json`** - Absolute path from web server root
4. **Fallback to theory_output.json** - Legacy support (if needed)

## CSS Styling

References page uses these key style classes:

- `.ref-category` - Decade section container
- `.ref-item` - Individual reference card
- `.ref-title` - Paper title (bold, accent color)
- `.ref-authors` - Author names (secondary text)
- `.ref-year` - Publication year (muted, italic)
- `.ref-description` - Detailed description
- `.ref-links` - Container for arXiv/DOI links
- `.citation-badge` - Citation count badge
- `.ref-tag` - Formula/parameter citation tags

## Features

### Search & Filter
- Real-time search as user types
- Filter by: All, Year, Author, Most Cited
- Search matches: title, authors, description, ID

### Citation Tracking
- Shows how many times each reference is cited
- Links to specific formulas/parameters
- Helps identify most influential papers

### Statistics Panel
- Live-updated statistics
- Shows data completeness (arXiv, DOI)
- Highlights most-cited works

### Error Handling
- Multiple path fallback attempts
- Detailed error messages
- Troubleshooting guidance
- Console logging for debugging

## Testing

### Browser Test
```bash
# Start web server
python -m http.server 8000

# Open in browser
http://localhost:8000/test-references-loading.html
```

### Validation Scripts
```bash
# Python
python test_references_json.py

# Node.js
node test-references-json.js
```

## Future Enhancements

1. **Categories**: Add category tags (geometry, physics, cosmology)
2. **BibTeX Export**: Generate BibTeX entries
3. **Advanced Search**: Filter by year range, category, journal
4. **Related Papers**: Show papers that cite similar formulas
5. **Timeline View**: Visualize references on a timeline
6. **External APIs**: Fetch citation counts from Semantic Scholar
7. **Firebase Integration**: Cloud-based storage and sync

## Common Issues

### Issue: "Could not load from any path"
**Cause**: File doesn't exist or wrong path
**Fix**:
1. Verify file exists: `AutoGenerated/references.json`
2. Use web server (not file://)
3. Check browser console for CORS errors

### Issue: References display as [object Object]
**Cause**: Data not converted to array
**Fix**: Ensure `Object.values(data)` is called

### Issue: Citations not linking to formulas
**Cause**: Formula IDs don't match
**Fix**: Ensure `citedByFormulas` IDs match formula page IDs

## Maintenance

### Adding New References
1. Edit `AutoGenerated/references.json`
2. Add new object with required fields
3. Test with validation script
4. Reload references.html

### Updating Citation Links
1. Identify formula/parameter using reference
2. Add ID to `citedByFormulas` or `citedByParams` array
3. Reload references.html to see badge update

---
**Last Updated**: December 29, 2025
**Maintainer**: Andrew Keith Watts
