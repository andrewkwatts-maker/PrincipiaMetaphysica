# PM Paper Tooltips - Architecture Diagram

## System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                    PM PAPER TOOLTIPS SYSTEM                          │
│                         Version 1.0.0                                │
└─────────────────────────────────────────────────────────────────────┘
```

## Data Flow Architecture

```
┌───────────────────────────────────────────────────────────────┐
│                        DATA SOURCES                            │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  AutoGenerated/                                                │
│  ├── formulas.json       ◄── 91 formulas with terms           │
│  └── parameters.json     ◄── All parameters with metadata     │
│                                                                │
└───────────────────────────────────────────────────────────────┘
                              ↓
            ┌─────────────────┴─────────────────┐
            ↓                                   ↓
┌──────────────────────┐           ┌──────────────────────┐
│  PMFormulaLoader     │           │  PM (Constants)      │
├──────────────────────┤           ├──────────────────────┤
│ • Load formulas      │           │ • Load parameters    │
│ • Cache in memory    │           │ • Cache in memory    │
│ • Provide get()      │           │ • Provide get()      │
└──────────────────────┘           └──────────────────────┘
            │                                   │
            └─────────────────┬─────────────────┘
                              ↓
            ┌─────────────────────────────────┐
            │   PMPaperTooltips.state         │
            ├─────────────────────────────────┤
            │ • formulasCache                 │
            │ • parametersCache               │
            └─────────────────────────────────┘
                              ↓
            ┌─────────────────────────────────┐
            │   TOOLTIP RENDERING             │
            └─────────────────────────────────┘
```

## Component Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                     CORE TOOLTIP SYSTEM                          │
│                  (pm-paper-tooltips.js)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  INITIALIZATION                                         │    │
│  │  • createTooltipContainer()                             │    │
│  │  • setupTooltips()                                      │    │
│  │  • loadDataCaches()                                     │    │
│  └────────────────────────────────────────────────────────┘    │
│                          ↓                                      │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  TOOLTIP HANDLERS (Event Delegation)                    │    │
│  │  ├─ setupFormulaVariableTooltips()                      │    │
│  │  ├─ setupParameterTooltips()                            │    │
│  │  ├─ setupFormulaReferenceTooltips()                     │    │
│  │  ├─ setupCitationTooltips()                             │    │
│  │  └─ setupAcronymTooltips()                              │    │
│  └────────────────────────────────────────────────────────┘    │
│                          ↓                                      │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  TOOLTIP DISPLAY                                        │    │
│  │  ├─ showTooltip(event, content, type)                   │    │
│  │  │   ├─ Set content                                     │    │
│  │  │   ├─ positionTooltip(tooltip, event)                 │    │
│  │  │   │   ├─ Calculate initial position                  │    │
│  │  │   │   ├─ Check viewport boundaries                   │    │
│  │  │   │   ├─ Adjust if overflowing                       │    │
│  │  │   │   └─ Apply final position                        │    │
│  │  │   └─ Trigger MathJax (if needed)                     │    │
│  │  ├─ scheduleHide()                                       │    │
│  │  └─ hideTooltip()                                        │    │
│  └────────────────────────────────────────────────────────┘    │
│                          ↓                                      │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  INTERACTIVE FEATURES                                   │    │
│  │  ├─ setupCopyToClipboard()                              │    │
│  │  ├─ setupLatexToggle()                                  │    │
│  │  └─ setupCollapsibleDerivations()                       │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Auto-Enhancement Pipeline

```
┌─────────────────────────────────────────────────────────────────┐
│               AUTO-ENHANCEMENT SYSTEM                            │
│           (pm-paper-tooltips-integration.js)                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────┐          │
│  │  INPUT: Raw HTML                                  │          │
│  │  ─────────────────────────────────────            │          │
│  │  <p>See Eq. (4.2) for the SM prediction</p>       │          │
│  └──────────────────────────────────────────────────┘          │
│                          ↓                                       │
│  ┌──────────────────────────────────────────────────┐          │
│  │  ENHANCEMENT PASSES                               │          │
│  │  ───────────────────                              │          │
│  │  1. enhanceEquationReferences()                   │          │
│  │     • Find "Eq. (X.X)" patterns                   │          │
│  │     • Convert to <a href="#eq-X.X">               │          │
│  │                                                    │          │
│  │  2. enhanceParameterValues()                      │          │
│  │     • Add .pm-value class                         │          │
│  │                                                    │          │
│  │  3. enhanceAcronyms()                             │          │
│  │     • Find acronyms (SM, GUT, etc.)               │          │
│  │     • Wrap in <abbr class="acronym">              │          │
│  │                                                    │          │
│  │  4. enhanceFormulaVariables()                     │          │
│  │     • Mark <i> tags in equations                  │          │
│  │     • Add tooltip-enabled class                   │          │
│  └──────────────────────────────────────────────────┘          │
│                          ↓                                       │
│  ┌──────────────────────────────────────────────────┐          │
│  │  OUTPUT: Enhanced HTML                            │          │
│  │  ─────────────────────────────────────            │          │
│  │  <p>See <a href="#eq-4.2" class="equation-ref">  │          │
│  │  Eq. (4.2)</a> for the <abbr class="acronym">    │          │
│  │  SM</abbr> prediction</p>                         │          │
│  └──────────────────────────────────────────────────┘          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Tooltip Rendering Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    USER INTERACTION                              │
└─────────────────────────────────────────────────────────────────┘
                          ↓
        ┌─────────────────┴─────────────────┐
        ↓                                   ↓
  ┌──────────┐                      ┌──────────────┐
  │  HOVER   │                      │  TAP (Mobile)│
  │  (Desktop)│                     │              │
  └──────────┘                      └──────────────┘
        │                                   │
        └─────────────────┬─────────────────┘
                          ↓
          ┌───────────────────────────────┐
          │  showTimeout (200ms delay)    │
          └───────────────────────────────┘
                          ↓
          ┌───────────────────────────────┐
          │  Identify Element Type        │
          │  • data-pm-value?             │
          │  • equation-ref?              │
          │  • acronym?                   │
          │  • <i> in equation?           │
          └───────────────────────────────┘
                          ↓
          ┌───────────────────────────────┐
          │  Load Data                    │
          │  • formulasCache[id]          │
          │  • parametersCache[path]      │
          │  • acronyms[key]              │
          └───────────────────────────────┘
                          ↓
          ┌───────────────────────────────┐
          │  Build HTML Content           │
          │  • Header section             │
          │  • Body section               │
          │  • Metadata                   │
          └───────────────────────────────┘
                          ↓
          ┌───────────────────────────────┐
          │  Position Tooltip             │
          │  1. cursor + offset           │
          │  2. Check viewport            │
          │  3. Adjust if needed          │
          └───────────────────────────────┘
                          ↓
          ┌───────────────────────────────┐
          │  Display Tooltip              │
          │  • Fade in animation          │
          │  • Trigger MathJax            │
          └───────────────────────────────┘
                          ↓
          ┌───────────────────────────────┐
          │  User Moves Away              │
          └───────────────────────────────┘
                          ↓
          ┌───────────────────────────────┐
          │  hideTimeout (100ms delay)    │
          └───────────────────────────────┘
                          ↓
          ┌───────────────────────────────┐
          │  Hide Tooltip                 │
          │  • Fade out                   │
          │  • Clear content              │
          └───────────────────────────────┘
```

## Smart Positioning Algorithm

```
┌─────────────────────────────────────────────────────────────────┐
│                 SMART POSITIONING SYSTEM                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  INPUT:                                                          │
│  • Cursor position (pageX, pageY)                               │
│  • Tooltip dimensions (width, height)                           │
│  • Viewport bounds (window.innerWidth, window.innerHeight)      │
│                                                                  │
│  ┌────────────────────────────────────────────────┐            │
│  │  STEP 1: Initial Position                      │            │
│  │  ─────────────────────────                     │            │
│  │  x = pageX + OFFSET_X (12px)                   │            │
│  │  y = pageY + OFFSET_Y (12px)                   │            │
│  └────────────────────────────────────────────────┘            │
│                     ↓                                            │
│  ┌────────────────────────────────────────────────┐            │
│  │  STEP 2: Check Right Edge                      │            │
│  │  ─────────────────────────                     │            │
│  │  if (x + width > viewportRight - MARGIN)       │            │
│  │      x = pageX - width - OFFSET_X              │            │
│  │      (flip to left of cursor)                  │            │
│  └────────────────────────────────────────────────┘            │
│                     ↓                                            │
│  ┌────────────────────────────────────────────────┐            │
│  │  STEP 3: Check Bottom Edge                     │            │
│  │  ─────────────────────────                     │            │
│  │  if (y + height > viewportBottom - MARGIN)     │            │
│  │      y = pageY - height - OFFSET_Y             │            │
│  │      (flip above cursor)                       │            │
│  └────────────────────────────────────────────────┘            │
│                     ↓                                            │
│  ┌────────────────────────────────────────────────┐            │
│  │  STEP 4: Check Left Edge                       │            │
│  │  ─────────────────────────                     │            │
│  │  if (x < MARGIN)                               │            │
│  │      x = MARGIN                                │            │
│  └────────────────────────────────────────────────┘            │
│                     ↓                                            │
│  ┌────────────────────────────────────────────────┐            │
│  │  STEP 5: Check Top Edge                        │            │
│  │  ─────────────────────────                     │            │
│  │  if (y < MARGIN)                               │            │
│  │      y = MARGIN                                │            │
│  └────────────────────────────────────────────────┘            │
│                     ↓                                            │
│  ┌────────────────────────────────────────────────┐            │
│  │  STEP 6: Mobile Override                       │            │
│  │  ─────────────────────────                     │            │
│  │  if (isMobile)                                 │            │
│  │      x = 5vw                                   │            │
│  │      y = 50vh (centered vertically)            │            │
│  │      width = 90vw                              │            │
│  └────────────────────────────────────────────────┘            │
│                     ↓                                            │
│  OUTPUT:                                                         │
│  • Final tooltip position (x, y)                                │
│  • Guaranteed to fit in viewport                                │
│  • Minimum margins respected                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Event Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                      EVENT LISTENERS                             │
│                    (Event Delegation)                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  document.addEventListener('mouseover', handler)                 │
│     ↓                                                            │
│  ┌────────────────────────────────────┐                         │
│  │  Check Target Element               │                         │
│  │  ─────────────────────             │                         │
│  │  • isInEquation()?                  │                         │
│  │  • hasAttribute('data-pm-value')?   │                         │
│  │  • classList.contains('acronym')?   │                         │
│  │  • classList.contains('citation')?  │                         │
│  └────────────────────────────────────┘                         │
│     ↓                                                            │
│  ┌────────────────────────────────────┐                         │
│  │  Route to Handler                   │                         │
│  │  ─────────────────                 │                         │
│  │  • showVariableTooltip()            │                         │
│  │  • showParameterTooltip()           │                         │
│  │  • showFormulaReferenceTooltip()    │                         │
│  │  • showCitationTooltip()            │                         │
│  │  • showAcronymTooltip()             │                         │
│  └────────────────────────────────────┘                         │
│                                                                  │
│  document.addEventListener('mouseout', handler)                  │
│     ↓                                                            │
│  scheduleHide()                                                  │
│                                                                  │
│  MOBILE:                                                         │
│  document.addEventListener('touchstart', handler)                │
│     ↓                                                            │
│  ┌────────────────────────────────────┐                         │
│  │  Check Target                       │                         │
│  │  ─────────────────                 │                         │
│  │  if (currentTarget === target)      │                         │
│  │      hideTooltip() // toggle off    │                         │
│  │  else                               │                         │
│  │      showTooltip() // show new      │                         │
│  └────────────────────────────────────┘                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## CSS Class Hierarchy

```
.pm-paper-tooltip                    ← Main container
├── .pm-tooltip-{type}               ← Type-specific styling
│   ├── .pm-tooltip-variable
│   ├── .pm-tooltip-parameter
│   ├── .pm-tooltip-formula-ref
│   ├── .pm-tooltip-citation
│   └── .pm-tooltip-acronym
│
├── .tooltip-header                  ← Header section
│   ├── .tooltip-variable
│   ├── .tooltip-param-name
│   ├── .tooltip-equation-number
│   ├── .tooltip-citation-key
│   └── .tooltip-acronym
│
└── .tooltip-body                    ← Content section
    ├── .tooltip-description
    ├── .tooltip-value-row
    │   ├── strong (value)
    │   └── .tooltip-units
    ├── .tooltip-uncertainty
    ├── .tooltip-source
    ├── .tooltip-param-link
    ├── .tooltip-status
    ├── .tooltip-equation-preview
    ├── .tooltip-link
    └── .tooltip-action
```

## Interactive Features Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                  INTERACTIVE FEATURES                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────┐             │
│  │  COPY TO CLIPBOARD                             │             │
│  │  ──────────────────                            │             │
│  │  Click button → copyToClipboard(latex)         │             │
│  │    ↓                                           │             │
│  │  Try navigator.clipboard.writeText()           │             │
│  │    ↓                                           │             │
│  │  if (success)                                  │             │
│  │      Show "✓ Copied!" feedback                 │             │
│  │  else (fallback)                               │             │
│  │      Use document.execCommand('copy')          │             │
│  └───────────────────────────────────────────────┘             │
│                                                                  │
│  ┌───────────────────────────────────────────────┐             │
│  │  LATEX/PLAIN TEXT TOGGLE                       │             │
│  │  ─────────────────────────                     │             │
│  │  Click button                                  │             │
│  │    ↓                                           │             │
│  │  card.classList.toggle('show-plaintext')       │             │
│  │    ↓                                           │             │
│  │  CSS hides LaTeX, shows plain text             │             │
│  │    .pm-formula-card.show-plaintext             │             │
│  │      .pm-formula-latex { display: none }       │             │
│  │      .pm-plaintext-section { display: block }  │             │
│  └───────────────────────────────────────────────┘             │
│                                                                  │
│  ┌───────────────────────────────────────────────┐             │
│  │  COLLAPSIBLE DERIVATIONS                       │             │
│  │  ───────────────────────                       │             │
│  │  Click expand button                           │             │
│  │    ↓                                           │             │
│  │  card.classList.toggle('expanded')             │             │
│  │    ↓                                           │             │
│  │  CSS transitions max-height & opacity          │             │
│  │    .expanded .pm-formula-details {             │             │
│  │      max-height: 1000px;                       │             │
│  │      opacity: 1;                               │             │
│  │    }                                           │             │
│  └───────────────────────────────────────────────┘             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Performance Optimization Strategy

```
┌─────────────────────────────────────────────────────────────────┐
│                   PERFORMANCE OPTIMIZATIONS                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────┐             │
│  │  1. LAZY RENDERING                             │             │
│  │  • Tooltips created on-demand                  │             │
│  │  • Not pre-rendered in DOM                     │             │
│  │  • Single element reused for all tooltips      │             │
│  └───────────────────────────────────────────────┘             │
│                                                                  │
│  ┌───────────────────────────────────────────────┐             │
│  │  2. DATA CACHING                               │             │
│  │  • Load formulas.json once                     │             │
│  │  • Load parameters.json once                   │             │
│  │  • Store in memory (TooltipState)              │             │
│  │  • No repeated fetches                         │             │
│  └───────────────────────────────────────────────┘             │
│                                                                  │
│  ┌───────────────────────────────────────────────┐             │
│  │  3. EVENT DELEGATION                           │             │
│  │  • 5 listeners total (not per-element)         │             │
│  │  • Bubbles from document root                  │             │
│  │  • Check event.target dynamically              │             │
│  └───────────────────────────────────────────────┘             │
│                                                                  │
│  ┌───────────────────────────────────────────────┐             │
│  │  4. DEBOUNCED SHOW/HIDE                        │             │
│  │  • 200ms show delay                            │             │
│  │  • 100ms hide delay                            │             │
│  │  • Prevents rapid flicker                      │             │
│  │  • clearTimeout() on new event                 │             │
│  └───────────────────────────────────────────────┘             │
│                                                                  │
│  ┌───────────────────────────────────────────────┐             │
│  │  5. REQUESTANIMATIONFRAME                      │             │
│  │  • Position calc in next frame                 │             │
│  │  • Ensures accurate dimensions                 │             │
│  │  • Prevents layout thrashing                   │             │
│  └───────────────────────────────────────────────┘             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## File Dependencies

```
test-paper-tooltips.html
  ↓
  ├─ css/pm-paper-tooltips.css
  │
  └─ js/pm-constants-loader.js
      ↓
      └─ AutoGenerated/parameters.json

  └─ js/pm-formula-loader.js
      ↓
      └─ AutoGenerated/formulas.json

  └─ js/pm-paper-renderer.js
      ↓
      └─ theory_output.json (fallback)

  └─ js/pm-paper-tooltips.js
      ↓
      ├─ Depends on PM (constants)
      ├─ Depends on PMFormulaLoader
      └─ Creates tooltip DOM elements

  └─ js/pm-paper-tooltips-integration.js
      ↓
      └─ Enhances DOM after rendering
```

---

**Architecture Version:** 1.0.0
**Last Updated:** 2025-12-28
**Status:** Production-ready
