#!/usr/bin/env python3
"""
Add section information to formulas in formulas.json
Maps formulas to their sections based on formula_refs in theory_output.json sections
"""

import json
from pathlib import Path

def add_section_to_formulas():
    """Add section field to all formulas based on section formula_refs"""

    base_path = Path(__file__).parent
    formulas_json_path = base_path / 'AutoGenerated' / 'formulas.json'
    theory_output_path = base_path / 'AutoGenerated' / 'theory_output.json'

    # Load files
    with open(formulas_json_path, 'r', encoding='utf-8') as f:
        formulas_data = json.load(f)

    with open(theory_output_path, 'r', encoding='utf-8') as f:
        theory_data = json.load(f)

    formulas_dict = formulas_data.get('formulas', {})
    sections_dict = theory_data.get('sections', {})

    print(f"Processing {len(formulas_dict)} formulas across {len(sections_dict)} sections")

    # Build formula_id -> section_number mapping
    formula_to_section = {}

    for section_num, section_data in sections_dict.items():
        formula_refs = section_data.get('formula_refs', []) or section_data.get('formulaRefs', [])
        for formula_id in formula_refs:
            formula_to_section[formula_id] = section_num

    print(f"Mapped {len(formula_to_section)} formulas to sections")

    # Add section field to formulas
    updated = 0
    not_found = []

    for formula_id, formula in formulas_dict.items():
        if formula_id in formula_to_section:
            formula['section'] = formula_to_section[formula_id]
            formula['sectionId'] = formula_to_section[formula_id]
            updated += 1
        else:
            not_found.append(formula_id)

    print(f"Updated {updated} formulas with section information")

    if not_found:
        print(f"WARNING: {len(not_found)} formulas not found in any section:")
        for fid in not_found[:10]:
            print(f"  - {fid}")
        if len(not_found) > 10:
            print(f"  ... and {len(not_found) - 10} more")

    # Save updated formulas.json
    with open(formulas_json_path, 'w', encoding='utf-8') as f:
        json.dump(formulas_data, f, indent=2, ensure_ascii=False)

    print(f"\nSaved updated formulas.json with section information")

    return True

if __name__ == '__main__':
    add_section_to_formulas()
