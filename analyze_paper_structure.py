#!/usr/bin/env python3
"""Analyze paper structure for review."""

import json
import sys

sys.stdout.reconfigure(encoding='utf-8')

with open('AutoGenerated/theory_output.json', encoding='utf-8') as f:
    data = json.load(f)

print("=" * 80)
print("PAPER STRUCTURE ANALYSIS")
print("=" * 80)

# Check sections
sections = data.get('sections', {})
print(f"\n1. SECTIONS: {len(sections)} total")
print("-" * 80)

main_sections = []
appendices = []

for sid, section in sorted(sections.items(), key=lambda x: (not x[0].isdigit(), x[0])):
    is_appendix = not sid.isdigit() or sid == '8'
    if is_appendix:
        appendices.append((sid, section))
    else:
        main_sections.append((sid, section))

    abstract = section.get('abstract', '')
    content_blocks = section.get('contentBlocks', [])
    formula_refs = section.get('formulaRefs', [])
    param_refs = section.get('paramRefs', [])

    print(f"\nSection {sid}: {section.get('title')}")
    print(f"  Abstract: {len(abstract)} chars")
    print(f"  Content blocks: {len(content_blocks)}")
    print(f"  Formula refs: {len(formula_refs)}")
    print(f"  Param refs: {len(param_refs)}")

    # Check block types
    block_types = {}
    for block in content_blocks:
        btype = block.get('type', 'unknown')
        block_types[btype] = block_types.get(btype, 0) + 1
    print(f"  Block types: {dict(block_types)}")

print(f"\n\nMain sections (1-7): {len(main_sections)}")
print(f"Appendices: {len(appendices)}")

# Check formulas
print("\n" + "=" * 80)
print("2. FORMULAS")
print("-" * 80)

formulas = data.get('formulas', {})
print(f"Total formulas: {len(formulas)}")

formula_with_section = [f for f in formulas.values() if f.get('section')]
print(f"Formulas with section field: {len(formula_with_section)}")

# Sample formula
if formulas:
    sample_id = list(formulas.keys())[0]
    sample = formulas[sample_id]
    print(f"\nSample formula ({sample_id}):")
    print(f"  Keys: {list(sample.keys())}")
    print(f"  Label: {sample.get('label', 'NONE')}")
    print(f"  Has latex: {'latex' in sample}")
    print(f"  Has description: {'description' in sample}")
    print(f"  Has derivation: {'derivation' in sample}")
    print(f"  Category: {sample.get('category', 'NONE')}")

# Check formula blocks in sections
print("\n" + "=" * 80)
print("3. FORMULA BLOCKS IN SECTIONS")
print("-" * 80)

for sid in ['1', '2', '3']:
    if sid not in sections:
        continue
    section = sections[sid]
    content_blocks = section.get('contentBlocks', [])
    formula_blocks = [b for b in content_blocks if b.get('type') in ['equation', 'formula']]

    print(f"\nSection {sid}: {len(formula_blocks)} formula blocks")

    if formula_blocks:
        fb = formula_blocks[0]
        print(f"  First block keys: {list(fb.keys())}")
        print(f"  Has formulaId: {'formulaId' in fb}")
        print(f"  Has id: {'id' in fb}")
        print(f"  Has latex: {'latex' in fb}")
        print(f"  Has content: {'content' in fb}")
        if 'content' in fb:
            print(f"  Content preview: {str(fb['content'])[:100]}...")

# Check parameters
print("\n" + "=" * 80)
print("4. PARAMETERS")
print("-" * 80)

parameters = data.get('parameters', {})
print(f"Total parameters: {len(parameters)}")

if parameters:
    sample_key = list(parameters.keys())[0]
    sample_param = parameters[sample_key]
    print(f"\nSample parameter ({sample_key}):")
    print(f"  Keys: {list(sample_param.keys())}")
    print(f"  Has value: {'value' in sample_param}")
    print(f"  Has description: {'description' in sample_param}")

# Check metadata
print("\n" + "=" * 80)
print("5. METADATA")
print("-" * 80)

metadata = data.get('metadata', {})
print(f"Version: {metadata.get('version', 'UNKNOWN')}")
print(f"Timestamp: {metadata.get('timestamp', 'UNKNOWN')}")
print(f"Git commit: {metadata.get('git', {}).get('commit_hash', 'UNKNOWN')[:8]}")

print("\n" + "=" * 80)
print("ANALYSIS COMPLETE")
print("=" * 80)
