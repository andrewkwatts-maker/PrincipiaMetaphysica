#!/usr/bin/env python3
"""
POLISH AGENT 5: Section Content Scientific Accuracy Review
Checks sections in theory_output.json for scientific accuracy and v16.2 alignment
"""

import json
import re

def load_theory_data():
    """Load theory_output.json"""
    with open('H:/Github/PrincipiaMetaphysica/AutoGenerated/theory_output.json', encoding='utf-8') as f:
        return json.load(f)

def extract_section_content(section_data):
    """Extract content from section data"""
    if isinstance(section_data, str):
        return section_data
    elif isinstance(section_data, dict):
        # Check for contentBlocks or content_blocks
        content_blocks = section_data.get('contentBlocks', section_data.get('content_blocks', []))
        if content_blocks:
            # Concatenate all content from blocks
            all_content = []
            for block in content_blocks:
                if isinstance(block, dict):
                    block_content = block.get('content', '')
                    if block_content:
                        # Handle both string and list content
                        if isinstance(block_content, str):
                            all_content.append(block_content)
                        elif isinstance(block_content, list):
                            # Flatten list content (e.g., list items)
                            all_content.extend([str(item) for item in block_content if item])
            return '\n'.join(all_content)
        # Fallback to simple content field
        return section_data.get('content', '')
    return ''

def check_desi_2025_values(content):
    """Check for DESI 2025 dark energy equation of state parameters"""
    issues = []

    # Expected values: w0 = -0.727 ± 0.067, wa = -0.99 ± 0.32
    w0_patterns = [
        r'w_0\s*=\s*(-?[\d.]+)',
        r'w0\s*=\s*(-?[\d.]+)',
        r'w_\{0\}\s*=\s*(-?[\d.]+)',
    ]

    wa_patterns = [
        r'w_a\s*=\s*(-?[\d.]+)',
        r'wa\s*=\s*(-?[\d.]+)',
        r'w_\{a\}\s*=\s*(-?[\d.]+)',
    ]

    for pattern in w0_patterns:
        matches = re.findall(pattern, content)
        for match in matches:
            try:
                val = float(match)
                if abs(val - (-0.727)) > 0.1:  # More than 0.1 difference
                    issues.append(f"w0 value {val} differs from DESI 2025: -0.727 ± 0.067")
            except ValueError:
                pass

    for pattern in wa_patterns:
        matches = re.findall(pattern, content)
        for match in matches:
            try:
                val = float(match)
                if abs(val - (-0.99)) > 0.4:  # More than 0.4 difference
                    issues.append(f"wa value {val} differs from DESI 2025: -0.99 ± 0.32")
            except ValueError:
                pass

    # Check for old DESI values (2024 or earlier)
    if 'DESI 2024' in content or 'DESI2024' in content:
        issues.append("References DESI 2024 instead of DESI 2025")

    return issues

def check_nufit_6_values(content):
    """Check for NuFIT 6.0 neutrino mixing parameters"""
    issues = []

    # Check for outdated NuFIT versions
    if re.search(r'NuFIT\s*5\.', content) or re.search(r'NuFIT\s*4\.', content):
        issues.append("References outdated NuFIT version (should be 6.0)")

    # Check for IO (Inverted Ordering) preference mention
    if 'NuFIT' in content and 'inverted' not in content.lower() and 'ordering' in content.lower():
        # NuFIT 6.0 prefers IO, should be mentioned
        pass  # Not necessarily an error

    # Check for specific parameter values (NuFIT 6.0 IO best-fit)
    # θ12 ≈ 33.41°, θ23 ≈ 49.26°, θ13 ≈ 8.58°
    theta12_pattern = r'θ_?12.*?(\d+\.?\d*)'
    theta23_pattern = r'θ_?23.*?(\d+\.?\d*)'
    theta13_pattern = r'θ_?13.*?(\d+\.?\d*)'

    return issues

def check_g2_manifold(content):
    """Check G2 manifold description"""
    issues = []

    # Check for b3 = 24
    b3_patterns = [r'b_3\s*=\s*(\d+)', r'b3\s*=\s*(\d+)', r'third Betti number.*?(\d+)']
    for pattern in b3_patterns:
        matches = re.findall(pattern, content, re.IGNORECASE)
        for match in matches:
            if match != '24':
                issues.append(f"b3 = {match} (should be 24 for G2 manifold)")

    # Check for 7-dimensional mention
    if 'G2' in content and '7-dimension' not in content and '7-dim' not in content:
        # G2 should be described as 7-dimensional
        pass  # Not critical

    return issues

def check_gauge_unification(content):
    """Check gauge unification values"""
    issues = []

    # M_GUT should be around 2-3 × 10^16 GeV
    mgut_patterns = [
        r'M_\{GUT\}\s*[~≈=]\s*([\d.]+)\s*×\s*10\^?\{?(\d+)',
        r'M_GUT\s*[~≈=]\s*([\d.]+)\s*×\s*10\^?\{?(\d+)',
        r'GUT scale.*?([\d.]+)\s*×\s*10\^?\{?(\d+)',
    ]

    for pattern in mgut_patterns:
        matches = re.findall(pattern, content)
        for match in matches:
            try:
                coef = float(match[0])
                exp = int(match[1])
                if exp == 16:
                    if coef < 1.0 or coef > 5.0:
                        issues.append(f"M_GUT = {coef}×10^{exp} GeV seems outside typical range (2-3×10^16 GeV)")
                elif exp != 16:
                    issues.append(f"M_GUT scale 10^{exp} unusual (typically 10^16 GeV)")
            except (ValueError, IndexError):
                pass

    # α_GUT should be around 1/24 to 1/25
    alpha_gut_patterns = [
        r'α_\{GUT\}\s*[~≈=]\s*1/(\d+)',
        r'alpha_GUT\s*[~≈=]\s*1/(\d+)',
        r'α_GUT\s*[~≈=]\s*1/(\d+)',
    ]

    for pattern in alpha_gut_patterns:
        matches = re.findall(pattern, content)
        for match in matches:
            try:
                denom = int(match)
                if denom < 20 or denom > 30:
                    issues.append(f"α_GUT = 1/{denom} outside typical range (1/24 to 1/25)")
            except ValueError:
                pass

    return issues

def check_fermion_sector(content):
    """Check fermion sector physics"""
    issues = []

    # Check for 3 generations
    if 'generation' in content.lower():
        gen_patterns = [r'(\d+)\s+generation', r'generation.*?(\d+)']
        for pattern in gen_patterns:
            matches = re.findall(pattern, content, re.IGNORECASE)
            for match in matches:
                if match != '3':
                    issues.append(f"Mentions {match} generations (should be 3)")

    # Check for Yukawa coupling structure
    # Yukawas should have hierarchical structure

    return issues

def check_cosmology_section(content):
    """Check cosmology section for Hubble tension and dark energy"""
    issues = []

    # Hubble tension: local measurements ~73 km/s/Mpc, CMB ~67 km/s/Mpc
    h0_patterns = [
        r'H_0\s*[~≈=]\s*([\d.]+)',
        r'Hubble constant.*?([\d.]+)\s*km/s/Mpc',
    ]

    for pattern in h0_patterns:
        matches = re.findall(pattern, content)
        for match in matches:
            try:
                val = float(match)
                if val < 60 or val > 80:
                    issues.append(f"H0 = {val} km/s/Mpc outside expected range (67-73)")
            except ValueError:
                pass

    # Check for dark energy discussion
    issues.extend(check_desi_2025_values(content))

    return issues

def analyze_section(section_id, section_data):
    """Analyze a single section for scientific accuracy"""
    print(f"\n{'='*80}")
    print(f"SECTION {section_id}")
    print(f"{'='*80}")

    if isinstance(section_data, dict):
        title = section_data.get('title', 'No title')
        content = extract_section_content(section_data)
        print(f"Title: {title}")
    else:
        title = f"Section {section_id}"
        content = str(section_data)
        print(f"Title: {title} (stored as string)")

    print(f"Content length: {len(content)} characters")

    all_issues = []

    # Section-specific checks
    if section_id == '2' or 'geometric' in title.lower():
        print("\n[Checking: G2 Manifold and Geometric Framework]")
        issues = check_g2_manifold(content)
        if issues:
            all_issues.extend(issues)
            for issue in issues:
                print(f"  WARNING: {issue}")
        else:
            print("  OK: No issues found")

    if section_id == '3' or 'gauge' in title.lower() or 'unification' in title.lower():
        print("\n[Checking: Gauge Unification]")
        issues = check_gauge_unification(content)
        if issues:
            all_issues.extend(issues)
            for issue in issues:
                print(f"  WARNING: {issue}")
        else:
            print("  OK: No issues found")

    if section_id == '4' or 'fermion' in title.lower():
        print("\n[Checking: Fermion Sector]")
        issues = check_fermion_sector(content)
        if issues:
            all_issues.extend(issues)
            for issue in issues:
                print(f"  WARNING: {issue}")
        else:
            print("  OK: No issues found")

    if section_id == '5' or 'cosmology' in title.lower() or 'cosmological' in title.lower():
        print("\n[Checking: Cosmology - Hubble Tension & Dark Energy]")
        issues = check_cosmology_section(content)
        if issues:
            all_issues.extend(issues)
            for issue in issues:
                print(f"  WARNING: {issue}")
        else:
            print("  OK: No issues found")

    # General checks for all sections
    print("\n[Checking: NuFIT 6.0 Neutrino Parameters]")
    issues = check_nufit_6_values(content)
    if issues:
        all_issues.extend(issues)
        for issue in issues:
            print(f"  WARNING: {issue}")
    else:
        print("  OK: No issues found")

    # Show preview of content
    if content:
        try:
            preview = content[:500].replace('\n', ' ')
            # Try to encode as ASCII-safe for display
            preview_safe = preview.encode('ascii', errors='replace').decode('ascii')
            print(f"\nContent preview: {preview_safe}...")
        except Exception as e:
            print(f"\nContent preview: [Unicode display error]")

    return all_issues

def main():
    print("POLISH AGENT 5: Section Content Scientific Accuracy Review")
    print("="*80)

    data = load_theory_data()
    sections = data.get('sections', {})

    print(f"\nFound {len(sections)} sections")
    print(f"Section IDs: {list(sections.keys())}")

    all_section_issues = {}

    # Analyze priority sections
    priority_sections = ['2', '3', '4', '5']

    for section_id in priority_sections:
        if section_id in sections:
            issues = analyze_section(section_id, sections[section_id])
            if issues:
                all_section_issues[section_id] = issues

    # Also check other sections
    for section_id, section_data in sections.items():
        if section_id not in priority_sections:
            issues = analyze_section(section_id, section_data)
            if issues:
                all_section_issues[section_id] = issues

    # Summary report
    print("\n" + "="*80)
    print("SUMMARY REPORT")
    print("="*80)

    if all_section_issues:
        print(f"\nWARNING: Found issues in {len(all_section_issues)} sections:\n")
        for section_id, issues in all_section_issues.items():
            print(f"\nSection {section_id}: {len(issues)} issue(s)")
            for issue in issues:
                print(f"  - {issue}")
    else:
        print("\nOK: No scientific accuracy issues found in section content!")

    print("\n" + "="*80)

if __name__ == '__main__':
    main()
