#!/usr/bin/env python3
"""
Audit Formula-Section Mappings

This script audits the mapping between formulas and paper sections:
1. Load all formulas from formulas.json
2. Load all sections from sections.json
3. Cross-reference formula references in sections
4. Report orphaned formulas (formulas not referenced by any section)
5. Report sections without formulas
6. Generate structured JSON report

Usage:
    python scripts/audit_formula_sections.py

Outputs:
    AutoGenerated/formula_section_audit.json - Full audit report

Copyright (c) 2025-2026 Andrew Keith Watts. All rights reserved.
"""

import json
import os
import sys
from datetime import datetime
from typing import Dict, Any, List, Set, Tuple
from collections import defaultdict

# Project paths
PROJECT_ROOT = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
FORMULAS_FILE = os.path.join(PROJECT_ROOT, "AutoGenerated", "formulas.json")
SECTIONS_FILE = os.path.join(PROJECT_ROOT, "AutoGenerated", "sections.json")
OUTPUT_FILE = os.path.join(PROJECT_ROOT, "AutoGenerated", "formula_section_audit.json")


def load_json(filepath: str) -> Dict[str, Any]:
    """Load a JSON file safely."""
    if not os.path.exists(filepath):
        print(f"[ERROR] File not found: {filepath}")
        return {}
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return json.load(f)
    except json.JSONDecodeError as e:
        print(f"[ERROR] Failed to parse {filepath}: {e}")
        return {}


def extract_formulas(formulas_data: Dict[str, Any]) -> Dict[str, Dict[str, Any]]:
    """
    Extract all formulas from formulas.json.

    Returns:
        Dict mapping formula ID to formula data
    """
    formulas = {}
    raw_formulas = formulas_data.get('formulas', {})

    # Handle both dict and list formats
    if isinstance(raw_formulas, dict):
        for formula_id, formula in raw_formulas.items():
            if isinstance(formula, dict):
                fid = formula.get('id', formula_id)
                formulas[fid] = formula
    elif isinstance(raw_formulas, list):
        for formula in raw_formulas:
            if isinstance(formula, dict):
                fid = formula.get('id', formula.get('formula_id', ''))
                if fid:
                    formulas[fid] = formula

    return formulas


def extract_sections(sections_data: Dict[str, Any]) -> Dict[str, Dict[str, Any]]:
    """
    Extract all sections from sections.json.

    Returns:
        Dict mapping section ID to section data
    """
    sections = {}
    raw_sections = sections_data.get('sections', {})

    # Handle both dict and list formats
    if isinstance(raw_sections, dict):
        for section_id, section in raw_sections.items():
            if isinstance(section, dict):
                sid = section.get('id', section_id)
                sections[sid] = section
    elif isinstance(raw_sections, list):
        for section in raw_sections:
            if isinstance(section, dict):
                sid = section.get('id', '')
                if sid:
                    sections[sid] = section

    return sections


def get_section_formula_refs(section: Dict[str, Any]) -> Set[str]:
    """
    Get all formula references from a section.

    Checks both snake_case and camelCase variants.
    """
    refs = set()

    # Direct formula references
    refs.update(section.get('formula_refs', []))
    refs.update(section.get('formulaRefs', []))

    # Check subsections if present
    for subsection in section.get('subsections', []):
        if isinstance(subsection, dict):
            refs.update(subsection.get('formula_refs', []))
            refs.update(subsection.get('formulaRefs', []))

    # Filter out empty strings
    return {r for r in refs if r}


def build_section_formula_map(sections: Dict[str, Dict[str, Any]]) -> Dict[str, List[str]]:
    """
    Build mapping of section ID -> list of formula IDs.

    Returns:
        Dict mapping section ID to list of formula IDs referenced
    """
    section_to_formulas = {}

    for section_id, section in sections.items():
        formula_refs = get_section_formula_refs(section)
        section_to_formulas[section_id] = sorted(list(formula_refs))

    return section_to_formulas


def build_formula_section_map(sections: Dict[str, Dict[str, Any]]) -> Dict[str, List[str]]:
    """
    Build reverse mapping of formula ID -> list of section IDs.

    Returns:
        Dict mapping formula ID to list of sections that reference it
    """
    formula_to_sections = defaultdict(list)

    for section_id, section in sections.items():
        formula_refs = get_section_formula_refs(section)
        for formula_id in formula_refs:
            formula_to_sections[formula_id].append(section_id)

    # Sort the section lists
    return {fid: sorted(sids) for fid, sids in formula_to_sections.items()}


def find_orphaned_formulas(
    all_formulas: Set[str],
    referenced_formulas: Set[str]
) -> List[Dict[str, Any]]:
    """
    Find formulas that are not referenced by any section.

    Returns:
        List of orphaned formula info dicts
    """
    orphaned = []
    for formula_id in sorted(all_formulas - referenced_formulas):
        orphaned.append({
            "formula_id": formula_id,
            "reason": "Not referenced by any section"
        })
    return orphaned


def find_sections_without_formulas(
    sections: Dict[str, Dict[str, Any]],
    section_formula_map: Dict[str, List[str]]
) -> List[Dict[str, Any]]:
    """
    Find sections that have no formula references.

    Returns:
        List of section info dicts for sections without formulas
    """
    sections_without = []

    for section_id, section in sections.items():
        formulas = section_formula_map.get(section_id, [])
        if not formulas:
            sections_without.append({
                "section_id": section_id,
                "title": section.get('title', 'Unknown'),
                "subsection_id": section.get('subsection_id'),
                "section_type": section.get('section_type')
            })

    return sorted(sections_without, key=lambda x: x['section_id'])


def find_invalid_formula_refs(
    sections: Dict[str, Dict[str, Any]],
    all_formulas: Set[str]
) -> List[Dict[str, Any]]:
    """
    Find section formula references that point to non-existent formulas.

    Returns:
        List of invalid reference info dicts
    """
    invalid_refs = []

    for section_id, section in sections.items():
        formula_refs = get_section_formula_refs(section)
        for formula_id in formula_refs:
            if formula_id not in all_formulas:
                invalid_refs.append({
                    "section_id": section_id,
                    "section_title": section.get('title', 'Unknown'),
                    "invalid_formula_ref": formula_id,
                    "reason": "Formula does not exist in formulas.json"
                })

    return invalid_refs


def generate_audit_report(
    formulas: Dict[str, Dict[str, Any]],
    sections: Dict[str, Dict[str, Any]],
    formulas_data: Dict[str, Any],
    sections_data: Dict[str, Any]
) -> Dict[str, Any]:
    """
    Generate comprehensive audit report.

    Returns:
        Complete audit report dict
    """
    all_formula_ids = set(formulas.keys())

    # Build mappings
    section_formula_map = build_section_formula_map(sections)
    formula_section_map = build_formula_section_map(sections)

    # Get all referenced formulas
    referenced_formulas = set(formula_section_map.keys())

    # Find issues
    orphaned_formulas = find_orphaned_formulas(all_formula_ids, referenced_formulas)
    sections_without_formulas = find_sections_without_formulas(sections, section_formula_map)
    invalid_refs = find_invalid_formula_refs(sections, all_formula_ids)

    # Calculate statistics
    total_formulas = len(all_formula_ids)
    total_sections = len(sections)
    formulas_with_sections = len(referenced_formulas)
    sections_with_formulas = sum(1 for s in section_formula_map.values() if s)

    # Determine status
    has_issues = (
        len(orphaned_formulas) > 0 or
        len(invalid_refs) > 0
    )
    status = "NEEDS_ATTENTION" if has_issues else "PASS"

    # Build detailed section_formula_map with titles
    detailed_section_map = {}
    for section_id, formula_ids in section_formula_map.items():
        section = sections.get(section_id, {})
        detailed_section_map[section_id] = {
            "title": section.get('title', 'Unknown'),
            "subsection_id": section.get('subsection_id'),
            "formula_count": len(formula_ids),
            "formulas": formula_ids
        }

    return {
        "audit_timestamp": datetime.now().isoformat(),
        "source_versions": {
            "formulas_version": formulas_data.get('version', 'unknown'),
            "sections_version": sections_data.get('version', 'unknown')
        },
        "summary": {
            "total_formulas": total_formulas,
            "total_sections": total_sections,
            "formulas_referenced_by_sections": formulas_with_sections,
            "sections_with_formula_refs": sections_with_formulas,
            "orphaned_formula_count": len(orphaned_formulas),
            "sections_without_formulas_count": len(sections_without_formulas),
            "invalid_reference_count": len(invalid_refs)
        },
        "total_formulas": total_formulas,
        "total_sections": total_sections,
        "orphaned_formulas": orphaned_formulas,
        "invalid_formula_references": invalid_refs,
        "sections_without_formulas": sections_without_formulas,
        "section_formula_map": detailed_section_map,
        "formula_section_map": formula_section_map,
        "status": status
    }


def print_report_summary(report: Dict[str, Any]) -> None:
    """Print a human-readable summary of the audit report."""
    print("=" * 70)
    print("FORMULA-SECTION MAPPING AUDIT")
    print("Principia Metaphysica")
    print("=" * 70)

    summary = report.get('summary', {})

    print(f"\nTimestamp: {report.get('audit_timestamp', 'N/A')}")
    print(f"Status: {report.get('status', 'UNKNOWN')}")

    print("\n" + "-" * 40)
    print("STATISTICS")
    print("-" * 40)
    print(f"  Total formulas:                    {summary.get('total_formulas', 0)}")
    print(f"  Total sections:                    {summary.get('total_sections', 0)}")
    print(f"  Formulas referenced by sections:   {summary.get('formulas_referenced_by_sections', 0)}")
    print(f"  Sections with formula refs:        {summary.get('sections_with_formula_refs', 0)}")

    print("\n" + "-" * 40)
    print("ISSUES")
    print("-" * 40)

    orphaned = report.get('orphaned_formulas', [])
    if orphaned:
        print(f"\n[WARN] {len(orphaned)} orphaned formulas (not in any section):")
        for item in orphaned[:15]:
            print(f"  - {item['formula_id']}")
        if len(orphaned) > 15:
            print(f"  ... and {len(orphaned) - 15} more")
    else:
        print("\n[PASS] No orphaned formulas")

    invalid_refs = report.get('invalid_formula_references', [])
    if invalid_refs:
        print(f"\n[ERROR] {len(invalid_refs)} invalid formula references:")
        for item in invalid_refs[:10]:
            print(f"  - Section '{item['section_id']}' references non-existent '{item['invalid_formula_ref']}'")
        if len(invalid_refs) > 10:
            print(f"  ... and {len(invalid_refs) - 10} more")
    else:
        print("\n[PASS] No invalid formula references")

    sections_without = report.get('sections_without_formulas', [])
    if sections_without:
        print(f"\n[INFO] {len(sections_without)} sections without formula references:")
        for item in sections_without[:10]:
            section_type = item.get('section_type') or item.get('subsection_id') or 'content'
            print(f"  - {item['section_id']}: {item['title'][:50]} ({section_type})")
        if len(sections_without) > 10:
            print(f"  ... and {len(sections_without) - 10} more")

    print("\n" + "=" * 70)

    if report.get('status') == 'PASS':
        print("[PASS] All formula-section mappings are valid")
    else:
        print("[WARN] Some issues require attention")

    print("=" * 70)


def main() -> int:
    """Main entry point."""
    print("Loading source files...")

    # Load data
    formulas_data = load_json(FORMULAS_FILE)
    sections_data = load_json(SECTIONS_FILE)

    if not formulas_data:
        print("[ERROR] Could not load formulas.json")
        return 1

    if not sections_data:
        print("[ERROR] Could not load sections.json")
        return 1

    # Extract structured data
    formulas = extract_formulas(formulas_data)
    sections = extract_sections(sections_data)

    print(f"  Loaded {len(formulas)} formulas from formulas.json")
    print(f"  Loaded {len(sections)} sections from sections.json")

    # Generate report
    print("\nGenerating audit report...")
    report = generate_audit_report(formulas, sections, formulas_data, sections_data)

    # Save JSON report
    print(f"\nSaving report to {OUTPUT_FILE}...")
    try:
        with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
            json.dump(report, f, indent=2)
        print(f"[OK] Report saved: {OUTPUT_FILE}")
    except IOError as e:
        print(f"[ERROR] Failed to save report: {e}")
        return 1

    # Print summary
    print()
    print_report_summary(report)

    # Return exit code based on status
    return 0 if report.get('status') == 'PASS' else 1


if __name__ == "__main__":
    sys.exit(main())
