#!/usr/bin/env python3
"""
Bidirectional Reference Validator

Validates that references between formulas, parameters, and sections are consistent:
1. Every formula input/output param exists in parameters.json
2. Every param with derivation_formula references a valid formula
3. Every section formula_ref and param_ref exists
4. No orphaned references

This script is READ-ONLY - it does not modify any files.

Usage:
    python scripts/validate_bidirectional_refs.py

Copyright (c) 2025-2026 Andrew Keith Watts. All rights reserved.
"""

import json
import os
import sys
from typing import Dict, Any, List, Set, Tuple

PROJECT_ROOT = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
PARAMETERS_FILE = os.path.join(PROJECT_ROOT, "AutoGenerated", "parameters.json")
FORMULAS_FILE = os.path.join(PROJECT_ROOT, "AutoGenerated", "formulas.json")
SECTIONS_FILE = os.path.join(PROJECT_ROOT, "AutoGenerated", "sections.json")


def load_json(filepath: str) -> Dict[str, Any]:
    """Load a JSON file."""
    if not os.path.exists(filepath):
        return {}
    with open(filepath, 'r', encoding='utf-8') as f:
        return json.load(f)


def extract_formula_param_refs(formulas_data: Dict[str, Any]) -> Tuple[Set[str], Dict[str, Set[str]]]:
    """
    Extract all param references from formulas.

    Returns:
        - Set of all param paths referenced by formulas
        - Dict mapping formula ID to its referenced params
    """
    all_param_refs = set()
    formula_to_params = {}

    formulas = formulas_data.get('formulas', [])
    if isinstance(formulas, dict):
        formulas = list(formulas.values())

    for formula in formulas:
        if not isinstance(formula, dict):
            continue

        formula_id = formula.get('id', formula.get('formula_id', ''))
        if not formula_id:
            continue

        params = set()

        # Check inputParams and outputParams
        for field in ['inputParams', 'input_params', 'outputParams', 'output_params']:
            refs = formula.get(field, [])
            if isinstance(refs, list):
                params.update(refs)

        formula_to_params[formula_id] = params
        all_param_refs.update(params)

    return all_param_refs, formula_to_params


def extract_param_formula_refs(params_data: Dict[str, Any]) -> Dict[str, str]:
    """
    Extract formula references from parameters.

    Returns:
        Dict mapping param path to its derivation_formula (if any)
    """
    param_to_formula = {}

    params = params_data.get('parameters', {})
    for path, param in params.items():
        if not isinstance(param, dict):
            continue

        derivation = param.get('derivation_formula') or param.get('derivationFormula')
        if derivation:
            param_to_formula[path] = derivation

    return param_to_formula


def extract_section_refs(sections_data: Dict[str, Any]) -> Tuple[Set[str], Set[str]]:
    """
    Extract formula and param references from sections.

    Returns:
        - Set of formula IDs referenced by sections
        - Set of param paths referenced by sections
    """
    formula_refs = set()
    param_refs = set()

    sections = sections_data.get('sections', [])
    if isinstance(sections, dict):
        sections = list(sections.values())

    for section in sections:
        if not isinstance(section, dict):
            continue

        # Direct refs
        formula_refs.update(section.get('formula_refs', []))
        formula_refs.update(section.get('formulaRefs', []))
        param_refs.update(section.get('param_refs', []))
        param_refs.update(section.get('paramRefs', []))

        # Subsection refs
        for subsection in section.get('subsections', []):
            if isinstance(subsection, dict):
                formula_refs.update(subsection.get('formula_refs', []))
                formula_refs.update(subsection.get('formulaRefs', []))
                param_refs.update(subsection.get('param_refs', []))
                param_refs.update(subsection.get('paramRefs', []))

    return formula_refs, param_refs


def validate_formula_param_refs(
    formula_params: Set[str],
    all_params: Set[str]
) -> List[Tuple[str, str]]:
    """Validate that all formula param refs exist."""
    missing = []
    for param in formula_params:
        if param not in all_params:
            missing.append(('formula->param', param))
    return missing


def validate_param_formula_refs(
    param_formulas: Dict[str, str],
    all_formulas: Set[str]
) -> List[Tuple[str, str, str]]:
    """Validate that all param formula refs exist."""
    missing = []
    for param, formula in param_formulas.items():
        if formula not in all_formulas:
            missing.append(('param->formula', param, formula))
    return missing


def validate_section_refs(
    section_formulas: Set[str],
    section_params: Set[str],
    all_formulas: Set[str],
    all_params: Set[str]
) -> List[Tuple[str, str]]:
    """Validate that all section refs exist."""
    missing = []
    for formula in section_formulas:
        if formula not in all_formulas:
            missing.append(('section->formula', formula))
    for param in section_params:
        if param not in all_params:
            missing.append(('section->param', param))
    return missing


def find_orphaned_params(
    all_params: Set[str],
    formula_params: Set[str],
    section_params: Set[str]
) -> Set[str]:
    """Find params that are never referenced by any formula or section."""
    referenced = formula_params | section_params

    # Exclude internal/system params
    internal_prefixes = [
        'framework_statistics.', 'validation.', 'system.',
        '_', 'registry.', 'gates.', 'seal.', 'terminal.'
    ]

    orphaned = set()
    for param in all_params:
        if param in referenced:
            continue
        if any(param.startswith(prefix) for prefix in internal_prefixes):
            continue
        orphaned.add(param)

    return orphaned


def main():
    """Main entry point."""
    print("=" * 70)
    print("Bidirectional Reference Validator")
    print("=" * 70)

    # Load data
    params_data = load_json(PARAMETERS_FILE)
    formulas_data = load_json(FORMULAS_FILE)
    sections_data = load_json(SECTIONS_FILE)

    all_params = set(params_data.get('parameters', {}).keys())
    all_formulas = set()

    formulas = formulas_data.get('formulas', [])
    if isinstance(formulas, dict):
        formulas = list(formulas.values())
    for f in formulas:
        if isinstance(f, dict):
            fid = f.get('id', f.get('formula_id', ''))
            if fid:
                all_formulas.add(fid)

    print(f"\nLoaded {len(all_params)} parameters")
    print(f"Loaded {len(all_formulas)} formulas")

    # Extract references
    formula_params, formula_to_params = extract_formula_param_refs(formulas_data)
    param_formulas = extract_param_formula_refs(params_data)
    section_formulas, section_params = extract_section_refs(sections_data)

    print(f"\nFormulas reference {len(formula_params)} unique params")
    print(f"Params reference {len(param_formulas)} formulas")
    print(f"Sections reference {len(section_formulas)} formulas, {len(section_params)} params")

    # Validate
    errors = []

    print("\n" + "-" * 70)
    print("VALIDATION RESULTS")
    print("-" * 70)

    # Formula -> Param validation
    missing_formula_params = validate_formula_param_refs(formula_params, all_params)
    if missing_formula_params:
        print(f"\n[WARN] {len(missing_formula_params)} formula->param references to non-existent params:")
        for ref_type, param in missing_formula_params[:10]:
            print(f"  - {param}")
        if len(missing_formula_params) > 10:
            print(f"  ... and {len(missing_formula_params) - 10} more")
        errors.extend(missing_formula_params)
    else:
        print("\n[PASS] All formula->param references are valid")

    # Param -> Formula validation
    missing_param_formulas = validate_param_formula_refs(param_formulas, all_formulas)
    if missing_param_formulas:
        print(f"\n[WARN] {len(missing_param_formulas)} param->formula references to non-existent formulas:")
        for ref_type, param, formula in missing_param_formulas[:10]:
            print(f"  - {param} -> {formula}")
        if len(missing_param_formulas) > 10:
            print(f"  ... and {len(missing_param_formulas) - 10} more")
        errors.extend(missing_param_formulas)
    else:
        print("\n[PASS] All param->formula references are valid")

    # Section refs validation
    missing_section_refs = validate_section_refs(
        section_formulas, section_params, all_formulas, all_params
    )
    if missing_section_refs:
        print(f"\n[WARN] {len(missing_section_refs)} section references to non-existent items:")
        for item in missing_section_refs[:10]:
            print(f"  - {item[0]}: {item[1]}")
        if len(missing_section_refs) > 10:
            print(f"  ... and {len(missing_section_refs) - 10} more")
        errors.extend(missing_section_refs)
    else:
        print("\n[PASS] All section references are valid")

    # Orphaned params
    orphaned = find_orphaned_params(all_params, formula_params, section_params)
    if orphaned:
        print(f"\n[INFO] {len(orphaned)} params not referenced by any formula or section:")
        for param in sorted(orphaned)[:15]:
            print(f"  - {param}")
        if len(orphaned) > 15:
            print(f"  ... and {len(orphaned) - 15} more")
    else:
        print("\n[PASS] All params are referenced")

    # Summary
    print("\n" + "=" * 70)
    print("SUMMARY")
    print("=" * 70)

    if errors:
        print(f"[WARN] Found {len(errors)} reference issues")
        return 1
    else:
        print("[PASS] All bidirectional references are valid")
        return 0


if __name__ == "__main__":
    sys.exit(main())
