<!DOCTYPE html>
<!--
    Copyright (c) 2025 Andrew Keith Watts. All rights reserved.

    This is the intellectual property of Andrew Keith Watts. Unauthorized
    reproduction, distribution, or modification of this code, in whole or in part,
    without the express written permission of Andrew Keith Watts is strictly prohibited.

    For inquiries, please contact AndrewKWatts@Gmail.com
-->

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Complete Formula Registry - All equations dynamically loaded from theory_output.json">
  <title>Formula Registry - Principia Metaphysica</title>
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/auth.css">
  <script src="../js/pm-constants-loader.js"></script>
  <script src="../js/pm-formula-loader.js"></script>
  <style>
    /* Formula Table Styles */
    .controls-panel {
      background: var(--bg-card);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      border: 1px solid var(--border-primary);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .control-group label {
      color: var(--accent-primary);
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .control-group input,
    .control-group select {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      color: var(--text-primary);
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .control-group input:focus,
    .control-group select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(139, 127, 255, 0.1);
    }

    .stats-bar {
      display: flex;
      gap: 2rem;
      padding: 1rem;
      background: rgba(139, 127, 255, 0.05);
      border-radius: 8px;
      flex-wrap: wrap;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      color: var(--accent-primary);
      font-size: 1.5rem;
      font-weight: 700;
    }

    .formula-table-container {
      background: var(--bg-card);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-primary);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .formula-table {
      width: 100%;
      border-collapse: collapse;
    }

    .formula-table thead {
      background: var(--bg-secondary);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .formula-table th {
      padding: 1rem;
      text-align: left;
      color: var(--accent-primary);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border-accent);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .formula-table th:hover {
      background: rgba(139, 127, 255, 0.1);
    }

    .formula-table th.sortable::after {
      content: ' ↕';
      opacity: 0.3;
      font-size: 0.8rem;
    }

    .formula-table th.sorted-asc::after {
      content: ' ↑';
      opacity: 1;
      color: var(--accent-primary);
    }

    .formula-table th.sorted-desc::after {
      content: ' ↓';
      opacity: 1;
      color: var(--accent-primary);
    }

    .formula-table tbody tr {
      border-bottom: 1px solid var(--border-primary);
      transition: all 0.2s ease;
    }

    .formula-table tbody tr:hover {
      background: rgba(139, 127, 255, 0.05);
    }

    .formula-table tbody tr.expanded {
      background: rgba(139, 127, 255, 0.1);
    }

    .formula-table td {
      padding: 1rem;
      color: var(--text-secondary);
      vertical-align: top;
    }

    .formula-row-main {
      cursor: pointer;
    }

    .formula-row-details {
      display: none;
    }

    .formula-row-details.visible {
      display: table-row;
    }

    .formula-row-details td {
      padding: 0;
      background: var(--bg-secondary);
    }

    .details-content {
      padding: 1.5rem;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .details-section {
      background: var(--bg-card);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-primary);
    }

    .details-section h4 {
      color: var(--accent-primary);
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-primary);
    }

    .details-section ul {
      list-style: none;
      padding: 0;
    }

    .details-section li {
      padding: 0.5rem 0;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .details-section li strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .formula-html {
      font-family: 'Crimson Text', serif;
      font-size: 1.1rem;
      color: var(--text-primary);
      white-space: nowrap;
      overflow-x: auto;
    }

    .category-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .category-badge.ESTABLISHED {
      background: rgba(81, 207, 102, 0.2);
      color: #51cf66;
      border: 1px solid rgba(81, 207, 102, 0.3);
    }

    .category-badge.THEORY {
      background: rgba(139, 127, 255, 0.2);
      color: #8b7fff;
      border: 1px solid rgba(139, 127, 255, 0.3);
    }

    .category-badge.DERIVED {
      background: rgba(77, 171, 247, 0.2);
      color: #4dabf7;
      border: 1px solid rgba(77, 171, 247, 0.3);
    }

    .category-badge.PREDICTIONS {
      background: rgba(255, 126, 182, 0.2);
      color: #ff7eb6;
      border: 1px solid rgba(255, 126, 182, 0.3);
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-badge.validated {
      background: rgba(81, 207, 102, 0.2);
      color: #51cf66;
    }

    .status-badge.exact-match {
      background: rgba(255, 212, 59, 0.2);
      color: #ffd43b;
    }

    .status-badge.pending {
      background: rgba(108, 117, 125, 0.2);
      color: #adb5bd;
    }

    .expand-icon {
      display: inline-block;
      width: 20px;
      text-align: center;
      margin-right: 0.5rem;
      transition: transform 0.3s ease;
      color: var(--accent-primary);
    }

    .formula-row-main.expanded .expand-icon {
      transform: rotate(90deg);
    }

    .no-results {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
      font-size: 1.1rem;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--accent-primary);
      font-size: 1.1rem;
    }

    .error {
      text-align: center;
      padding: 3rem;
      color: var(--warning);
      font-size: 1.1rem;
    }

    .derivation-step {
      background: rgba(139, 127, 255, 0.05);
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      border-left: 3px solid var(--accent-primary);
    }

    .term-definition {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .term-symbol {
      font-family: 'Crimson Text', serif;
      font-weight: 600;
      color: var(--accent-primary);
      min-width: 60px;
    }

    .term-desc {
      color: var(--text-secondary);
    }

    .related-formula-link {
      color: var(--accent-primary);
      text-decoration: none;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      transition: all 0.2s ease;
      display: inline-block;
      margin: 0.25rem;
      background: rgba(139, 127, 255, 0.1);
    }

    .related-formula-link:hover {
      background: rgba(139, 127, 255, 0.2);
      transform: translateX(3px);
    }

    .sigma-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .sigma-badge.good {
      background: rgba(81, 207, 102, 0.2);
      color: #51cf66;
    }

    .sigma-badge.moderate {
      background: rgba(255, 212, 59, 0.2);
      color: #ffd43b;
    }

    .sigma-badge.high {
      background: rgba(250, 112, 154, 0.2);
      color: #fa709a;
    }

    @media (max-width: 768px) {
      .formula-table {
        font-size: 0.85rem;
      }

      .formula-table th,
      .formula-table td {
        padding: 0.75rem 0.5rem;
      }

      .controls-grid {
        grid-template-columns: 1fr;
      }

      .stats-bar {
        gap: 1rem;
      }
    }
  </style>
</head>
<body class="auth-loading">
  <div id="main-content" style="display: none;">
  <header>
    <div class="header-content">
      <h1>Principia Metaphysica</h1>
      <nav>
        <ul>
          <li><a href="../paper.html">Home</a></li>
          <li><a href="formulas.html" class="active">Formulas</a></li>
          <li><a href="predictions.html">Predictions</a></li>
          <li><a href="index.html">All Sections</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main style="max-width: 1600px; margin: 0 auto; padding: 2rem;">
    <section>
      <h2 style="font-size: 2.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
        Formula Registry
      </h2>
      <p style="color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 2rem;">
        Complete catalog of all formulas in Principia Metaphysica, dynamically loaded from theory_output.json.
        Click any row to expand and see derivation, terms, related formulas, and more.
      </p>

      <!-- Controls Panel -->
      <div class="controls-panel">
        <div class="controls-grid">
          <div class="control-group">
            <label for="search">Search (ID, Label, Description)</label>
            <input type="text" id="search" placeholder="Type to search...">
          </div>
          <div class="control-group">
            <label for="category-filter">Category</label>
            <select id="category-filter">
              <option value="">All Categories</option>
              <option value="ESTABLISHED">ESTABLISHED</option>
              <option value="THEORY">THEORY</option>
              <option value="DERIVED">DERIVED</option>
              <option value="PREDICTIONS">PREDICTIONS</option>
            </select>
          </div>
          <div class="control-group">
            <label for="section-filter">Section</label>
            <select id="section-filter">
              <option value="">All Sections</option>
            </select>
          </div>
          <div class="control-group">
            <label for="status-filter">Status</label>
            <select id="status-filter">
              <option value="">All Statuses</option>
              <option value="exact-match">Exact Match</option>
              <option value="validated">Validated</option>
              <option value="pending">Pending</option>
            </select>
          </div>
        </div>

        <!-- Statistics Bar -->
        <div class="stats-bar">
          <div class="stat-item">
            <div class="stat-label">Total Formulas</div>
            <div class="stat-value" id="stat-total">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Visible</div>
            <div class="stat-value" id="stat-visible">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">With Validation</div>
            <div class="stat-value" id="stat-validated">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">With Derivation</div>
            <div class="stat-value" id="stat-derived">-</div>
          </div>
        </div>
      </div>

      <!-- Formula Table -->
      <div class="formula-table-container">
        <table class="formula-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="id">ID</th>
              <th class="sortable" data-sort="label">Label</th>
              <th>Formula</th>
              <th class="sortable" data-sort="category">Category</th>
              <th class="sortable" data-sort="section">Section</th>
              <th class="sortable" data-sort="status">Status</th>
              <th class="sortable" data-sort="computed">Computed</th>
              <th class="sortable" data-sort="experimental">Experimental</th>
              <th class="sortable" data-sort="sigma">Sigma (σ)</th>
            </tr>
          </thead>
          <tbody id="formula-table-body">
            <tr>
              <td colspan="9" class="loading">Loading formulas...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <p>Principia Metaphysica © 2025 | Formula Registry</p>
      <p style="font-size: 0.85rem; color: var(--text-muted);">
        All formulas loaded from theory_output.json
      </p>
    </div>
  </footer>
  </div>

  <script type="module">
    import { setupAuthGuard } from '../js/auth-guard.js';
    setupAuthGuard('formulas');
  </script>

  <script>
    (async function() {
      'use strict';

      let allFormulas = [];
      let filteredFormulas = [];
      let currentSort = { column: null, direction: 'asc' };

      // Wait for PM to load
      await window.PM.load();

      // Get formulas from PM
      const formulasObj = window.PM.formulas;

      if (!formulasObj || Object.keys(formulasObj).length === 0) {
        document.getElementById('formula-table-body').innerHTML =
          '<tr><td colspan="9" class="error">No formulas found. Please run: python run_all_simulations.py --export</td></tr>';
        return;
      }

      // Convert to array and add to global list
      allFormulas = Object.values(formulasObj).map(f => ({
        ...f,
        searchText: `${f.id || ''} ${f.label || ''} ${f.description || ''}`.toLowerCase()
      }));

      filteredFormulas = [...allFormulas];

      // Build section dropdown
      const sections = [...new Set(allFormulas.map(f => f.section).filter(Boolean))].sort();
      const sectionFilter = document.getElementById('section-filter');
      sections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = `Section ${section}`;
        sectionFilter.appendChild(option);
      });

      // Event listeners for filters
      document.getElementById('search').addEventListener('input', applyFilters);
      document.getElementById('category-filter').addEventListener('change', applyFilters);
      document.getElementById('section-filter').addEventListener('change', applyFilters);
      document.getElementById('status-filter').addEventListener('change', applyFilters);

      // Event listeners for sorting
      document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const column = th.getAttribute('data-sort');
          toggleSort(column);
        });
      });

      // Initial render
      applyFilters();

      function applyFilters() {
        const searchTerm = document.getElementById('search').value.toLowerCase();
        const categoryFilter = document.getElementById('category-filter').value;
        const sectionFilter = document.getElementById('section-filter').value;
        const statusFilter = document.getElementById('status-filter').value;

        filteredFormulas = allFormulas.filter(formula => {
          // Search filter
          if (searchTerm && !formula.searchText.includes(searchTerm)) {
            return false;
          }

          // Category filter
          if (categoryFilter && formula.category !== categoryFilter) {
            return false;
          }

          // Section filter
          if (sectionFilter && (!formula.section || !formula.section.startsWith(sectionFilter))) {
            return false;
          }

          // Status filter
          if (statusFilter) {
            const status = getFormulaStatus(formula);
            if (status !== statusFilter) {
              return false;
            }
          }

          return true;
        });

        updateStats();
        renderTable();
      }

      function toggleSort(column) {
        if (currentSort.column === column) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.column = column;
          currentSort.direction = 'asc';
        }

        // Update header classes
        document.querySelectorAll('.sortable').forEach(th => {
          th.classList.remove('sorted-asc', 'sorted-desc');
          if (th.getAttribute('data-sort') === column) {
            th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
          }
        });

        sortFormulas();
        renderTable();
      }

      function sortFormulas() {
        if (!currentSort.column) return;

        filteredFormulas.sort((a, b) => {
          let aVal, bVal;

          switch (currentSort.column) {
            case 'id':
              aVal = a.id || '';
              bVal = b.id || '';
              break;
            case 'label':
              aVal = a.label || '';
              bVal = b.label || '';
              break;
            case 'category':
              aVal = a.category || '';
              bVal = b.category || '';
              break;
            case 'section':
              aVal = parseFloat(a.section) || 0;
              bVal = parseFloat(b.section) || 0;
              break;
            case 'status':
              aVal = getFormulaStatus(a);
              bVal = getFormulaStatus(b);
              break;
            case 'computed':
              aVal = a.computedValue ?? -Infinity;
              bVal = b.computedValue ?? -Infinity;
              break;
            case 'experimental':
              aVal = a.experimentalValue ?? -Infinity;
              bVal = b.experimentalValue ?? -Infinity;
              break;
            case 'sigma':
              aVal = Math.abs(a.sigmaDeviation ?? Infinity);
              bVal = Math.abs(b.sigmaDeviation ?? Infinity);
              break;
            default:
              return 0;
          }

          let comparison = 0;
          if (typeof aVal === 'number' && typeof bVal === 'number') {
            comparison = aVal - bVal;
          } else {
            comparison = String(aVal).localeCompare(String(bVal));
          }

          return currentSort.direction === 'asc' ? comparison : -comparison;
        });
      }

      function getFormulaStatus(formula) {
        if (formula.status === 'exact-match') return 'exact-match';
        if (formula.status === 'validated' || formula.experimentalValue !== undefined) return 'validated';
        return 'pending';
      }

      function updateStats() {
        document.getElementById('stat-total').textContent = allFormulas.length;
        document.getElementById('stat-visible').textContent = filteredFormulas.length;
        document.getElementById('stat-validated').textContent =
          filteredFormulas.filter(f => f.experimentalValue !== undefined).length;
        document.getElementById('stat-derived').textContent =
          filteredFormulas.filter(f => f.derivation && f.derivation.steps && f.derivation.steps.length > 0).length;
      }

      function renderTable() {
        const tbody = document.getElementById('formula-table-body');

        if (filteredFormulas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="no-results">No formulas match your filters.</td></tr>';
          return;
        }

        const html = filteredFormulas.map((formula, index) => {
          const status = getFormulaStatus(formula);
          const sigmaClass = getSigmaClass(formula.sigmaDeviation);

          return `
            <tr class="formula-row-main" data-index="${index}">
              <td>
                <span class="expand-icon">▶</span>
                <code style="color: var(--accent-primary);">${escapeHtml(formula.id || '-')}</code>
              </td>
              <td style="white-space: nowrap;">${escapeHtml(formula.label || '-')}</td>
              <td>
                <div class="formula-html">${formula.html || formula.latex || escapeHtml(formula.plainText || '-')}</div>
              </td>
              <td>
                <span class="category-badge ${formula.category || 'UNKNOWN'}">${formula.category || 'UNKNOWN'}</span>
              </td>
              <td>${formula.section || '-'}</td>
              <td>
                <span class="status-badge ${status}">${status.replace('-', ' ').toUpperCase()}</span>
              </td>
              <td>${formatValue(formula.computedValue)}</td>
              <td>${formatValue(formula.experimentalValue)}</td>
              <td>
                ${formula.sigmaDeviation !== undefined ?
                  `<span class="sigma-badge ${sigmaClass}">${formula.sigmaDeviation.toFixed(2)}σ</span>` :
                  '-'}
              </td>
            </tr>
            <tr class="formula-row-details" data-index="${index}">
              <td colspan="9">
                <div class="details-content">
                  ${renderDetails(formula)}
                </div>
              </td>
            </tr>
          `;
        }).join('');

        tbody.innerHTML = html;

        // Add click handlers for expand/collapse
        tbody.querySelectorAll('.formula-row-main').forEach(row => {
          row.addEventListener('click', () => {
            const index = row.getAttribute('data-index');
            const detailsRow = tbody.querySelector(`.formula-row-details[data-index="${index}"]`);

            row.classList.toggle('expanded');
            detailsRow.classList.toggle('visible');
          });
        });
      }

      function renderDetails(formula) {
        const sections = [];

        // Description
        if (formula.description) {
          sections.push(`
            <div class="details-section">
              <h4>Description</h4>
              <p style="color: var(--text-secondary); line-height: 1.6;">${escapeHtml(formula.description)}</p>
            </div>
          `);
        }

        // Terms
        if (formula.terms && Object.keys(formula.terms).length > 0) {
          const termsList = Object.entries(formula.terms).map(([symbol, desc]) =>
            `<div class="term-definition">
              <span class="term-symbol">${symbol}</span>
              <span class="term-desc">${escapeHtml(desc)}</span>
            </div>`
          ).join('');

          sections.push(`
            <div class="details-section">
              <h4>Terms</h4>
              ${termsList}
            </div>
          `);
        }

        // Derivation
        if (formula.derivation && formula.derivation.steps && formula.derivation.steps.length > 0) {
          const stepsList = formula.derivation.steps.map((step, i) =>
            `<div class="derivation-step">
              <strong style="color: var(--accent-primary);">Step ${i + 1}:</strong> ${escapeHtml(step)}
            </div>`
          ).join('');

          sections.push(`
            <div class="details-section">
              <h4>Derivation (${formula.derivation.method || 'unknown'})</h4>
              ${stepsList}
              ${formula.derivation.difficulty ? `<p style="margin-top: 0.75rem; color: var(--text-muted); font-size: 0.85rem;">Difficulty: ${formula.derivation.difficulty}</p>` : ''}
            </div>
          `);
        }

        // Related Formulas
        if (formula.relatedFormulas && formula.relatedFormulas.length > 0) {
          const relatedLinks = formula.relatedFormulas.map(relId =>
            `<a href="#" class="related-formula-link" onclick="filterByFormula('${relId}'); return false;">${relId}</a>`
          ).join('');

          sections.push(`
            <div class="details-section">
              <h4>Related Formulas</h4>
              <div>${relatedLinks}</div>
            </div>
          `);
        }

        // Validation Data
        if (formula.experimentalValue !== undefined || formula.computedValue !== undefined) {
          sections.push(`
            <div class="details-section">
              <h4>Validation</h4>
              <ul>
                ${formula.computedValue !== undefined ? `<li><strong>Computed:</strong> ${formatValueLong(formula.computedValue)}${formula.units ? ' ' + formula.units : ''}</li>` : ''}
                ${formula.experimentalValue !== undefined ? `<li><strong>Experimental:</strong> ${formatValueLong(formula.experimentalValue)}${formula.units ? ' ' + formula.units : ''}</li>` : ''}
                ${formula.sigmaDeviation !== undefined ? `<li><strong>Deviation:</strong> ${formula.sigmaDeviation.toFixed(3)}σ</li>` : ''}
                ${formula.simulationFile ? `<li><strong>Simulation:</strong> <code>${formula.simulationFile}</code></li>` : ''}
              </ul>
            </div>
          `);
        }

        // Additional Info
        const additionalInfo = [];
        if (formula.attribution && formula.attribution !== 'Principia Metaphysica') {
          additionalInfo.push(`<li><strong>Attribution:</strong> ${escapeHtml(formula.attribution)}</li>`);
        }
        if (formula.testability) {
          additionalInfo.push(`<li><strong>Testability:</strong> ${escapeHtml(formula.testability)}</li>`);
        }
        if (formula.notes) {
          additionalInfo.push(`<li><strong>Notes:</strong> ${escapeHtml(formula.notes)}</li>`);
        }

        if (additionalInfo.length > 0) {
          sections.push(`
            <div class="details-section">
              <h4>Additional Information</h4>
              <ul>${additionalInfo.join('')}</ul>
            </div>
          `);
        }

        return `<div class="details-grid">${sections.join('')}</div>`;
      }

      function formatValue(value) {
        if (value === undefined || value === null) return '-';
        if (typeof value === 'number') {
          if (Math.abs(value) >= 1e10 || (Math.abs(value) < 0.001 && value !== 0)) {
            return value.toExponential(2);
          }
          return value.toFixed(3);
        }
        return String(value);
      }

      function formatValueLong(value) {
        if (value === undefined || value === null) return '-';
        if (typeof value === 'number') {
          if (Math.abs(value) >= 1e10 || (Math.abs(value) < 0.001 && value !== 0)) {
            return value.toExponential(4);
          }
          return value.toPrecision(6);
        }
        return String(value);
      }

      function getSigmaClass(sigma) {
        if (sigma === undefined || sigma === null) return '';
        const absSigma = Math.abs(sigma);
        if (absSigma < 2) return 'good';
        if (absSigma < 5) return 'moderate';
        return 'high';
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Global function for related formula links
      window.filterByFormula = function(formulaId) {
        document.getElementById('search').value = formulaId;
        applyFilters();
        // Scroll to top of table
        document.querySelector('.formula-table-container').scrollIntoView({ behavior: 'smooth' });
      };

    })();
  </script>
</body>
</html>
