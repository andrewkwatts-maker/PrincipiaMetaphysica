#!/usr/bin/env python3
"""
Split theory_output.json into Cacheable Components
===================================================

Splits the monolithic theory_output.json into smaller, independently
cacheable component files for improved loading performance.

Output files:
- AutoGenerated/formulas.json - All formula definitions
- AutoGenerated/parameters.json - All parameter definitions
- AutoGenerated/foundations.json - Foundations/concepts data
- AutoGenerated/statistics.json - Framework statistics
- AutoGenerated/simulations.json - Simulation results
- AutoGenerated/metadata.json - Version, validation, config
- AutoGenerated/sections/ - Individual section files (existing)

Copyright (c) 2025-2026 Andrew Keith Watts. All rights reserved.

Dedicated To:
    My Wife: Elizabeth May Watts
    Our Messiah: Jesus Of Nazareth
"""

import json
import sys
import io
from pathlib import Path
from typing import Dict, Any

# Fix Windows console encoding
sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')


def load_json(path: Path) -> Dict[str, Any]:
    """Load JSON file with UTF-8 encoding."""
    with open(path, 'r', encoding='utf-8') as f:
        return json.load(f)


def save_json(path: Path, data: Any, indent: int = 2) -> None:
    """Save JSON file with UTF-8 encoding."""
    with open(path, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=indent, ensure_ascii=False)
    print(f"  Created: {path.name} ({len(json.dumps(data)):,} chars)")


def split_theory_output(theory_path: Path, output_dir: Path) -> bool:
    """Split theory_output.json into component files."""

    # v16.2 DOI for sterile model
    DOI = "10.5281/zenodo.18079602"
    DEFAULT_VERSION = "16.2"

    print(f"Loading {theory_path}...")
    data = load_json(theory_path)

    version = data.get('version', DEFAULT_VERSION)
    print(f"\nSplitting into components in {output_dir}/ (v{version}, DOI: {DOI})")

    # 1. Formulas - largest component
    if 'formulas' in data:
        formulas_data = {
            'version': version,
            'doi': DOI,
            'count': len(data['formulas']),
            'formulas': data['formulas']
        }
        save_json(output_dir / 'formulas.json', formulas_data)

    # 2. Parameters
    if 'parameters' in data:
        params_data = {
            'version': version,
            'doi': DOI,
            'parameters': data['parameters']
        }
        save_json(output_dir / 'parameters.json', params_data)

    # 3. Foundations
    if 'foundations' in data:
        foundations_data = {
            'version': version,
            'doi': DOI,
            'foundations': data['foundations']
        }
        save_json(output_dir / 'foundations.json', foundations_data)

    # 4. Statistics (combine statistics and framework_statistics)
    stats_data = {
        'version': version,
        'doi': DOI,
        'statistics': data.get('statistics', {}),
        'framework_statistics': data.get('framework_statistics', {})
    }
    save_json(output_dir / 'statistics.json', stats_data)

    # 5. Simulations
    if 'simulations' in data:
        sims_data = {
            'version': version,
            'doi': DOI,
            'simulations': data['simulations']
        }
        save_json(output_dir / 'simulations.json', sims_data)

    # 6. Metadata (version, validation, config)
    metadata = {
        'version': version,
        'doi': DOI,
        'model_type': 'STERILE',
        'config_source': data.get('config_source', 'config.py'),
        'all_passed': data.get('all_passed', True),
        'validation_summary': data.get('validation_summary', {}),
        'generated_at': data.get('generated_at', None)
    }
    save_json(output_dir / 'metadata.json', metadata)

    # 7. Sections (for sections.html and paper.html)
    if 'sections' in data:
        sections_data = {
            'version': version,
            'doi': DOI,
            'count': len(data['sections']),
            'sections': data['sections']
        }
        save_json(output_dir / 'sections.json', sections_data)

    # 8. Create index file listing all components
    index = {
        'version': version,
        'doi': DOI,
        'components': [
            {'name': 'formulas', 'file': 'formulas.json', 'description': 'Formula definitions'},
            {'name': 'parameters', 'file': 'parameters.json', 'description': 'Parameter values'},
            {'name': 'foundations', 'file': 'foundations.json', 'description': 'Foundational concepts'},
            {'name': 'statistics', 'file': 'statistics.json', 'description': 'Framework statistics'},
            {'name': 'simulations', 'file': 'simulations.json', 'description': 'Simulation results'},
            {'name': 'metadata', 'file': 'metadata.json', 'description': 'Version and validation'},
            {'name': 'sections', 'file': 'sections.json', 'description': 'All sections bundled'},
            {'name': 'sections_individual', 'file': 'sections/', 'description': 'Individual section files (lazy load)'}
        ],
        'sections_dir': 'sections/',
        'cache_strategy': {
            'formulas': {'ttl': 3600, 'storage': 'localStorage'},
            'parameters': {'ttl': 3600, 'storage': 'localStorage'},
            'foundations': {'ttl': 3600, 'storage': 'localStorage'},
            'statistics': {'ttl': 300, 'storage': 'sessionStorage'},
            'simulations': {'ttl': 300, 'storage': 'sessionStorage'},
            'metadata': {'ttl': 60, 'storage': 'sessionStorage'},
            'sections': {'ttl': 1800, 'storage': 'localStorage'}
        }
    }
    save_json(output_dir / 'index.json', index)

    print(f"\n[SUCCESS] Split theory_output.json into {len(index['components'])} components")

    return True


def main():
    """Main entry point."""
    base_dir = Path(__file__).parent.parent.parent
    theory_path = base_dir / 'AutoGenerated' / 'theory_output.json'
    output_dir = base_dir / 'AutoGenerated'

    if not theory_path.exists():
        print(f"ERROR: {theory_path} not found")
        return 1

    success = split_theory_output(theory_path, output_dir)
    return 0 if success else 1


if __name__ == '__main__':
    sys.exit(main())
