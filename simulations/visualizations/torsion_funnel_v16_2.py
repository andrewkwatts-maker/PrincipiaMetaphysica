#!/usr/bin/env python3
"""
Torsion Funnel Visualization - v16.2 Sterile Model
===================================================

Sankey-style flow diagram showing the 288-24-125 geometric projection:
- Entry: 288 Ancestral Roots (SO(24) + Shadow Torsion - Cost)
- Bottleneck: 24 Torsion Pins (4x6 matrix)
- Exit: 125 Active Residues + 163 Hidden Supports

This visualization demonstrates that the 125 particles are the only
"geometric survivors" of the dimensional projection from 26D to 4D.

Output: AutoGenerated/plots/torsion_funnel_v16_2.png

Copyright (c) 2025-2026 Andrew Keith Watts. All rights reserved.

Dedicated To:
    My Wife: Elizabeth May Watts
    Our Messiah: Jesus Of Nazareth
"""

import numpy as np
from pathlib import Path
from typing import Dict, List, Any

# Import SSoT constants from FormulasRegistry
from core.FormulasRegistry import get_registry
_REG = get_registry()

try:
    import matplotlib.pyplot as plt
    import matplotlib.patches as mpatches
    from matplotlib.patches import FancyBboxPatch, FancyArrowPatch, Polygon
    from matplotlib.collections import PatchCollection
    import matplotlib.patheffects as path_effects
    HAS_MATPLOTLIB = True
except ImportError:
    HAS_MATPLOTLIB = False
    print("Warning: matplotlib not available.")

# PM Color palette (sterile model)
PM_COLORS = {
    "purple": "#8b7fff",
    "pink": "#ff7eb6",
    "blue": "#60a5fa",
    "orange": "#fb923c",
    "gold": "#ffd43b",
    "green": "#4ade80",
    "red": "#ef4444",
    "teal": "#2dd4bf",
    "text": "#f8f9fa",
    "bg_dark": "#1a1f3a",
    "bg_card": "#2a2f4a",
    "active": "#4ade80",
    "hidden": "#94a3b8",
}

# Output directory
OUTPUT_DIR = Path(__file__).parent.parent.parent / "AutoGenerated" / "plots"


class TorsionFunnelVisualization:
    """
    Generates the Torsion Funnel Sankey diagram.

    The funnel shows how 288 ancestral roots flow through
    24 torsion pins to produce 125 observable residues.
    """

    # Sterile model constants (from SSoT)
    SO24_GENERATORS = 276
    SHADOW_TORSION = _REG.elder_kads  # 24
    MANIFOLD_COST = 12
    ANCESTRAL_ROOTS = _REG.nitzotzin_roots  # 288 (276 + 24 - 12)
    TORSION_PINS = _REG.elder_kads  # 24
    ACTIVE_RESIDUES = _REG.sophian_registry  # 125
    HIDDEN_SUPPORTS = _REG.barbelo_modulus  # 163
    DIMENSIONS = 4
    PINS_PER_DIM = 6

    @staticmethod
    def setup_style():
        """Configure matplotlib for publication-quality output."""
        if not HAS_MATPLOTLIB:
            return
        plt.rcParams.update({
            'font.family': 'serif',
            'font.size': 11,
            'axes.titlesize': 14,
            'axes.labelsize': 12,
            'figure.dpi': 150,
            'savefig.dpi': 300,
            'savefig.bbox': 'tight',
        })

    @staticmethod
    def generate_funnel():
        """
        Generate the Torsion Funnel visualization.

        Returns:
            Path to the saved image, or None if matplotlib unavailable.
        """
        if not HAS_MATPLOTLIB:
            print("Cannot generate visualization: matplotlib not available")
            return None

        TorsionFunnelVisualization.setup_style()

        fig, ax = plt.subplots(figsize=(14, 10))
        ax.set_xlim(0, 14)
        ax.set_ylim(0, 10)
        ax.set_aspect('equal')
        ax.axis('off')

        # Title
        ax.text(7, 9.5, 'The Torsion Funnel: 288-24-125 Flow',
                fontsize=16, ha='center', fontweight='bold', color='#1a1a2e')
        ax.text(7, 9.0, 'v16.2 Sterile Model - Geometric Projection from 26D to 4D',
                fontsize=11, ha='center', color='#666', style='italic')

        # ========== LAYER 0: 26D Bulk (288 Roots) ==========
        bulk_box = FancyBboxPatch(
            (2, 7.5), 10, 1.2,
            boxstyle="round,pad=0.1,rounding_size=0.3",
            facecolor=PM_COLORS['purple'], alpha=0.9,
            edgecolor='#1a1a2e', linewidth=2
        )
        ax.add_patch(bulk_box)
        ax.text(7, 8.1, '26D Bulk Potential', fontsize=13, ha='center',
                fontweight='bold', color='white')
        ax.text(7, 7.7, '288 Ancestral Roots (Yod)',
                fontsize=10, ha='center', color='white', alpha=0.9)

        # ========== LAYER 1: Breakdown (SO(24), Shadow, Cost) ==========
        # SO(24) generators
        so24_box = FancyBboxPatch(
            (1.5, 5.8), 3, 1,
            boxstyle="round,pad=0.1,rounding_size=0.2",
            facecolor=PM_COLORS['blue'], alpha=0.85,
            edgecolor='#1a1a2e', linewidth=1.5
        )
        ax.add_patch(so24_box)
        ax.text(3, 6.3, 'SO(24) Generators', fontsize=10, ha='center',
                fontweight='bold', color='white')
        ax.text(3, 5.95, '276', fontsize=14, ha='center', color='white')

        # Shadow Torsion
        shadow_box = FancyBboxPatch(
            (5.5, 5.8), 3, 1,
            boxstyle="round,pad=0.1,rounding_size=0.2",
            facecolor=PM_COLORS['gold'], alpha=0.85,
            edgecolor='#1a1a2e', linewidth=1.5
        )
        ax.add_patch(shadow_box)
        ax.text(7, 6.3, 'Shadow Torsion', fontsize=10, ha='center',
                fontweight='bold', color='#1a1a2e')
        ax.text(7, 5.95, '+24', fontsize=14, ha='center', color='#1a1a2e')

        # Manifold Cost
        cost_box = FancyBboxPatch(
            (9.5, 5.8), 3, 1,
            boxstyle="round,pad=0.1,rounding_size=0.2",
            facecolor=PM_COLORS['red'], alpha=0.85,
            edgecolor='#1a1a2e', linewidth=1.5
        )
        ax.add_patch(cost_box)
        ax.text(11, 6.3, 'Manifold Cost', fontsize=10, ha='center',
                fontweight='bold', color='white')
        ax.text(11, 5.95, '-12', fontsize=14, ha='center', color='white')

        # Arrows from bulk to breakdown
        for x_pos, width in [(3, 2.5), (7, 2.0), (11, 1.5)]:
            arrow = FancyArrowPatch(
                (7, 7.5), (x_pos, 6.8),
                arrowstyle='->', mutation_scale=15,
                linewidth=max(1, width), color='#1a1a2e', alpha=0.7
            )
            ax.add_patch(arrow)

        # ========== LAYER 2: Torsion Barrier (24 Pins) ==========
        barrier_box = FancyBboxPatch(
            (3, 4.0), 8, 1.2,
            boxstyle="round,pad=0.1,rounding_size=0.3",
            facecolor=PM_COLORS['orange'], alpha=0.9,
            edgecolor='#1a1a2e', linewidth=2
        )
        ax.add_patch(barrier_box)
        ax.text(7, 4.6, 'Torsion Barrier', fontsize=13, ha='center',
                fontweight='bold', color='white')
        ax.text(7, 4.2, '24 Pins (Nun Sofit) - Bottleneck',
                fontsize=10, ha='center', color='white', alpha=0.9)

        # Arrows from breakdown to barrier
        for x_pos in [3, 7, 11]:
            arrow = FancyArrowPatch(
                (x_pos, 5.8), (7, 5.2),
                arrowstyle='->', mutation_scale=12,
                linewidth=1.5, color='#1a1a2e', alpha=0.6
            )
            ax.add_patch(arrow)

        # ========== LAYER 3: 4-Pattern Distribution ==========
        dim_colors = [PM_COLORS['purple'], PM_COLORS['blue'],
                      PM_COLORS['teal'], PM_COLORS['green']]
        dim_labels = ['t (time)', 'x (space)', 'y (space)', 'z (space)']
        dim_x_positions = [2.5, 5, 7.5, 10]

        for i, (x_pos, label, color) in enumerate(zip(dim_x_positions, dim_labels, dim_colors)):
            dim_box = FancyBboxPatch(
                (x_pos, 2.5), 2, 0.9,
                boxstyle="round,pad=0.1,rounding_size=0.15",
                facecolor=color, alpha=0.8,
                edgecolor='#1a1a2e', linewidth=1.5
            )
            ax.add_patch(dim_box)
            ax.text(x_pos + 1, 3.0, label, fontsize=9, ha='center',
                    fontweight='bold', color='white')
            ax.text(x_pos + 1, 2.7, '6 pins', fontsize=9, ha='center', color='white')

            # Arrow from barrier to dimension
            arrow = FancyArrowPatch(
                (7, 4.0), (x_pos + 1, 3.4),
                arrowstyle='->', mutation_scale=10,
                linewidth=1.5, color=color, alpha=0.8
            )
            ax.add_patch(arrow)

        # ========== LAYER 4: Exit (Active + Hidden) ==========
        # Active Residues
        active_box = FancyBboxPatch(
            (1.5, 0.5), 5, 1.4,
            boxstyle="round,pad=0.1,rounding_size=0.3",
            facecolor=PM_COLORS['active'], alpha=0.9,
            edgecolor='#1a1a2e', linewidth=2
        )
        ax.add_patch(active_box)
        ax.text(4, 1.25, 'Active Residues', fontsize=12, ha='center',
                fontweight='bold', color='#1a1a2e')
        ax.text(4, 0.85, '125 Observable Particles (43.4%)',
                fontsize=10, ha='center', color='#1a1a2e')

        # Hidden Supports
        hidden_box = FancyBboxPatch(
            (7.5, 0.5), 5, 1.4,
            boxstyle="round,pad=0.1,rounding_size=0.3",
            facecolor=PM_COLORS['hidden'], alpha=0.9,
            edgecolor='#1a1a2e', linewidth=2
        )
        ax.add_patch(hidden_box)
        ax.text(10, 1.25, 'Hidden Supports', fontsize=12, ha='center',
                fontweight='bold', color='#1a1a2e')
        ax.text(10, 0.85, '163 Bulk Scaffolding (56.6%)',
                fontsize=10, ha='center', color='#1a1a2e')

        # Arrows from dimensions to exit
        for x_pos in dim_x_positions[:2]:
            arrow = FancyArrowPatch(
                (x_pos + 1, 2.5), (4, 1.9),
                arrowstyle='->', mutation_scale=12,
                linewidth=2, color=PM_COLORS['active'], alpha=0.7
            )
            ax.add_patch(arrow)
        for x_pos in dim_x_positions[2:]:
            arrow = FancyArrowPatch(
                (x_pos + 1, 2.5), (10, 1.9),
                arrowstyle='->', mutation_scale=12,
                linewidth=2, color=PM_COLORS['hidden'], alpha=0.7
            )
            ax.add_patch(arrow)

        # ========== Flow Summary Box ==========
        summary_box = FancyBboxPatch(
            (0.3, 4.5), 2.2, 2.2,
            boxstyle="round,pad=0.1,rounding_size=0.15",
            facecolor='white', alpha=0.95,
            edgecolor=PM_COLORS['purple'], linewidth=2
        )
        ax.add_patch(summary_box)
        ax.text(1.4, 6.4, 'Flow Summary', fontsize=10, ha='center',
                fontweight='bold', color=PM_COLORS['purple'])
        ax.text(1.4, 6.0, '288 Entry', fontsize=9, ha='center', color='#444')
        ax.text(1.4, 5.6, '24 Bottleneck', fontsize=9, ha='center', color='#444')
        ax.text(1.4, 5.2, '125 + 163 Exit', fontsize=9, ha='center', color='#444')
        ax.text(1.4, 4.8, '= 288 Total', fontsize=9, ha='center',
                fontweight='bold', color=PM_COLORS['purple'])

        # ========== Sterile Angle Annotation ==========
        angle_box = FancyBboxPatch(
            (11.5, 4.5), 2.3, 2.2,
            boxstyle="round,pad=0.1,rounding_size=0.15",
            facecolor='white', alpha=0.95,
            edgecolor=PM_COLORS['orange'], linewidth=2
        )
        ax.add_patch(angle_box)
        ax.text(12.65, 6.4, 'Sterile Angle', fontsize=10, ha='center',
                fontweight='bold', color=PM_COLORS['orange'])
        ax.text(12.65, 6.0, r'$\theta = \arcsin(\frac{125}{288})$',
                fontsize=9, ha='center', color='#444')
        ax.text(12.65, 5.5, r'$\theta = 25.72\degree$',
                fontsize=11, ha='center', fontweight='bold', color=PM_COLORS['orange'])
        ax.text(12.65, 5.0, 'Geometric Lock', fontsize=9, ha='center', color='#444')
        ax.text(12.65, 4.7, '(Immutable)', fontsize=8, ha='center',
                color='#888', style='italic')

        # Save
        OUTPUT_DIR.mkdir(parents=True, exist_ok=True)
        output_path = OUTPUT_DIR / "torsion_funnel_v16_2.png"
        plt.tight_layout()
        plt.savefig(output_path, dpi=300, facecolor='white', edgecolor='none')
        plt.close()

        print(f"Generated: {output_path}")
        return output_path


def generate_torsion_funnel():
    """Public entry point for funnel generation."""
    return TorsionFunnelVisualization.generate_funnel()


def main():
    """Generate the Torsion Funnel visualization."""
    print("=" * 60)
    print("Generating Torsion Funnel Visualization")
    print("=" * 60)

    output_path = generate_torsion_funnel()

    print("\n" + "=" * 60)
    print("Torsion Funnel Complete")
    print("=" * 60)
    if output_path:
        print(f"  Output: {output_path}")
    print("=" * 60)


if __name__ == "__main__":
    main()
