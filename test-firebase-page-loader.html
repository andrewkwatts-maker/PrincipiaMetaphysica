<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Page Loader Test - Principia Metaphysica</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0a0e1a;
            color: #e4e4e7;
        }

        h1, h2, h3 {
            color: #818cf8;
        }

        .test-section {
            background: #1a1f35;
            border: 1px solid #2d3548;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .pm-value {
            background: #2d3548;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #22c55e;
            font-weight: 600;
        }

        .pm-value:hover {
            background: #3d4558;
            cursor: help;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #2d3548;
        }

        th {
            background: #2d3548;
            color: #818cf8;
        }

        .success {
            color: #22c55e;
        }

        .error {
            color: #ef4444;
        }

        .info {
            background: #1e3a5f;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
        }

        .log {
            background: #0a0e1a;
            border: 1px solid #2d3548;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 2px solid #3b82f6;
            padding-left: 10px;
        }

        button {
            background: #818cf8;
            color: #0a0e1a;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #6366f1;
        }

        button:disabled {
            background: #2d3548;
            color: #71717a;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Firebase Page Loader Test</h1>
    <p>Testing dynamic PM value population from Firebase Firestore</p>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button id="load-test-btn">Load Test Page</button>
        <button id="refresh-btn">Refresh (Bypass Cache)</button>
        <button id="clear-cache-btn">Clear Cache</button>
        <button id="test-populate-btn">Test Populate Function</button>
        <div id="status" style="margin-top: 15px;"></div>
    </div>

    <div class="test-section">
        <h2>Test Case 1: Proton Decay Parameters</h2>
        <div class="info">
            Testing data-category + data-param pattern with various formats
        </div>
        <table>
            <tr>
                <th>Parameter</th>
                <th>Value</th>
                <th>HTML</th>
            </tr>
            <tr>
                <td>M<sub>GUT</sub> (display)</td>
                <td>
                    <span class="pm-value"
                          data-category="proton_decay"
                          data-param="M_GUT"
                          data-format="display">Loading...</span> GeV
                </td>
                <td><code>data-category="proton_decay" data-param="M_GUT" data-format="display"</code></td>
            </tr>
            <tr>
                <td>α<sub>GUT</sub> (fixed:4)</td>
                <td>
                    <span class="pm-value"
                          data-category="proton_decay"
                          data-param="alpha_GUT"
                          data-format="fixed:4">Loading...</span>
                </td>
                <td><code>data-category="proton_decay" data-param="alpha_GUT" data-format="fixed:4"</code></td>
            </tr>
            <tr>
                <td>Ratio to bound (fixed:1)</td>
                <td>
                    <span class="pm-value"
                          data-category="proton_decay"
                          data-param="ratio_to_bound"
                          data-format="fixed:1">Loading...</span>×
                </td>
                <td><code>data-category="proton_decay" data-param="ratio_to_bound" data-format="fixed:1"</code></td>
            </tr>
        </table>
    </div>

    <div class="test-section">
        <h2>Test Case 2: PMNS Matrix Parameters</h2>
        <div class="info">
            Testing neutrino mixing angles with fixed decimal format
        </div>
        <table>
            <tr>
                <th>Parameter</th>
                <th>Value</th>
                <th>HTML</th>
            </tr>
            <tr>
                <td>θ<sub>12</sub></td>
                <td>
                    <span class="pm-value"
                          data-category="pmns_matrix"
                          data-param="theta_12"
                          data-format="fixed:2">Loading...</span>°
                </td>
                <td><code>data-category="pmns_matrix" data-param="theta_12" data-format="fixed:2"</code></td>
            </tr>
            <tr>
                <td>θ<sub>23</sub></td>
                <td>
                    <span class="pm-value"
                          data-category="pmns_matrix"
                          data-param="theta_23"
                          data-format="fixed:2">Loading...</span>°
                </td>
                <td><code>data-category="pmns_matrix" data-param="theta_23" data-format="fixed:2"</code></td>
            </tr>
            <tr>
                <td>θ<sub>13</sub></td>
                <td>
                    <span class="pm-value"
                          data-category="pmns_matrix"
                          data-param="theta_13"
                          data-format="fixed:2">Loading...</span>°
                </td>
                <td><code>data-category="pmns_matrix" data-param="theta_13" data-format="fixed:2"</code></td>
            </tr>
            <tr>
                <td>δ<sub>CP</sub></td>
                <td>
                    <span class="pm-value"
                          data-category="pmns_matrix"
                          data-param="delta_CP"
                          data-format="fixed:1">Loading...</span>°
                </td>
                <td><code>data-category="pmns_matrix" data-param="delta_CP" data-format="fixed:1"</code></td>
            </tr>
        </table>
    </div>

    <div class="test-section">
        <h2>Test Case 3: Gauge Unification</h2>
        <div class="info">
            Testing gauge coupling parameters
        </div>
        <table>
            <tr>
                <th>Parameter</th>
                <th>Value</th>
                <th>HTML</th>
            </tr>
            <tr>
                <td>1/α<sub>GUT</sub> (fixed:2)</td>
                <td>
                    <span class="pm-value"
                          data-category="gauge_unification"
                          data-param="alpha_GUT_inv"
                          data-format="fixed:2">Loading...</span>
                </td>
                <td><code>data-category="gauge_unification" data-param="alpha_GUT_inv" data-format="fixed:2"</code></td>
            </tr>
        </table>
    </div>

    <div class="test-section">
        <h2>Test Case 4: Nested Path Access</h2>
        <div class="info">
            Testing data-pm-value pattern with nested object paths
        </div>
        <table>
            <tr>
                <th>Parameter</th>
                <th>Value</th>
                <th>HTML</th>
            </tr>
            <tr>
                <td>VEV (v_GeV)</td>
                <td>
                    <span class="pm-value"
                          data-pm-value="v12_6_geometric_derivations.vev_pneuma.v_EW"
                          data-format="fixed:3">Loading...</span> GeV
                </td>
                <td><code>data-pm-value="v12_6_geometric_derivations.vev_pneuma.v_EW" data-format="fixed:3"</code></td>
            </tr>
            <tr>
                <td>Higgs Mass</td>
                <td>
                    <span class="pm-value"
                          data-pm-value="v11_final_observables.higgs_mass.m_h_GeV"
                          data-format="fixed:2">Loading...</span> GeV
                </td>
                <td><code>data-pm-value="v11_final_observables.higgs_mass.m_h_GeV" data-format="fixed:2"</code></td>
            </tr>
            <tr>
                <td>1/α<sub>GUT</sub> (nested)</td>
                <td>
                    <span class="pm-value"
                          data-pm-value="proton_decay.alpha_GUT_inv"
                          data-format="fixed:2">Loading...</span>
                </td>
                <td><code>data-pm-value="proton_decay.alpha_GUT_inv" data-format="fixed:2"</code></td>
            </tr>
            <tr>
                <td>Proton Lifetime</td>
                <td>
                    <span class="pm-value"
                          data-pm-value="v11_final_observables.proton_lifetime.tau_p_years"
                          data-format="scientific:2">Loading...</span> years
                </td>
                <td><code>data-pm-value="v11_final_observables.proton_lifetime.tau_p_years" data-format="scientific:2"</code></td>
            </tr>
        </table>
    </div>

    <div class="test-section">
        <h2>Test Case 5: Dark Energy Parameters</h2>
        <div class="info">
            Testing dark energy equation of state
        </div>
        <table>
            <tr>
                <th>Parameter</th>
                <th>Value</th>
                <th>HTML</th>
            </tr>
            <tr>
                <td>w<sub>0</sub></td>
                <td>
                    <span class="pm-value"
                          data-category="dark_energy"
                          data-param="w0_PM"
                          data-format="fixed:4">Loading...</span>
                </td>
                <td><code>data-category="dark_energy" data-param="w0_PM" data-format="fixed:4"</code></td>
            </tr>
        </table>
    </div>

    <div class="test-section">
        <h2>Event Log</h2>
        <div class="info">
            Console events from firebase-page-loader module
        </div>
        <div id="event-log" class="log">
            <div class="log-entry">Waiting for events...</div>
        </div>
    </div>

    <!-- Firebase and Module Scripts -->
    <script type="module">
        import { loadPageFromFirebase, populatePMValues, clearPageCache, refreshPageData } from './js/firebase-page-loader.js';

        // Log area
        const eventLog = document.getElementById('event-log');
        const statusDiv = document.getElementById('status');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.borderColor = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            eventLog.appendChild(entry);
            eventLog.scrollTop = eventLog.scrollHeight;
        }

        function setStatus(message, type = 'info') {
            statusDiv.innerHTML = `<span class="${type}">${message}</span>`;
        }

        // Event listeners
        window.addEventListener('pm-page-loaded', (event) => {
            const { pageId, pmData, pageContent, timestamp, fallback } = event.detail;
            log(`✓ pm-page-loaded: ${pageId} ${fallback ? '(fallback)' : ''}`, 'success');
            log(`  PM Data keys: ${Object.keys(pmData).length}`, 'info');
            setStatus('Page loaded successfully!', 'success');
        });

        window.addEventListener('pm-tooltips-ready', () => {
            log('✓ pm-tooltips-ready', 'success');
        });

        // Button handlers
        document.getElementById('load-test-btn').addEventListener('click', async () => {
            log('Loading test page...', 'info');
            setStatus('Loading...', 'info');

            try {
                const result = await loadPageFromFirebase('test');

                if (result.success) {
                    log(`✓ Load successful ${result.fromCache ? '(from cache)' : ''}`, 'success');
                    setStatus('Load successful!', 'success');
                } else {
                    log(`✗ Load failed: ${result.error}`, 'error');
                    setStatus('Load failed - check console', 'error');
                }
            } catch (error) {
                log(`✗ Exception: ${error.message}`, 'error');
                setStatus('Error - check console', 'error');
            }
        });

        document.getElementById('refresh-btn').addEventListener('click', async () => {
            log('Refreshing data (bypass cache)...', 'info');
            setStatus('Refreshing...', 'info');

            try {
                const result = await refreshPageData('test');
                log('✓ Refresh complete', 'success');
                setStatus('Refreshed successfully!', 'success');
            } catch (error) {
                log(`✗ Refresh failed: ${error.message}`, 'error');
                setStatus('Refresh failed', 'error');
            }
        });

        document.getElementById('clear-cache-btn').addEventListener('click', () => {
            log('Clearing cache...', 'info');
            clearPageCache();
            log('✓ Cache cleared', 'success');
            setStatus('Cache cleared', 'success');
        });

        document.getElementById('test-populate-btn').addEventListener('click', () => {
            if (typeof window.PM === 'undefined') {
                log('✗ PM object not available', 'error');
                setStatus('PM not loaded - click "Load Test Page" first', 'error');
                return;
            }

            log('Testing populatePMValues()...', 'info');
            const count = populatePMValues(window.PM);
            log(`✓ Populated ${count} values`, 'success');
            setStatus(`Populated ${count} PM values`, 'success');
        });

        // Auto-load on page ready
        log('Test page ready', 'success');
        log('Click "Load Test Page" to begin', 'info');
    </script>
</body>
</html>
