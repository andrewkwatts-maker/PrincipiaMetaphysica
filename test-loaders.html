<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM Loaders Test - Debug Page</title>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            line-height: 1.6;
            background: #1a1a2e;
            color: #e0e0e0;
        }
        h1 {
            color: #8b7fff;
            border-bottom: 3px solid #8b7fff;
            padding-bottom: 0.5rem;
        }
        h2 {
            color: #60a5fa;
            margin-top: 2rem;
            border-left: 4px solid #60a5fa;
            padding-left: 1rem;
        }
        .test-group {
            background: #252540;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(139, 127, 255, 0.3);
        }
        .test-item {
            margin: 0.75rem 0;
            padding: 0.75rem;
            background: rgba(139, 127, 255, 0.1);
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .test-label {
            font-weight: 600;
            color: #60a5fa;
            display: inline-block;
            min-width: 250px;
        }
        .pm-value, [data-pm-value], [data-category] {
            color: #4ade80;
            font-weight: 700;
        }
        .pm-loaded {
            color: #4ade80;
            animation: highlight 0.5s ease-in-out;
        }
        .pm-error {
            color: #f87171 !important;
            font-weight: bold;
        }
        .pm-loading {
            color: #fbbf24;
            animation: pulse 1s ease-in-out infinite;
        }
        @keyframes highlight {
            0% { background-color: rgba(74, 222, 128, 0.3); }
            100% { background-color: transparent; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .status-success { background: #4ade80; }
        .status-error { background: #f87171; }
        .status-loading { background: #fbbf24; animation: pulse 1s ease-in-out infinite; }
        button {
            background: #8b7fff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover {
            background: #7461e8;
        }
        .console-output {
            background: #1e1e2e;
            color: #cdd6f4;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin-top: 1rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        code {
            background: rgba(139, 127, 255, 0.2);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border-left: 4px solid;
        }
        .alert-info {
            background: rgba(96, 165, 250, 0.1);
            border-color: #60a5fa;
            color: #60a5fa;
        }
        .alert-success {
            background: rgba(74, 222, 128, 0.1);
            border-color: #4ade80;
            color: #4ade80;
        }
        .alert-warning {
            background: rgba(251, 191, 36, 0.1);
            border-color: #fbbf24;
            color: #fbbf24;
        }
        .alert-error {
            background: rgba(248, 113, 113, 0.1);
            border-color: #f87171;
            color: #f87171;
        }
    </style>
</head>
<body>
    <h1>PM Loaders Debug & Test Page</h1>

    <div class="alert alert-info">
        <strong>Debug Mode:</strong> Set <code>window.PM_DEBUG = true</code> in console for verbose logging.
        <br>
        <strong>Note:</strong> If using file:// protocol, you may see CORS errors. Run a local web server instead:
        <code>python -m http.server 8000</code>
    </div>

    <!-- Loader Status -->
    <div class="test-group">
        <h2>Loader Status</h2>
        <div class="grid">
            <div class="test-item">
                <span class="status-indicator" id="pm-status"></span>
                <strong>PM Constants Loader:</strong>
                <div id="pm-loader-status">Initializing...</div>
            </div>
            <div class="test-item">
                <span class="status-indicator" id="formula-status"></span>
                <strong>PM Formula Loader:</strong>
                <div id="formula-loader-status">Initializing...</div>
            </div>
        </div>
        <div style="margin-top: 1rem;">
            <button onclick="reloadAll()">Reload All Data</button>
            <button onclick="checkGlobalObjects()">Check Global Objects</button>
            <button onclick="window.PM_DEBUG = !window.PM_DEBUG; alert('PM_DEBUG = ' + window.PM_DEBUG)">Toggle Debug Mode</button>
        </div>
    </div>

    <!-- Test data-pm-value format -->
    <div class="test-group">
        <h2>Test 1: data-pm-value Format</h2>
        <div class="test-item">
            <span class="test-label">Version:</span>
            <span data-pm-value="version">...</span>
        </div>
        <div class="test-item">
            <span class="test-label">Proton Decay (τ_p years):</span>
            <span data-pm-value="simulations.proton_decay.tau_p_years">...</span>
        </div>
        <div class="test-item">
            <span class="test-label">W Boson Mass (GeV):</span>
            <span data-pm-value="simulations.wz_evolution.m_W_GeV" data-format="fixed:3">...</span> GeV
        </div>
        <div class="test-item">
            <span class="test-label">Z Boson Mass (GeV):</span>
            <span data-pm-value="simulations.wz_evolution.m_Z_GeV" data-format="fixed:3">...</span> GeV
        </div>
        <div class="test-item">
            <span class="test-label">Bulk Dimensions:</span>
            <span data-pm-value="dimensions.D_BULK">...</span>
        </div>
    </div>

    <!-- Test data-category + data-param format -->
    <div class="test-group">
        <h2>Test 2: data-category + data-param Format</h2>
        <div class="test-item">
            <span class="test-label">Chirality Generations:</span>
            <span data-category="simulations" data-param="chirality_generations.N_fermion_gen">...</span>
        </div>
        <div class="test-item">
            <span class="test-label">KK Spectrum Count:</span>
            <span data-category="simulations" data-param="kk_spectrum.num_modes">...</span>
        </div>
        <div class="test-item">
            <span class="test-label">Proton Decay σ:</span>
            <span data-category="simulations" data-param="proton_decay.sigma_deviation" data-format="fixed:2">...</span>σ
        </div>
    </div>

    <!-- Test Formula Loading -->
    <div class="test-group">
        <h2>Test 3: Formula Loading</h2>
        <div class="test-item">
            <span class="test-label">Generation Number Formula:</span>
            <div data-formula-id="generation-number" style="margin-top: 0.5rem;">...</div>
        </div>
        <div class="test-item">
            <span class="test-label">All Formulas Loaded:</span>
            <span id="formula-count">0</span> formulas
        </div>
        <button onclick="showFormulas()">Show All Formula IDs</button>
        <div id="formula-list"></div>
    </div>

    <!-- Test Simulations Data -->
    <div class="test-group">
        <h2>Test 4: Simulation Results</h2>
        <div class="grid">
            <div class="test-item">
                <strong>Proton Decay:</strong><br>
                τ_p = <span data-pm-value="simulations.proton_decay.tau_p_years">...</span> years<br>
                Experimental: <span data-pm-value="simulations.proton_decay.experimental_value">...</span><br>
                σ: <span data-pm-value="simulations.proton_decay.sigma_deviation" data-format="fixed:2">...</span>
            </div>
            <div class="test-item">
                <strong>W/Z Evolution:</strong><br>
                m_W = <span data-pm-value="simulations.wz_evolution.m_W_GeV" data-format="fixed:3">...</span> GeV<br>
                m_Z = <span data-pm-value="simulations.wz_evolution.m_Z_GeV" data-format="fixed:3">...</span> GeV<br>
                Status: <span data-pm-value="simulations.wz_evolution.status">...</span>
            </div>
            <div class="test-item">
                <strong>Chirality:</strong><br>
                Generations: <span data-pm-value="simulations.chirality_generations.N_fermion_gen">...</span><br>
                σ: <span data-pm-value="simulations.chirality_generations.sigma_deviation" data-format="fixed:2">...</span>
            </div>
            <div class="test-item">
                <strong>KK Spectrum:</strong><br>
                Modes: <span data-pm-value="simulations.kk_spectrum.num_modes">...</span><br>
                Status: <span data-pm-value="simulations.kk_spectrum.status">...</span>
            </div>
        </div>
    </div>

    <!-- JavaScript API Test -->
    <div class="test-group">
        <h2>Test 5: JavaScript API</h2>
        <button onclick="testJavaScriptAPI()">Run JavaScript API Tests</button>
        <div id="js-test-results"></div>
    </div>

    <!-- Global Objects Inspector -->
    <div class="test-group">
        <h2>Global Objects Inspector</h2>
        <button onclick="inspectGlobals()">Inspect window.PM</button>
        <button onclick="inspectFormulas()">Inspect window.PM_FORMULAS</button>
        <button onclick="inspectData()">Inspect window.PM_DATA</button>
        <div id="inspector-output"></div>
    </div>

    <!-- Console Output -->
    <div class="test-group">
        <h2>Console Messages</h2>
        <div class="console-output" id="console-mirror">
            Console messages will appear here...
        </div>
    </div>

    <!-- Load the loaders -->
    <script src="js/pm-constants-loader.js"></script>
    <script src="js/pm-formula-loader.js"></script>

    <script>
        // Mirror console messages to the page
        const consoleMirror = document.getElementById('console-mirror');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function mirrorToPage(type, args) {
            const message = Array.from(args).map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg, null, 2);
                }
                return String(arg);
            }).join(' ');

            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f87171' : type === 'warn' ? '#fbbf24' : '#4ade80';
            consoleMirror.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            consoleMirror.scrollTop = consoleMirror.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            mirrorToPage('log', args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            mirrorToPage('error', args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            mirrorToPage('warn', args);
        };

        // Check loader status
        async function checkStatus() {
            const pmStatus = document.getElementById('pm-status');
            const pmText = document.getElementById('pm-loader-status');
            const formulaStatus = document.getElementById('formula-status');
            const formulaText = document.getElementById('formula-loader-status');

            // Check PM loader
            if (window.PM && window.PM._loaded) {
                pmStatus.className = 'status-indicator status-success';
                pmText.innerHTML = `Loaded! Version: ${window.PM.version}<br>Simulations: ${Object.keys(window.PM._data?.simulations || {}).length}`;
            } else if (window.PM && window.PM._loading) {
                pmStatus.className = 'status-indicator status-loading';
                pmText.textContent = 'Loading...';
            } else {
                pmStatus.className = 'status-indicator status-error';
                pmText.innerHTML = 'Not loaded or error<br>' + (window.PM?._error || 'Unknown error');
            }

            // Check Formula loader
            if (window.PMFormulaLoader && window.PMFormulaLoader._loaded) {
                formulaStatus.className = 'status-indicator status-success';
                formulaText.innerHTML = `Loaded! Formulas: ${Object.keys(window.PMFormulaLoader._formulas || {}).length}<br>Version: ${window.PMFormulaLoader._version}`;
                document.getElementById('formula-count').textContent = Object.keys(window.PMFormulaLoader._formulas || {}).length;
            } else if (window.PMFormulaLoader && window.PMFormulaLoader._loading) {
                formulaStatus.className = 'status-indicator status-loading';
                formulaText.textContent = 'Loading...';
            } else {
                formulaStatus.className = 'status-indicator status-error';
                formulaText.textContent = 'Not loaded or error';
            }
        }

        // Reload all data
        async function reloadAll() {
            consoleMirror.innerHTML = '<div style="color: #60a5fa">Reloading all data...</div>';
            window.PM._loaded = false;
            window.PM._loading = null;
            window.PMFormulaLoader._loaded = false;
            window.PMFormulaLoader._loading = null;

            await Promise.all([
                window.PM.load(),
                window.PMFormulaLoader.load()
            ]);

            checkStatus();
        }

        // Check global objects
        function checkGlobalObjects() {
            const results = [];
            results.push('window.PM: ' + (window.PM ? '✓' : '✗'));
            results.push('window.PM_DATA: ' + (window.PM_DATA ? '✓' : '✗'));
            results.push('window.PM_FORMULAS: ' + (window.PM_FORMULAS ? '✓' : '✗'));
            results.push('window.PMFormulaLoader: ' + (window.PMFormulaLoader ? '✓' : '✗'));
            alert(results.join('\n'));
        }

        // Show all formulas
        function showFormulas() {
            const list = document.getElementById('formula-list');
            if (!window.PMFormulaLoader || !window.PMFormulaLoader._formulas) {
                list.innerHTML = '<div class="alert alert-error">Formulas not loaded yet!</div>';
                return;
            }

            const formulas = window.PMFormulaLoader._formulas;
            const ids = Object.keys(formulas).sort();
            list.innerHTML = `<div class="console-output">${ids.join('\n')}</div>`;
        }

        // Test JavaScript API
        function testJavaScriptAPI() {
            const results = document.getElementById('js-test-results');
            const tests = [];

            try {
                // Test PM.get()
                const version = window.PM.get('version');
                tests.push(`✓ PM.get('version'): ${version}`);

                const protonDecay = window.PM.get('simulations.proton_decay.tau_p_years');
                tests.push(`✓ PM.get('simulations.proton_decay.tau_p_years'): ${protonDecay}`);

                // Test PM.simulation()
                const wz = window.PM.simulation('wz_evolution.m_W_GeV');
                tests.push(`✓ PM.simulation('wz_evolution.m_W_GeV'): ${wz}`);

                // Test PM.formula()
                const formula = window.PM.formula('generation-number');
                tests.push(`✓ PM.formula('generation-number'): ${formula ? 'Found' : 'Not found'}`);

                // Test PMFormulaLoader.get()
                const formula2 = window.PMFormulaLoader.get('generation-number');
                tests.push(`✓ PMFormulaLoader.get('generation-number'): ${formula2 ? 'Found' : 'Not found'}`);

                // Test PMFormulaLoader.getAll()
                const allFormulas = window.PMFormulaLoader.getAll();
                tests.push(`✓ PMFormulaLoader.getAll(): ${Object.keys(allFormulas).length} formulas`);

                results.innerHTML = `<div class="console-output" style="color: #4ade80">${tests.join('\n')}</div>`;
            } catch (error) {
                results.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        // Inspect globals
        function inspectGlobals() {
            const output = document.getElementById('inspector-output');
            const data = {
                _loaded: window.PM?._loaded,
                _error: window.PM?._error,
                version: window.PM?.version,
                simulations: window.PM?._data?.simulations ? Object.keys(window.PM._data.simulations) : null,
                formulas: window.PM?._data?.formulas ? 'Available' : 'Not available',
                dimensions: window.PM?.dimensions
            };
            output.innerHTML = `<div class="console-output">${JSON.stringify(data, null, 2)}</div>`;
        }

        function inspectFormulas() {
            const output = document.getElementById('inspector-output');
            if (!window.PM_FORMULAS) {
                output.innerHTML = '<div class="alert alert-error">window.PM_FORMULAS not available</div>';
                return;
            }
            const ids = Object.keys(window.PM_FORMULAS).slice(0, 20);
            output.innerHTML = `<div class="console-output">First 20 formula IDs:\n${ids.join('\n')}\n\nTotal: ${Object.keys(window.PM_FORMULAS).length}</div>`;
        }

        function inspectData() {
            const output = document.getElementById('inspector-output');
            if (!window.PM_DATA) {
                output.innerHTML = '<div class="alert alert-error">window.PM_DATA not available</div>';
                return;
            }
            const summary = {
                version: window.PM_DATA.version,
                simulations: window.PM_DATA.simulations ? Object.keys(window.PM_DATA.simulations) : null,
                formulas: window.PM_DATA.formulas?.count || 0,
                parameters: window.PM_DATA.parameters ? Object.keys(window.PM_DATA.parameters) : null
            };
            output.innerHTML = `<div class="console-output">${JSON.stringify(summary, null, 2)}</div>`;
        }

        // Check status periodically
        setInterval(checkStatus, 2000);
        checkStatus();

        // Initial message
        console.log('PM Loaders Test Page initialized');
        console.log('Waiting for loaders to complete...');
    </script>
</body>
</html>
