<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM Constants Loader - Compatibility Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #2c3e50; }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 10px;
            margin: 20px 0;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-grid > div {
            padding: 8px;
        }
        .test-header {
            font-weight: bold;
            background: #ecf0f1;
            border-radius: 4px;
        }
        .test-label {
            font-family: monospace;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .test-value {
            font-weight: bold;
            padding: 8px 12px !important;
            border-radius: 4px;
            min-width: 100px;
            text-align: center;
        }
        .test-status {
            text-align: center;
        }
        .pm-loaded {
            background: #d4edda;
            color: #155724;
        }
        .pm-error {
            background: #f8d7da;
            color: #721c24;
            cursor: help;
        }
        .pm-loading {
            background: #fff3cd;
            color: #856404;
        }
        .status-pass {
            color: #28a745;
            font-weight: bold;
        }
        .status-fail {
            color: #dc3545;
            font-weight: bold;
        }
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .summary {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-stat {
            display: inline-block;
            margin: 10px 20px 10px 0;
            font-size: 18px;
        }
        .summary-stat strong {
            color: #2c3e50;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>PM Constants Loader - 100% Compatibility Test</h1>

    <div class="info-box">
        <strong>Test Status:</strong> <span id="overall-status">Running tests...</span><br>
        <strong>Version:</strong> 2.1.0 - Full compatibility with error reporting<br>
        <strong>Test Coverage:</strong> All data attribute patterns used in production
    </div>

    <div class="summary" id="summary">
        <h3>Test Summary</h3>
        <div class="summary-stat">
            <strong>Total Tests:</strong> <span id="total-tests">0</span>
        </div>
        <div class="summary-stat">
            <strong>Passed:</strong> <span id="passed-tests" style="color: #28a745;">0</span>
        </div>
        <div class="summary-stat">
            <strong>Failed:</strong> <span id="failed-tests" style="color: #dc3545;">0</span>
        </div>
        <div class="summary-stat">
            <strong>Success Rate:</strong> <span id="success-rate">0%</span>
        </div>
    </div>

    <h2>1. data-pm-value Tests (Direct Path)</h2>
    <div class="test-grid">
        <div class="test-header">Test</div>
        <div class="test-header">Attribute</div>
        <div class="test-header">Value</div>
        <div class="test-header">Status</div>

        <div class="test-label">Dimension constant</div>
        <div><code>data-pm-value="dimensions.D_BULK"</code></div>
        <div class="test-value" data-pm-value="dimensions.D_BULK" data-test-expected="26"></div>
        <div class="test-status" data-test-for="dimensions.D_BULK"></div>

        <div class="test-label">Dimension constant (G2)</div>
        <div><code>data-pm-value="dimensions.D_G2"</code></div>
        <div class="test-value" data-pm-value="dimensions.D_G2" data-test-expected="7"></div>
        <div class="test-status" data-test-for="dimensions.D_G2"></div>

        <div class="test-label">Proton decay lifetime</div>
        <div><code>data-pm-value="simulations.proton_decay.tau_p_years"</code></div>
        <div class="test-value" data-pm-value="simulations.proton_decay.tau_p_years"></div>
        <div class="test-status" data-test-for="simulations.proton_decay.tau_p_years"></div>

        <div class="test-label">Topology chi_eff</div>
        <div><code>data-pm-value="parameters.topology.CHI_EFF"</code></div>
        <div class="test-value" data-pm-value="parameters.topology.CHI_EFF" data-test-expected="144"></div>
        <div class="test-status" data-test-for="parameters.topology.CHI_EFF"></div>

        <div class="test-label">Dark energy w0</div>
        <div><code>data-pm-value="parameters.dark_energy.w0"</code></div>
        <div class="test-value" data-pm-value="parameters.dark_energy.w0" data-format="fixed:4"></div>
        <div class="test-status" data-test-for="parameters.dark_energy.w0"></div>

        <div class="test-label">Invalid path (should fail)</div>
        <div><code>data-pm-value="invalid.path.test"</code></div>
        <div class="test-value" data-pm-value="invalid.path.test" data-test-should-fail="true"></div>
        <div class="test-status" data-test-for="invalid.path.test"></div>
    </div>

    <h2>2. data-category + data-param Tests</h2>
    <div class="test-grid">
        <div class="test-header">Test</div>
        <div class="test-header">Attributes</div>
        <div class="test-header">Value</div>
        <div class="test-header">Status</div>

        <div class="test-label">Topology n_gen</div>
        <div><code>data-category="topology" data-param="n_gen"</code></div>
        <div class="test-value" data-category="topology" data-param="n_gen" data-test-expected="3"></div>
        <div class="test-status" data-test-for="topology.n_gen"></div>

        <div class="test-label">Topology chi_eff</div>
        <div><code>data-category="topology" data-param="chi_eff"</code></div>
        <div class="test-value" data-category="topology" data-param="chi_eff" data-test-expected="144"></div>
        <div class="test-status" data-test-for="topology.chi_eff"></div>

        <div class="test-label">Dark energy w0_PM</div>
        <div><code>data-category="dark_energy" data-param="w0"</code></div>
        <div class="test-value" data-category="dark_energy" data-param="w0" data-format="fixed:4"></div>
        <div class="test-status" data-test-for="dark_energy.w0"></div>

        <div class="test-label">KK spectrum m1</div>
        <div><code>data-category="kk_spectrum" data-param="m1"</code></div>
        <div class="test-value" data-category="kk_spectrum" data-param="m1"></div>
        <div class="test-status" data-test-for="kk_spectrum.m1"></div>

        <div class="test-label">PMNS theta_12</div>
        <div><code>data-category="pmns_matrix" data-param="theta_12" data-format="fixed:1"</code></div>
        <div class="test-value" data-category="pmns_matrix" data-param="theta_12" data-format="fixed:1"></div>
        <div class="test-status" data-test-for="pmns_matrix.theta_12"></div>

        <div class="test-label">Nested: Higgs mass</div>
        <div><code>data-category="simulations" data-param="higgs_mass.m_h_GeV"</code></div>
        <div class="test-value" data-category="simulations" data-param="higgs_mass.m_h_GeV" data-format="fixed:1"></div>
        <div class="test-status" data-test-for="simulations.higgs_mass.m_h_GeV"></div>

        <div class="test-label">Proton decay tau_p</div>
        <div><code>data-category="proton_decay" data-param="tau_p_years"</code></div>
        <div class="test-value" data-category="proton_decay" data-param="tau_p_years"></div>
        <div class="test-status" data-test-for="proton_decay.tau_p_years"></div>

        <div class="test-label">Invalid category/param</div>
        <div><code>data-category="invalid" data-param="test"</code></div>
        <div class="test-value" data-category="invalid" data-param="test" data-test-should-fail="true"></div>
        <div class="test-status" data-test-for="invalid.test"></div>
    </div>

    <h2>3. data-stat-id Tests</h2>
    <div class="test-grid">
        <div class="test-header">Test</div>
        <div class="test-header">Attribute</div>
        <div class="test-header">Value</div>
        <div class="test-header">Status</div>

        <div class="test-label">Total parameters</div>
        <div><code>data-stat-id="total_parameters"</code></div>
        <div class="test-value" data-stat-id="total_parameters"></div>
        <div class="test-status" data-test-for="stat.total_parameters"></div>

        <div class="test-label">Within 1 sigma</div>
        <div><code>data-stat-id="within_1sigma"</code></div>
        <div class="test-value" data-stat-id="within_1sigma"></div>
        <div class="test-status" data-test-for="stat.within_1sigma"></div>

        <div class="test-label">Within 2 sigma</div>
        <div><code>data-stat-id="within_2sigma"</code></div>
        <div class="test-value" data-stat-id="within_2sigma"></div>
        <div class="test-status" data-test-for="stat.within_2sigma"></div>

        <div class="test-label">Dotted path stat</div>
        <div><code>data-stat-id="simulations.proton_decay.tau_p_years"</code></div>
        <div class="test-value" data-stat-id="simulations.proton_decay.tau_p_years"></div>
        <div class="test-status" data-test-for="stat.simulations.proton_decay.tau_p_years"></div>
    </div>

    <h2>4. Format Tests</h2>
    <div class="test-grid">
        <div class="test-header">Test</div>
        <div class="test-header">Format</div>
        <div class="test-header">Value</div>
        <div class="test-header">Status</div>

        <div class="test-label">Scientific notation</div>
        <div><code>data-format="scientific:2"</code></div>
        <div class="test-value" data-pm-value="simulations.proton_decay.tau_p_years" data-format="scientific:2"></div>
        <div class="test-status" data-test-for="format.scientific"></div>

        <div class="test-label">Fixed decimals</div>
        <div><code>data-format="fixed:4"</code></div>
        <div class="test-value" data-pm-value="parameters.dark_energy.w0" data-format="fixed:4"></div>
        <div class="test-status" data-test-for="format.fixed"></div>

        <div class="test-label">Integer</div>
        <div><code>data-format="integer"</code></div>
        <div class="test-value" data-pm-value="parameters.topology.CHI_EFF" data-format="integer"></div>
        <div class="test-status" data-test-for="format.integer"></div>
    </div>

    <script src="js/pm-constants-loader.js"></script>
    <script>
        // Wait for PM to load, then run tests
        PM.load().then(() => {
            setTimeout(runTests, 500);
        });

        function runTests() {
            let totalTests = 0;
            let passedTests = 0;
            let failedTests = 0;

            // Test all elements with data-test-expected or data-test-should-fail
            const testElements = document.querySelectorAll('[data-test-expected], [data-test-should-fail]');

            testElements.forEach(el => {
                totalTests++;
                const expected = el.getAttribute('data-test-expected');
                const shouldFail = el.getAttribute('data-test-should-fail') === 'true';
                const actualText = el.textContent.trim();
                const hasError = el.classList.contains('pm-error');
                const hasLoaded = el.classList.contains('pm-loaded');

                let passed = false;

                if (shouldFail) {
                    // Should show error
                    passed = hasError && actualText === '?';
                } else if (expected) {
                    // Should match expected value
                    passed = hasLoaded && actualText === expected;
                } else {
                    // Should just load successfully (not empty, not "?")
                    passed = hasLoaded && actualText !== '?' && actualText !== '' && actualText !== '...';
                }

                // Update status column
                const statusEl = document.querySelector(`[data-test-for="${el.getAttribute('data-pm-value') || el.getAttribute('data-category') + '.' + el.getAttribute('data-param') || 'stat.' + el.getAttribute('data-stat-id') || 'format.' + el.getAttribute('data-format')?.split(':')[0]}"]`);

                if (statusEl) {
                    if (passed) {
                        statusEl.innerHTML = '<span class="status-pass">✓ PASS</span>';
                        passedTests++;
                    } else {
                        statusEl.innerHTML = '<span class="status-fail">✗ FAIL</span>';
                        failedTests++;
                        console.error('Test failed:', {
                            element: el,
                            expected: shouldFail ? 'error (?)' : expected || 'loaded value',
                            actual: actualText,
                            hasError,
                            hasLoaded
                        });
                    }
                }
            });

            // Update summary
            document.getElementById('total-tests').textContent = totalTests;
            document.getElementById('passed-tests').textContent = passedTests;
            document.getElementById('failed-tests').textContent = failedTests;

            const successRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';

            const overallStatus = document.getElementById('overall-status');
            if (successRate === 100) {
                overallStatus.innerHTML = '<span style="color: #28a745; font-weight: bold;">✓ ALL TESTS PASSED - 100% COMPATIBILITY</span>';
                overallStatus.parentElement.style.background = '#d4edda';
                overallStatus.parentElement.style.borderColor = '#28a745';
            } else if (successRate >= 95) {
                overallStatus.innerHTML = '<span style="color: #ffc107; font-weight: bold;">⚠ ' + successRate + '% PASSED - MOSTLY COMPATIBLE</span>';
                overallStatus.parentElement.style.background = '#fff3cd';
                overallStatus.parentElement.style.borderColor = '#ffc107';
            } else {
                overallStatus.innerHTML = '<span style="color: #dc3545; font-weight: bold;">✗ ' + successRate + '% PASSED - NEEDS FIXES</span>';
                overallStatus.parentElement.style.background = '#f8d7da';
                overallStatus.parentElement.style.borderColor = '#dc3545';
            }

            console.log('='.repeat(60));
            console.log('PM CONSTANTS LOADER - COMPATIBILITY TEST RESULTS');
            console.log('='.repeat(60));
            console.log(`Total Tests: ${totalTests}`);
            console.log(`Passed: ${passedTests}`);
            console.log(`Failed: ${failedTests}`);
            console.log(`Success Rate: ${successRate}%`);
            console.log('='.repeat(60));
        }
    </script>
</body>
</html>
