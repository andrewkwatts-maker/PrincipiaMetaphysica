<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Sections Page</title>

    <!-- MathJax -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- PM Scripts -->
    <script>window.PM_DEBUG = true;</script>
    <script src="js/pm-constants-loader.js"></script>
    <script src="js/pm-section-loader.js"></script>
    <script src="js/pm-section-renderer.js"></script>

    <style>
        body {
            font-family: 'Georgia', serif;
            padding: 2rem;
            background: #0a0a0f;
            color: #e0e0e0;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #8b7fff;
            border-bottom: 2px solid #8b7fff;
            padding-bottom: 0.5rem;
        }

        .test-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .test-section h2 {
            color: #ff7eb6;
            margin-top: 0;
        }

        .status {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            font-family: monospace;
        }

        .status.success {
            background: rgba(74, 222, 128, 0.2);
            border-left: 4px solid #4ade80;
            color: #4ade80;
        }

        .status.error {
            background: rgba(248, 113, 113, 0.2);
            border-left: 4px solid #f87171;
            color: #f87171;
        }

        .status.info {
            background: rgba(96, 165, 250, 0.2);
            border-left: 4px solid #60a5fa;
            color: #60a5fa;
        }

        button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #8b7fff, #ff7eb6);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: transform 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
        }

        #section-container {
            margin-top: 2rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            color: #1a1a1a;
        }

        pre {
            background: #1e1e2e;
            color: #cdd6f4;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <h1>Sections Page Test Suite</h1>

    <!-- Test 1: Load Metadata -->
    <div class="test-section">
        <h2>Test 1: Load Section Metadata</h2>
        <button onclick="test1()">Run Test</button>
        <div id="test1-result"></div>
    </div>

    <!-- Test 2: Load Single Section -->
    <div class="test-section">
        <h2>Test 2: Load Section 1 (Introduction)</h2>
        <button onclick="test2()">Run Test</button>
        <div id="test2-result"></div>
    </div>

    <!-- Test 3: Render pm-section Component -->
    <div class="test-section">
        <h2>Test 3: Render with pm-section Component</h2>
        <button onclick="test3()">Run Test</button>
        <div id="test3-result"></div>
        <pm-section section-id="1" id="pm-section-test"></pm-section>
    </div>

    <!-- Test 4: Render with PMSectionLoader -->
    <div class="test-section">
        <h2>Test 4: Render with PMSectionLoader</h2>
        <button onclick="test4()">Run Test</button>
        <div id="test4-result"></div>
        <div id="section-container"></div>
    </div>

    <!-- Test 5: Check MathJax -->
    <div class="test-section">
        <h2>Test 5: MathJax Rendering</h2>
        <button onclick="test5()">Run Test</button>
        <div id="test5-result"></div>
        <div id="math-test" style="padding: 1rem; background: white; margin-top: 1rem; border-radius: 4px; color: black;">
            Inline: $E = mc^2$ and display:
            $$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$
        </div>
    </div>

    <script>
        // Utility functions
        function showResult(testId, status, message, details = null) {
            const resultDiv = document.getElementById(`${testId}-result`);
            const statusClass = status === 'success' ? 'success' : status === 'error' ? 'error' : 'info';

            let html = `<div class="status ${statusClass}">${message}</div>`;
            if (details) {
                html += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }

            resultDiv.innerHTML = html;
        }

        // Test 1: Load metadata
        async function test1() {
            try {
                showResult('test1', 'info', 'Loading metadata...');

                const loaded = await PMSectionLoader.loadMetadata();
                const metadata = PMSectionLoader.getAllMetadata();
                const sectionCount = Object.keys(metadata).length;

                if (loaded && sectionCount > 0) {
                    showResult('test1', 'success',
                        `✓ Loaded ${sectionCount} sections`,
                        { sectionIds: Object.keys(metadata).slice(0, 10) }
                    );
                } else {
                    showResult('test1', 'error', 'Failed to load sections');
                }
            } catch (error) {
                showResult('test1', 'error', 'Error: ' + error.message);
            }
        }

        // Test 2: Load single section
        async function test2() {
            try {
                showResult('test2', 'info', 'Loading section 1...');

                const section = await PMSectionLoader.loadSection('1');

                if (section && section.title) {
                    showResult('test2', 'success',
                        `✓ Loaded section: ${section.title}`,
                        {
                            id: section.id,
                            title: section.title,
                            hasHTML: !!section.html,
                            hasMetadata: !!section.metadata,
                            formulaRefs: section.formulaRefs?.length || 0,
                            paramRefs: section.paramRefs?.length || 0
                        }
                    );
                } else {
                    showResult('test2', 'error', 'Failed to load section 1');
                }
            } catch (error) {
                showResult('test2', 'error', 'Error: ' + error.message);
            }
        }

        // Test 3: pm-section component
        async function test3() {
            try {
                showResult('test3', 'info', 'Checking pm-section component...');

                const component = document.getElementById('pm-section-test');

                if (customElements.get('pm-section')) {
                    // Wait for component to load
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    const hasContent = component.shadowRoot && component.shadowRoot.innerHTML.length > 100;

                    if (hasContent) {
                        showResult('test3', 'success',
                            '✓ pm-section component rendered successfully'
                        );
                    } else {
                        showResult('test3', 'error', 'Component exists but has no content');
                    }
                } else {
                    showResult('test3', 'error', 'pm-section component not registered');
                }
            } catch (error) {
                showResult('test3', 'error', 'Error: ' + error.message);
            }
        }

        // Test 4: PMSectionLoader rendering
        async function test4() {
            try {
                showResult('test4', 'info', 'Rendering with PMSectionLoader...');

                const section = await PMSectionLoader.loadSection('1');
                const container = document.getElementById('section-container');

                const rendered = PMSectionLoader.renderSection(container, section);

                if (rendered) {
                    // Trigger MathJax
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        await window.MathJax.typesetPromise([container]);
                    }

                    showResult('test4', 'success',
                        '✓ Section rendered successfully with PMSectionLoader'
                    );
                } else {
                    showResult('test4', 'error', 'Rendering failed');
                }
            } catch (error) {
                showResult('test4', 'error', 'Error: ' + error.message);
            }
        }

        // Test 5: MathJax
        async function test5() {
            try {
                showResult('test5', 'info', 'Checking MathJax...');

                if (window.MathJax) {
                    const mathDiv = document.getElementById('math-test');
                    await window.MathJax.typesetPromise([mathDiv]);

                    // Check if MathJax elements exist
                    const mjxElements = mathDiv.querySelectorAll('mjx-container');

                    if (mjxElements.length > 0) {
                        showResult('test5', 'success',
                            `✓ MathJax rendered ${mjxElements.length} expressions`
                        );
                    } else {
                        showResult('test5', 'error', 'MathJax loaded but no expressions rendered');
                    }
                } else {
                    showResult('test5', 'error', 'MathJax not loaded');
                }
            } catch (error) {
                showResult('test5', 'error', 'Error: ' + error.message);
            }
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            console.log('%cTest Suite Ready', 'color: #8b7fff; font-size: 20px; font-weight: bold');
            console.log('Run tests individually or use: runAllTests()');
        });

        async function runAllTests() {
            await test1();
            await new Promise(resolve => setTimeout(resolve, 500));
            await test2();
            await new Promise(resolve => setTimeout(resolve, 500));
            await test3();
            await new Promise(resolve => setTimeout(resolve, 500));
            await test4();
            await new Promise(resolve => setTimeout(resolve, 500));
            await test5();
        }

        window.runAllTests = runAllTests;
    </script>
</body>
</html>
