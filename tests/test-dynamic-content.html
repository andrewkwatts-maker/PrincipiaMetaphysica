<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Content Loading Test - Principia Metaphysica</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="/css/auth.css">
    <style>
        body {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 2rem 0;
            padding: 2rem;
            background: rgba(26, 31, 58, 0.6);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .topic-card {
            margin: 1rem 0;
            padding: 1.5rem;
            background: rgba(139, 127, 255, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }
        .subtopic-card {
            margin: 1rem 0 1rem 2rem;
            padding: 1rem;
            background: rgba(79, 172, 254, 0.05);
            border-radius: 6px;
            border-left: 2px solid var(--secondary-color);
        }
        .value-badge {
            display: inline-block;
            margin: 0.25rem;
            padding: 0.25rem 0.75rem;
            background: rgba(81, 207, 102, 0.2);
            border-radius: 12px;
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
        }
        .status-good {
            color: #51cf66;
        }
        .status-pending {
            color: #ff9800;
        }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
        }
    </style>
</head>
<body class="not-authenticated">
    <h1>Dynamic Content Loading Prototype</h1>
    <p>Testing centralized content management system with PM constants integration</p>

    <div class="test-section">
        <h2>Test 1: Load Section Metadata from PM.sections</h2>
        <div id="section-metadata-test"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Render Section Content Dynamically</h2>
        <div id="section-content-test"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Populate Values from PM Constants</h2>
        <div id="values-population-test"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Render Topics Recursively</h2>
        <div id="topics-test"></div>
    </div>

    <div class="test-section">
        <h2>Test 5: Validate Required Values Exist</h2>
        <div id="validation-test"></div>
    </div>

    <script src="../theory-constants-enhanced.js"></script>
    <script>
        /**
         * Dynamic Content Loading Prototype
         * Demonstrates loading section content from PM.sections metadata
         */

        // Test 1: Load section metadata
        function testSectionMetadata() {
            const container = document.getElementById('section-metadata-test');

            if (typeof PM === 'undefined' || !PM.sections) {
                container.innerHTML = '<p class="status-pending">❌ PM.sections not loaded</p>';
                return;
            }

            const sections = PM.sections;
            let html = '<p class="status-good">✅ PM.sections loaded successfully</p>';
            html += '<ul>';

            for (const [sectionId, sectionData] of Object.entries(sections)) {
                if (sectionId === 'meta') continue;
                html += `<li><strong>${sectionId}</strong>: ${sectionData.title}`;
                html += `<br><small>Pages: ${sectionData.pages?.length || 0}, Topics: ${sectionData.topic_count || 0}, Values: ${sectionData.values?.length || 0}</small>`;
                html += '</li>';
            }
            html += '</ul>';

            container.innerHTML = html;
        }

        // Test 2: Render section content
        function testSectionContent() {
            const container = document.getElementById('section-content-test');
            const sectionId = 'geometric_framework';

            if (!PM.sections || !PM.sections[sectionId]) {
                container.innerHTML = '<p class="status-pending">❌ Section not found</p>';
                return;
            }

            const section = PM.sections[sectionId];
            let html = `
                <h3>${section.title}</h3>
                <h4 style="color: var(--text-muted);">${section.subtitle || ''}</h4>
                <p>${section.content?.substring(0, 300)}...</p>
            `;

            container.innerHTML = html;
        }

        // Test 3: Populate values from PM constants
        function testValuesPopulation() {
            const container = document.getElementById('values-population-test');
            const sectionId = 'geometric_framework';

            if (!PM.sections || !PM.sections[sectionId]) {
                container.innerHTML = '<p class="status-pending">❌ Section not found</p>';
                return;
            }

            const section = PM.sections[sectionId];
            const requiredValues = section.required_values || [];

            let html = '<h4>Required Values for Geometric Framework:</h4>';
            html += '<div>';

            requiredValues.forEach(valueId => {
                const [category, param] = valueId.split('.');
                const value = PM[category]?.[param];

                if (value) {
                    const display = value.display || value.value;
                    const unit = value.unit || '';
                    html += `<span class="value-badge status-good">${valueId} = ${display} ${unit}</span>`;
                } else {
                    html += `<span class="value-badge status-pending">${valueId} = MISSING</span>`;
                }
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Test 4: Render topics recursively (would need topics data from SECTIONS dict)
        function testTopicsRendering() {
            const container = document.getElementById('topics-test');

            // For now, show status since topics aren't in PM.sections yet
            // In full implementation, we'd load from sections_content.py via JSON
            let html = '<p class="status-pending">⚠️ Topics rendering requires full sections_content.py integration</p>';
            html += '<p><small>Topics are defined in Python but not yet exported to JavaScript constants.</small></p>';
            html += '<p><small>Next step: Export topics structure to theory-constants-enhanced.js</small></p>';

            container.innerHTML = html;
        }

        // Test 5: Validate required values exist
        function testValidation() {
            const container = document.getElementById('validation-test');

            if (!PM.sections) {
                container.innerHTML = '<p class="status-pending">❌ PM.sections not loaded</p>';
                return;
            }

            let html = '<h4>Validation Results:</h4>';
            let totalRequired = 0;
            let totalFound = 0;
            let missing = [];

            for (const [sectionId, sectionData] of Object.entries(PM.sections)) {
                if (sectionId === 'meta') continue;

                const requiredValues = sectionData.required_values || [];
                totalRequired += requiredValues.length;

                requiredValues.forEach(valueId => {
                    const [category, param] = valueId.split('.');
                    if (PM[category]?.[param]) {
                        totalFound++;
                    } else {
                        missing.push(`${sectionId}: ${valueId}`);
                    }
                });
            }

            const percentage = totalRequired > 0 ? (totalFound / totalRequired * 100).toFixed(1) : 0;
            const status = percentage === 100 ? 'status-good' : 'status-pending';

            html += `<p class="${status}">`;
            html += `<strong>${totalFound}/${totalRequired}</strong> required values found (${percentage}%)`;
            html += '</p>';

            if (missing.length > 0) {
                html += '<details>';
                html += `<summary>Missing Values (${missing.length})</summary>`;
                html += '<ul>';
                missing.forEach(m => html += `<li>${m}</li>`);
                html += '</ul>';
                html += '</details>';
            }

            container.innerHTML = html;
        }

        // Run all tests on load
        window.addEventListener('DOMContentLoaded', () => {
            testSectionMetadata();
            testSectionContent();
            testValuesPopulation();
            testTopicsRendering();
            testValidation();
        });
    </script>

  <script type="module">
    import { setupAuthGuard } from '/js/auth-guard.js';
    setupAuthGuard('tests-test-dynamic-content');
  </script>
</body>
</html>
