#!/usr/bin/env python3
"""
PRINCIPIA METAPHYSICA - Repository Cleanup & Zenodo Packaging
==============================================================

This script:
1. Cleans up the root folder by deleting temporary files
2. Removes deprecated simulations and old versions
3. Creates a clean Zenodo submission package

Copyright (c) 2025-2026 Andrew Keith Watts. All rights reserved.

Dedicated To:
    My Wife: Elizabeth May Watts
    Our Messiah: Jesus Of Nazareth
"""

import os
import shutil
import zipfile
import json
import hashlib
from pathlib import Path
from datetime import datetime
from typing import Set, List

# Repository root
ROOT = Path(__file__).parent.parent
ZENODO_OUTPUT = ROOT / "zenodo_submission"

# ============================================================
# FILES TO KEEP IN ROOT (everything else gets deleted/moved)
# ============================================================
ROOT_KEEPERS = {
    # Essential files
    "config.py",
    "run_all_simulations.py",
    "requirements.txt",
    "CITATION.cff",
    "README.md",
    "LICENSE",
    "LICENSE_PM.txt",
    "PROVENANCE.md",
    "ARCHITECTURE.md",
    ".gitignore",
    ".nojekyll",
    "CNAME",
    "_redirects",
    # Essential folders (handled separately)
}

# Folders to KEEP
KEEP_FOLDERS = {
    ".git",
    ".claude",
    "AutoGenerated",
    "components",
    "css",
    "data",
    "diagrams",
    "docs",
    "examples",
    "fonts",
    "foundations",
    "images",
    "js",
    "simulations",
    "tests",
    "tools",
    "zenodo_package",
}

# Folders to DELETE entirely
DELETE_FOLDERS = {
    "__pycache__",
    ".pytest_cache",
    "backup_before_link_fix_20251229_115342",
    "analysis",
    "content-templates",
    "firebase-backup",
    "core",  # If deprecated
}

# File patterns to DELETE from root
DELETE_PATTERNS = {
    "*.pyc",
    "*.log",
    "*.tmp",
    "*.bak",
}

# Deprecated simulation patterns (files to remove from simulations/)
DEPRECATED_SIM_PATTERNS = [
    "*_v12_*.py",
    "*_v13_*.py",
    "*_v11_*.py",
    "*_v10_*.py",
    "test_*.py",  # Test files in wrong location
]

# ============================================================
# ZENODO PACKAGE STRUCTURE
# ============================================================
ZENODO_STRUCTURE = {
    "01_Paper": [
        "principia-metaphysica-paper.html",
        "css/",
        "js/",
        "fonts/",
        "images/",
    ],
    "02_Simulations": [
        "simulations/v16/",
        "simulations/base/",
        "config.py",
        "run_all_simulations.py",
        "requirements.txt",
    ],
    "03_Data": [
        "AutoGenerated/theory_output.json",
        "AutoGenerated/formulas.json",
        "AutoGenerated/parameters.json",
        "data/",
    ],
    "04_Documentation": [
        "README.md",
        "ARCHITECTURE.md",
        "PROVENANCE.md",
        "docs/",
    ],
    "05_Verification": [
        "simulations/AutoGenerated/certificates/",
        "simulations/AutoGenerated/formal_proof_manifest.json",
        "simulations/AutoGenerated/Wolfram_Tree_Trace.json",
    ],
    "06_Tests": [
        "tests/",
    ],
}


def get_file_hash(filepath: Path) -> str:
    """Generate SHA-256 hash of a file."""
    sha256 = hashlib.sha256()
    with open(filepath, 'rb') as f:
        for chunk in iter(lambda: f.read(8192), b''):
            sha256.update(chunk)
    return sha256.hexdigest()


def cleanup_root_folder():
    """Remove temporary files from root folder."""
    print("\n" + "=" * 60)
    print("PHASE 1: Cleaning Root Folder")
    print("=" * 60)

    deleted_files = []
    deleted_folders = []

    # Delete entire folders
    for folder_name in DELETE_FOLDERS:
        folder_path = ROOT / folder_name
        if folder_path.exists() and folder_path.is_dir():
            print(f"  [DELETE FOLDER] {folder_name}/")
            shutil.rmtree(folder_path)
            deleted_folders.append(folder_name)

    # Delete temp files from root
    for item in ROOT.iterdir():
        if item.is_file():
            # Keep essential files
            if item.name in ROOT_KEEPERS:
                continue

            # Delete Python scripts that aren't essential
            if item.suffix == ".py" and item.name not in ROOT_KEEPERS:
                print(f"  [DELETE] {item.name}")
                item.unlink()
                deleted_files.append(item.name)
                continue

            # Delete markdown reports (not essential docs)
            if item.suffix == ".md" and item.name not in ROOT_KEEPERS:
                print(f"  [DELETE] {item.name}")
                item.unlink()
                deleted_files.append(item.name)
                continue

            # Delete temp JSON files
            if item.suffix == ".json" and item.name not in ROOT_KEEPERS:
                print(f"  [DELETE] {item.name}")
                item.unlink()
                deleted_files.append(item.name)
                continue

            # Delete txt files (except essential)
            if item.suffix == ".txt" and item.name not in ROOT_KEEPERS:
                print(f"  [DELETE] {item.name}")
                item.unlink()
                deleted_files.append(item.name)
                continue

    # Clean __pycache__ from all subdirectories
    for pycache in ROOT.rglob("__pycache__"):
        if pycache.is_dir():
            print(f"  [DELETE] {pycache.relative_to(ROOT)}/")
            shutil.rmtree(pycache)
            deleted_folders.append(str(pycache.relative_to(ROOT)))

    # Clean .pyc files
    for pyc in ROOT.rglob("*.pyc"):
        pyc.unlink()

    print(f"\n  [OK] Deleted {len(deleted_files)} files")
    print(f"  [OK] Deleted {len(deleted_folders)} folders")

    return deleted_files, deleted_folders


def cleanup_deprecated_simulations():
    """Remove deprecated simulation versions."""
    print("\n" + "=" * 60)
    print("PHASE 2: Removing Deprecated Simulations")
    print("=" * 60)

    sims_dir = ROOT / "simulations"
    deleted = []

    if not sims_dir.exists():
        print("  [SKIP] simulations/ folder not found")
        return deleted

    # Find deprecated files
    for pattern in DEPRECATED_SIM_PATTERNS:
        for filepath in sims_dir.rglob(pattern):
            # Don't delete from v16 folder
            if "v16" in str(filepath):
                continue
            # Don't delete from base folder
            if "base" in str(filepath):
                continue

            rel_path = filepath.relative_to(ROOT)
            print(f"  [DELETE] {rel_path}")
            filepath.unlink()
            deleted.append(str(rel_path))

    # Remove deprecated folder if exists
    deprecated_dir = sims_dir / "deprecated"
    if deprecated_dir.exists():
        print(f"  [DELETE FOLDER] simulations/deprecated/")
        shutil.rmtree(deprecated_dir)
        deleted.append("simulations/deprecated/")

    # Remove adhoc folder if exists
    adhoc_dir = sims_dir / "adhoc"
    if adhoc_dir.exists():
        print(f"  [DELETE FOLDER] simulations/adhoc/")
        shutil.rmtree(adhoc_dir)
        deleted.append("simulations/adhoc/")

    print(f"\n  [OK] Removed {len(deleted)} deprecated items")
    return deleted


def create_zenodo_package():
    """Create a clean Zenodo submission package."""
    print("\n" + "=" * 60)
    print("PHASE 3: Creating Zenodo Package")
    print("=" * 60)

    # Clean output directory
    if ZENODO_OUTPUT.exists():
        shutil.rmtree(ZENODO_OUTPUT)
    ZENODO_OUTPUT.mkdir(parents=True)

    file_manifest = []

    for folder_name, contents in ZENODO_STRUCTURE.items():
        target_dir = ZENODO_OUTPUT / folder_name
        target_dir.mkdir(parents=True, exist_ok=True)
        print(f"\n  Creating {folder_name}/")

        for item in contents:
            source = ROOT / item

            if not source.exists():
                print(f"    [SKIP] {item} (not found)")
                continue

            if source.is_dir():
                # Copy entire directory
                dest = target_dir / source.name
                shutil.copytree(source, dest, ignore=shutil.ignore_patterns(
                    '__pycache__', '*.pyc', '.git', '.DS_Store'
                ))
                print(f"    [COPY DIR] {item}")

                # Add files to manifest
                for f in dest.rglob("*"):
                    if f.is_file():
                        rel = f.relative_to(ZENODO_OUTPUT)
                        file_manifest.append({
                            "path": str(rel),
                            "size": f.stat().st_size,
                            "sha256": get_file_hash(f)
                        })
            else:
                # Copy single file
                dest = target_dir / source.name
                shutil.copy2(source, dest)
                print(f"    [COPY] {item}")

                rel = dest.relative_to(ZENODO_OUTPUT)
                file_manifest.append({
                    "path": str(rel),
                    "size": dest.stat().st_size,
                    "sha256": get_file_hash(dest)
                })

    # Create manifest.json
    manifest = {
        "title": "Principia Metaphysica v16.2",
        "author": "Andrew Keith Watts",
        "created": datetime.now().isoformat(),
        "description": "A unified geometric framework deriving Standard Model parameters from G2 manifold topology",
        "version": "16.2",
        "total_files": len(file_manifest),
        "files": file_manifest
    }

    manifest_path = ZENODO_OUTPUT / "MANIFEST.json"
    with open(manifest_path, 'w') as f:
        json.dump(manifest, f, indent=2)
    print(f"\n  [CREATE] MANIFEST.json ({len(file_manifest)} files)")

    # Create README for Zenodo
    readme_content = """# Principia Metaphysica v16.2 - Zenodo Submission

## A First-Principles Geometric Theory

A unified geometric framework deriving all 58 Standard Model parameters
from a single G₂ manifold with minimal calibration (1 fitted parameter: α_GUT).

### Author
Andrew Keith Watts
Independent Physics Researcher - Brisbane, Australia

### Repository
https://github.com/andrewkwatts-maker/PrincipiaMetaphysica

### Package Contents

- **01_Paper/** - The complete paper with interactive formula rendering
- **02_Simulations/** - v16 simulation suite (34 validated scripts)
- **03_Data/** - Generated theory output and parameter database
- **04_Documentation/** - Architecture and provenance documentation
- **05_Verification/** - Wolfram certificates and formal proofs
- **06_Tests/** - Validation and falsifiability tests

### Quick Start

1. Install dependencies: `pip install -r 02_Simulations/requirements.txt`
2. Run simulations: `python 02_Simulations/run_all_simulations.py`
3. Open paper: `01_Paper/principia-metaphysica-paper.html`

### Verification

All 35 formal proofs can be verified in Wolfram Language using the
certificates in `05_Verification/certificates/`.

### License

Copyright (c) 2025-2026 Andrew Keith Watts. All rights reserved.
Non-commercial use permitted with attribution.

### Dedication

To my wife Elizabeth May Watts, and our Messiah Jesus of Nazareth.
"""

    readme_path = ZENODO_OUTPUT / "README.md"
    with open(readme_path, 'w') as f:
        f.write(readme_content)
    print("  [CREATE] README.md")

    # Create ZIP archive
    zip_name = f"Principia_Metaphysica_v16.2_{datetime.now().strftime('%Y%m%d')}.zip"
    zip_path = ROOT / zip_name

    print(f"\n  Creating ZIP: {zip_name}")
    with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
        for root_dir, dirs, files in os.walk(ZENODO_OUTPUT):
            # Skip __pycache__
            dirs[:] = [d for d in dirs if d != '__pycache__']

            for file in files:
                file_path = Path(root_dir) / file
                arc_name = file_path.relative_to(ZENODO_OUTPUT)
                zipf.write(file_path, arc_name)

    zip_size = zip_path.stat().st_size / (1024 * 1024)
    print(f"  [OK] Created {zip_name} ({zip_size:.1f} MB)")

    return str(zip_path)


def main():
    """Main entry point."""
    print("=" * 60)
    print("PRINCIPIA METAPHYSICA - Repository Cleanup & Packaging")
    print("=" * 60)
    print(f"Root: {ROOT}")
    print(f"Output: {ZENODO_OUTPUT}")

    # Phase 1: Clean root folder
    deleted_files, deleted_folders = cleanup_root_folder()

    # Phase 2: Remove deprecated simulations
    deprecated = cleanup_deprecated_simulations()

    # Phase 3: Create Zenodo package
    zip_path = create_zenodo_package()

    # Summary
    print("\n" + "=" * 60)
    print("SUMMARY")
    print("=" * 60)
    print(f"  Files deleted from root: {len(deleted_files)}")
    print(f"  Folders deleted: {len(deleted_folders)}")
    print(f"  Deprecated sims removed: {len(deprecated)}")
    print(f"  Zenodo package: {zip_path}")
    print("\n[OK] Cleanup complete!")


if __name__ == "__main__":
    main()
