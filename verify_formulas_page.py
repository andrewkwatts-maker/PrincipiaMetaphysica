#!/usr/bin/env python3
"""
Verify formulas page functionality
Checks:
1. All formulas load from theory_output.json
2. Formula filtering works
3. LaTeX renders correctly
4. Derivation steps and terms display properly
"""

import json
import sys
from pathlib import Path

def verify_formulas_page():
    """Verify formulas page has all required data"""

    base_path = Path(__file__).parent
    formulas_json = base_path / 'AutoGenerated' / 'formulas.json'
    theory_output = base_path / 'AutoGenerated' / 'theory_output.json'

    print("=" * 80)
    print("FORMULAS PAGE VERIFICATION")
    print("=" * 80)

    # Check formulas.json
    if formulas_json.exists():
        with open(formulas_json, 'r', encoding='utf-8') as f:
            formulas_data = json.load(f)

        formulas_dict = formulas_data.get('formulas', {})
        print(f"\n‚úì formulas.json exists")
        print(f"  - Version: {formulas_data.get('version', 'unknown')}")
        print(f"  - Count: {formulas_data.get('count', len(formulas_dict))} formulas")
    else:
        print(f"\n‚úó formulas.json NOT FOUND at {formulas_json}")
        formulas_dict = {}

    # Check theory_output.json
    if theory_output.exists():
        with open(theory_output, 'r', encoding='utf-8') as f:
            theory_data = json.load(f)

        theory_formulas = theory_data.get('formulas', {})
        print(f"\n‚úì theory_output.json exists")
        print(f"  - Contains formulas: {len(theory_formulas)} entries")
    else:
        print(f"\n‚úó theory_output.json NOT FOUND at {theory_output}")
        theory_formulas = {}

    # Use whichever source has formulas
    all_formulas = formulas_dict or theory_formulas

    if not all_formulas:
        print("\n‚úó ERROR: No formulas found in either file!")
        return False

    print(f"\n{'=' * 80}")
    print(f"ANALYZING {len(all_formulas)} FORMULAS")
    print(f"{'=' * 80}")

    # Statistics
    stats = {
        'total': len(all_formulas),
        'with_latex': 0,
        'with_terms': 0,
        'with_derivation': 0,
        'with_description': 0,
        'categories': {},
        'sections': {},
        'missing_latex': [],
        'missing_terms': [],
        'missing_derivation': []
    }

    for formula_id, formula in all_formulas.items():
        # Count LaTeX
        if formula.get('latex'):
            stats['with_latex'] += 1
        else:
            stats['missing_latex'].append(formula_id)

        # Count terms
        terms = formula.get('terms', {})
        if terms and isinstance(terms, dict) and len(terms) > 0:
            stats['with_terms'] += 1
        else:
            stats['missing_terms'].append(formula_id)

        # Count derivation
        derivation = formula.get('derivation', {})
        if derivation and isinstance(derivation, dict):
            steps = derivation.get('steps', [])
            if steps and len(steps) > 0:
                stats['with_derivation'] += 1
            else:
                stats['missing_derivation'].append(formula_id)
        else:
            stats['missing_derivation'].append(formula_id)

        # Count descriptions
        if formula.get('description'):
            stats['with_description'] += 1

        # Count categories
        category = formula.get('category', 'UNCATEGORIZED')
        stats['categories'][category] = stats['categories'].get(category, 0) + 1

        # Count sections
        section = formula.get('section', 'NO SECTION')
        stats['sections'][section] = stats['sections'].get(section, 0) + 1

    # Print results
    print(f"\nüìä STATISTICS:")
    print(f"  Total formulas: {stats['total']}")
    print(f"  With LaTeX: {stats['with_latex']} ({stats['with_latex']/stats['total']*100:.1f}%)")
    print(f"  With terms: {stats['with_terms']} ({stats['with_terms']/stats['total']*100:.1f}%)")
    print(f"  With derivation: {stats['with_derivation']} ({stats['with_derivation']/stats['total']*100:.1f}%)")
    print(f"  With description: {stats['with_description']} ({stats['with_description']/stats['total']*100:.1f}%)")

    print(f"\nüìÅ CATEGORIES:")
    for cat, count in sorted(stats['categories'].items()):
        print(f"  {cat}: {count} formulas")

    print(f"\nüìë SECTIONS:")
    for sec, count in sorted(stats['sections'].items()):
        print(f"  {sec}: {count} formulas")

    # Warnings
    issues = []

    if stats['missing_latex']:
        issues.append(f"‚ö†Ô∏è  {len(stats['missing_latex'])} formulas missing LaTeX")
        if len(stats['missing_latex']) <= 10:
            print(f"\n  Missing LaTeX: {', '.join(stats['missing_latex'][:10])}")

    if stats['missing_terms']:
        issues.append(f"‚ö†Ô∏è  {len(stats['missing_terms'])} formulas missing terms")

    if stats['missing_derivation']:
        issues.append(f"‚ö†Ô∏è  {len(stats['missing_derivation'])} formulas missing derivation")

    if issues:
        print(f"\n{'=' * 80}")
        print("ISSUES FOUND:")
        for issue in issues:
            print(f"  {issue}")

    # Test filtering
    print(f"\n{'=' * 80}")
    print("FILTER TESTS:")
    print(f"{'=' * 80}")

    # Test category filter
    theory_formulas_count = sum(1 for f in all_formulas.values() if f.get('category') == 'THEORY')
    print(f"‚úì Category filter 'THEORY': {theory_formulas_count} formulas")

    # Test section filter
    section_2_count = sum(1 for f in all_formulas.values() if str(f.get('section', '')).startswith('2'))
    print(f"‚úì Section filter '2': {section_2_count} formulas")

    # Test search
    generation_count = sum(1 for f in all_formulas.values()
                          if 'generation' in str(f.get('id', '')).lower()
                          or 'generation' in str(f.get('label', '')).lower()
                          or 'generation' in str(f.get('description', '')).lower())
    print(f"‚úì Search 'generation': {generation_count} formulas")

    print(f"\n{'=' * 80}")
    print("‚úÖ VERIFICATION COMPLETE")
    print(f"{'=' * 80}")

    return True

if __name__ == '__main__':
    success = verify_formulas_page()
    sys.exit(0 if success else 1)
