# PM Loader System - Debug Guide

## Overview

The Principia Metaphysica project uses a dynamic loader system to fetch simulation data, formulas, and constants from JSON files generated by Python simulations. This guide explains how the loaders work and how to debug loading issues.

## Loader Files

### 1. `pm-constants-loader.js`
- **Purpose**: Loads simulation results, parameters, statistics, and dimensions
- **Exposes**: `window.PM` object with all simulation data
- **Data Sources**:
  - Primary: `theory_output.json` (unified file)
  - Fallback: Individual JSON files in `AutoGenerated/json/`
    - `simulations.json`
    - `parameters.json`
    - `statistics.json`

### 2. `pm-formula-loader.js`
- **Purpose**: Loads mathematical formulas and equations
- **Exposes**: `window.PMFormulaLoader` class and `window.PM_FORMULAS` object
- **Data Sources**:
  - Primary: `theory_output.json` (unified file)
  - Fallback: `AutoGenerated/json/formulas.json`

### 3. `pm-section-renderer.js`
- **Purpose**: Renders paper sections with formulas and parameters
- **Exposes**: `<pm-section>` custom HTML element
- **Data Sources**:
  - Primary: `AutoGenerated/json/sections.json`
  - Fallback: `theory_output.json`

## How the Loaders Work

### Multi-Path Loading Strategy

All loaders try multiple paths in order:

1. `""` - Root directory (where HTML file is located)
2. `"AutoGenerated/"` - AutoGenerated folder
3. `"../"` - Parent directory (for files in subdirectories)
4. `"../AutoGenerated/"` - Parent's AutoGenerated folder
5. `"../../"` - Two levels up
6. `"../../AutoGenerated/"` - Two levels up AutoGenerated

### Loading Sequence

```
1. Try theory_output.json (unified file)
   â”œâ”€ theory_output.json
   â”œâ”€ AutoGenerated/theory_output.json
   â”œâ”€ ../theory_output.json
   â””â”€ etc.

2. Fall back to individual JSON files
   â”œâ”€ AutoGenerated/json/simulations.json
   â”œâ”€ AutoGenerated/json/formulas.json
   â”œâ”€ AutoGenerated/json/parameters.json
   â””â”€ AutoGenerated/json/statistics.json
```

## Global Objects Exposed

After successful loading, the following objects are available:

### `window.PM`
Main interface for accessing data:

```javascript
// Get any value by path
PM.get('simulations.proton_decay.tau_p_years')
PM.get('parameters.topology.B2')
PM.get('dimensions.D_BULK')

// Get simulation data (shorthand)
PM.simulation('proton_decay.tau_p_years')

// Get formula
PM.formula('generation-number')

// Properties
PM.version          // Version string
PM.formulas         // All formulas
PM.statistics       // Statistics data
PM.allPassed        // Boolean - all validations passed
PM._loaded          // Boolean - is data loaded?
PM._error           // Error message if loading failed
```

### `window.PM_DATA`
Raw data object (for debugging):

```javascript
{
  version: "13.0",
  simulations: { ... },
  formulas: { ... },
  parameters: { ... },
  statistics: { ... }
}
```

### `window.PM_FORMULAS`
Direct access to formulas:

```javascript
{
  "generation-number": {
    id: "generation-number",
    html: "...",
    latex: "...",
    description: "...",
    ...
  },
  ...
}
```

### `window.PMFormulaLoader`
Class for formula operations:

```javascript
// Get formula by ID
PMFormulaLoader.get('generation-number')

// Get all formulas
PMFormulaLoader.getAll()

// Get formulas by category
PMFormulaLoader.getByCategory('THEORY')

// Search formulas
PMFormulaLoader.search('proton decay')

// Get stats
PMFormulaLoader.getStats()

// Render formula into element
PMFormulaLoader.render(element, 'generation-number', { showLabel: true })
```

## HTML Usage

### Data Attributes for Constants/Parameters

**Method 1: `data-pm-value`** (recommended)
```html
<span data-pm-value="simulations.proton_decay.tau_p_years"></span>
<span data-pm-value="parameters.topology.B2"></span>
<span data-pm-value="dimensions.D_BULK"></span>

<!-- With formatting -->
<span data-pm-value="simulations.wz_evolution.m_W_GeV" data-format="fixed:3"></span>
<span data-pm-value="simulations.proton_decay.sigma_deviation" data-format="scientific:2"></span>
```

**Method 2: `data-category` + `data-param`**
```html
<span data-category="simulations" data-param="proton_decay.tau_p_years"></span>
<span data-category="parameters" data-param="topology.B2"></span>
```

### Data Attributes for Formulas

```html
<!-- Auto-populated with formula HTML -->
<div data-formula-id="generation-number"></div>

<!-- Manual content with formula metadata -->
<div data-formula-id="generation-number">
  Custom content here (formula metadata will be added as tooltip)
</div>
```

### Formatting Options

Use `data-format` attribute:

- `"scientific:N"` - Scientific notation with N decimals (e.g., `1.23e+10`)
- `"fixed:N"` - Fixed decimals (e.g., `123.456`)
- `"percent"` - As percentage (e.g., `12.3%`)
- `"integer"` - Rounded to integer
- Auto-format (default) - Scientific for large/small numbers, fixed for normal

## Debugging

### Enable Debug Mode

In browser console or before loading scripts:
```javascript
window.PM_DEBUG = true;
```

This enables verbose logging of all path attempts.

### Check Loader Status

```javascript
// PM Constants Loader
console.log('PM loaded:', window.PM._loaded);
console.log('PM error:', window.PM._error);
console.log('PM version:', window.PM.version);

// PM Formula Loader
console.log('Formulas loaded:', window.PMFormulaLoader._loaded);
console.log('Formula count:', Object.keys(window.PM_FORMULAS || {}).length);
```

### Console Messages

The loaders provide colored console messages:

- ðŸŸ¢ **Green** = Success (loaded from specific path)
- ðŸŸ¡ **Orange/Yellow** = Warning (trying fallback)
- ðŸ”´ **Red** = Error (failed to load)

Example success message:
```
PM: Successfully loaded from theory_output.json
  Version: 13.0
  Simulations: 12
  Formulas: 145
  Parameters: 23
```

Example error message:
```
PM: Failed to load data!
  Tried paths: ["theory_output.json", "AutoGenerated/theory_output.json", ...]

  SOLUTIONS:
  1. Run: python run_all_simulations.py --export
  2. Check that theory_output.json or AutoGenerated/json/*.json exist
  3. If using file:// protocol, you may need to run a local web server
     Try: python -m http.server 8000
```

### Test Page

Open `test-loaders.html` in your browser to:
- Check loader status
- Test data loading
- View console messages
- Inspect global objects
- Test JavaScript API

## Common Issues

### Issue 1: CORS Errors with `file://` Protocol

**Symptom**:
```
Access to fetch at 'file:///...' has been blocked by CORS policy
```

**Solution**:
Run a local web server:
```bash
# Python 3
python -m http.server 8000

# Python 2
python -m SimpleHTTPServer 8000

# Node.js (if http-server is installed)
npx http-server -p 8000
```

Then access via `http://localhost:8000/` instead of `file://`

### Issue 2: Data Not Loading

**Symptom**: Elements show `...` or `?`

**Checklist**:
1. âœ… Run `python run_all_simulations.py --export` to generate JSON files
2. âœ… Check that `theory_output.json` or `AutoGenerated/json/*.json` exist
3. âœ… Open browser console and look for error messages
4. âœ… Enable debug mode: `window.PM_DEBUG = true`
5. âœ… Check network tab in browser DevTools for failed requests

### Issue 3: Formulas Not Rendering

**Symptom**: Formulas show as `?` or error messages

**Checklist**:
1. âœ… Check `window.PM_FORMULAS` exists: `console.log(window.PM_FORMULAS)`
2. âœ… Verify formula ID exists: `console.log(PMFormulaLoader.get('your-formula-id'))`
3. âœ… Check console for "Formula not found" errors
4. âœ… Verify formulas.json was generated: `ls AutoGenerated/json/formulas.json`

### Issue 4: Wrong Values Displayed

**Symptom**: Old or incorrect values shown

**Solution**:
1. Re-run simulations: `python run_all_simulations.py --export`
2. Hard refresh browser: `Ctrl+Shift+R` (Windows/Linux) or `Cmd+Shift+R` (Mac)
3. Clear cache: `Ctrl+Shift+Delete`
4. Verify JSON files have new timestamps: `ls -la AutoGenerated/json/`

### Issue 5: Path Not Found Errors

**Symptom**:
```
PM: Path not found: simulations.my_simulation.value
```

**Debug**:
```javascript
// Check what's in simulations
console.log(Object.keys(window.PM_DATA.simulations));

// Check specific simulation
console.log(window.PM_DATA.simulations.my_simulation);

// Try direct access
console.log(window.PM.get('simulations.my_simulation'));
```

## Performance Notes

### Caching

- Data is fetched **once per page load**
- Subsequent `PM.get()` calls use cached data
- DOM updates are efficient (only changed elements)

### Loading Order

Loaders run automatically on:
```javascript
document.addEventListener('DOMContentLoaded', loadConstants);
```

To ensure data is loaded before your code runs:
```javascript
// Wait for PM to load
await window.PM.load();

// Or use callback
window.PM.load().then(() => {
  console.log('Data loaded!');
  // Your code here
});
```

### Lazy Loading

Formulas are loaded once and cached. To force reload:
```javascript
window.PM._loaded = false;
window.PM._loading = null;
await window.PM.load();
```

## File Structure

```
PrincipiaMetaphysica/
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ pm-constants-loader.js     # Main data loader
â”‚   â”œâ”€â”€ pm-formula-loader.js       # Formula loader
â”‚   â”œâ”€â”€ pm-section-renderer.js     # Section renderer
â”‚   â””â”€â”€ pm-validation-stats.js     # Statistics calculator
â”œâ”€â”€ AutoGenerated/
â”‚   â”œâ”€â”€ theory_output.json         # Unified output (primary)
â”‚   â””â”€â”€ json/
â”‚       â”œâ”€â”€ simulations.json       # Simulation results
â”‚       â”œâ”€â”€ formulas.json          # Mathematical formulas
â”‚       â”œâ”€â”€ parameters.json        # Theory parameters
â”‚       â”œâ”€â”€ sections.json          # Paper sections
â”‚       â”œâ”€â”€ references.json        # Bibliography
â”‚       â””â”€â”€ statistics.json        # Summary statistics
â”œâ”€â”€ test-loaders.html              # Loader test page
â””â”€â”€ test-pm-stats.html             # Statistics test page
```

## Best Practices

1. **Always regenerate JSON before testing**:
   ```bash
   python run_all_simulations.py --export
   ```

2. **Use debug mode during development**:
   ```javascript
   window.PM_DEBUG = true;
   ```

3. **Check console messages** - they contain helpful path information

4. **Use test pages** to verify loaders work before integrating

5. **Use `data-pm-value`** instead of `data-category`+`data-param` for cleaner HTML

6. **Use semantic paths**:
   - Good: `simulations.proton_decay.tau_p_years`
   - Bad: Hardcoded values in HTML

7. **Handle missing data gracefully** - elements show `?` automatically

8. **Use formatting attributes** for consistent number display

## Version History

- **v2.1.0** (2025-12-25)
  - Added multi-path loading strategy
  - Added fallback to individual JSON files
  - Added better error messages
  - Added debug mode support
  - Added global object exposure (PM_DATA, PM_FORMULAS)
  - Added case-insensitive path lookup
  - Added parameter aliases

- **v2.0.0** (2025-12-24)
  - Complete rewrite with dynamic loading
  - Single source of truth from theory_output.json
  - Auto-updating DOM elements

- **v1.0.0** (2025-12-20)
  - Initial release
  - Hardcoded values

## Support

If loaders aren't working:

1. Check this debug guide
2. Review console messages
3. Use test-loaders.html
4. Enable debug mode
5. Verify JSON files exist and are up-to-date

For questions or issues, check the console output first - it usually contains the solution!
