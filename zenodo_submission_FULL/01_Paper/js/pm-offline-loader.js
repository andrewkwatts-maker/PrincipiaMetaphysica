/**
 * PRINCIPIA METAPHYSICA - Offline Data Loader
 * ============================================
 * Replaces Firebase with local JSON file loading for offline use.
 * Copyright (c) 2025-2026 Andrew Keith Watts. All rights reserved.
 */

window.PM = window.PM || {};
window.PM_OFFLINE = true;

PM.offlineData = {
    formulas: null,
    parameters: null,
    sections: null,
    theory: null,
    loaded: false
};

PM.getBasePath = function() {
    const path = window.location.pathname;
    if (path.includes('/01_Paper/')) return '../03_Data/AutoGenerated/';
    if (path.includes('/Pages/')) return '../AutoGenerated/';
    return './AutoGenerated/';
};

PM.loadJSON = async function(filename) {
    const basePath = PM.getBasePath();
    try {
        const response = await fetch(basePath + filename);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    } catch (error) {
        console.warn(`[PM] Could not load ${filename}:`, error.message);
        return null;
    }
};

PM.initOffline = async function() {
    if (PM.offlineData.loaded) return;
    console.log('[PM] Loading offline data...');

    const [formulas, parameters, sections, theory] = await Promise.all([
        PM.loadJSON('formulas.json'),
        PM.loadJSON('parameters.json'),
        PM.loadJSON('sections.json'),
        PM.loadJSON('theory_output.json')
    ]);

    PM.offlineData.formulas = formulas;
    PM.offlineData.parameters = parameters;
    PM.offlineData.sections = sections;
    PM.offlineData.theory = theory;
    PM.offlineData.loaded = true;

    console.log('[PM] Offline data loaded');
    window.dispatchEvent(new CustomEvent('pm-data-ready'));
};

PM.getFormula = function(id) {
    if (!PM.offlineData.formulas) return null;
    const formulas = PM.offlineData.formulas.formulas || PM.offlineData.formulas;
    return formulas.find(f => f.id === id || f.formulaId === id);
};

PM.getParameter = function(path) {
    if (!PM.offlineData.parameters) return null;
    const params = PM.offlineData.parameters.parameters || PM.offlineData.parameters;
    return params.find(p => p.path === path || p.id === path || p.symbol === path);
};

PM.get = function(key) {
    const param = PM.getParameter(key);
    if (param) return { value: param.value || param.pmPredicted, units: param.units, name: param.name };
    return null;
};

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => PM.initOffline());
} else {
    PM.initOffline();
}
