# Firebase Upload Scripts - Complete Guide

## Quick Commands

```bash
# Smart sync with diff and version history (RECOMMENDED)
node scripts/firebase-helper.js sync

# Full upload (all data: constants, formulas, pages)
node scripts/firebase-helper.js upload

# Validated production push
node scripts/firebase-helper.js validate

# Test locally without Firebase
node scripts/firebase-helper.js test

# Show help
node scripts/firebase-helper.js help
```

## What's New: Smart Sync with Version History

All Firebase uploads now include:

1. **Diff Detection**: See exactly what changed before pushing
2. **Version History**: Automatic backups to `theory_constants/history/backups/`
3. **No-Change Detection**: Won't upload if nothing changed
4. **Safe Rollback**: Restore any previous version
5. **Clear Reporting**: Colored output showing added/removed/changed fields

## Scripts Overview

### Primary Scripts

| Script | Purpose | When to Use |
|--------|---------|-------------|
| `firebase-sync-with-history.js` | Smart sync with diff | After updating theory values |
| `firebase-upload-all.js` | Full data upload | Initial setup or major changes |
| `firebase-push-validated.js` | Production push | Before releasing new version |
| `test-firebase-sync.js` | Local testing | Debugging without Firebase |
| `firebase-helper.js` | CLI wrapper | Convenience commands |

### Helper Scripts (Legacy)

| Script | Purpose |
|--------|---------|
| `firebase-diff.js` | Show diff between local and Firebase |
| `firebase-download.js` | Download Firebase data locally |
| `firebase-check-status.js` | Check Firebase connection |
| `upload-formula-database.js` | Upload formulas only |

## Workflow Examples

### Scenario 1: After Running Simulations

```bash
# 1. Run simulations (updates theory_output.json)
python run_all_simulations.py

# 2. theory-constants-enhanced.js is auto-generated from theory_output.json

# 3. Sync to Firebase with diff and history
node scripts/firebase-helper.js sync
```

**Expected output:**
```
Firebase Sync with Version History
════════════════════════════════════════════════════════════════════════════════

[1/5] Initializing Firebase...
✓ Loaded theory-constants-enhanced.js
  Version: 12.7
  Simulations: 49

[3/5] Computing differences...

Changes detected: 3

CHANGED (3):
  ~ proton_decay.M_GUT
    - 2.1e+16
    + 2.12e+16

[5/5] Updating Firebase...
✓ Backed up to theory_constants/history/backups/2025-12-13_14-30-45
✓ Updated theory_constants/current

✅ Sync complete!
  Changes applied: 3
  Version: 12.7
```

### Scenario 2: Production Release

```bash
# Full validation + sync
node scripts/firebase-helper.js validate
```

This runs:
1. Derivation chain validation
2. OOM accuracy checks
3. Regression detection
4. Diff computation
5. Smart sync with history

### Scenario 3: No Changes

```bash
node scripts/firebase-helper.js sync
```

**Output:**
```
No changes detected - Firebase is up to date
```

## File Structure

### Local Files (Source of Truth)

```
PrincipiaMetaphysica/
├── theory_output.json                  # Generated by simulations
├── theory-constants-enhanced.js        # Single source of truth for PM values
├── js/
│   ├── formula-definitions.js         # Formula metadata
│   └── formula-database.js            # Constants metadata
└── scripts/
    ├── firebase-sync-with-history.js  # Smart sync (NEW)
    ├── firebase-upload-all.js         # Full upload (UPDATED)
    ├── firebase-push-validated.js     # Validated push (UPDATED)
    ├── test-firebase-sync.js          # Local testing (NEW)
    └── firebase-helper.js             # CLI wrapper (NEW)
```

### Firebase Structure

```
Firestore Database:
├── theory_constants/
│   ├── current                         # Latest synced data
│   │   ├── meta: { version, simulations_run, ... }
│   │   ├── dimensions: { ... }
│   │   ├── proton_decay: { ... }
│   │   ├── syncedAt: Timestamp
│   │   └── sync_metadata: { previous_backup, version, ... }
│   │
│   ├── v12_7                          # Version snapshots
│   ├── v12_6
│   │
│   └── history/
│       └── backups/
│           ├── 2025-12-13_14-30-45   # Timestamped backups
│           ├── 2025-12-13_10-15-22
│           └── ...
│
├── formulas/
│   ├── {formula_id}: { id, html, latex, category, ... }
│   └── ...
│
├── pages/
│   ├── {page_id}: { title, content, formulas, ... }
│   └── ...
│
└── validation_history/
    ├── push_{timestamp}: { version, oom_validation, ... }
    └── ...
```

## Data Flow

```
┌─────────────────────────────────────┐
│ config.py (source of truth)        │
└─────────────────┬───────────────────┘
                  │
                  v
┌─────────────────────────────────────┐
│ run_all_simulations.py              │
└─────────────────┬───────────────────┘
                  │
                  v
┌─────────────────────────────────────┐
│ theory_output.json                  │
└─────────────────┬───────────────────┘
                  │
                  v
┌─────────────────────────────────────┐
│ theory-constants-enhanced.js        │  ← Single source of truth for uploads
└─────────────────┬───────────────────┘
                  │
                  v
┌─────────────────────────────────────┐
│ firebase-sync-with-history.js       │
│ - Reads local file                  │
│ - Fetches Firebase current          │
│ - Computes diff                     │
│ - Backs up to history/              │
│ - Updates current                   │
└─────────────────┬───────────────────┘
                  │
                  v
┌─────────────────────────────────────┐
│ Firebase Firestore                  │
│ - theory_constants/current          │
│ - theory_constants/history/backups/ │
└─────────────────────────────────────┘
```

## Setup Instructions

### 1. Get Firebase Service Account Key

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select "principia-metaphysica" project
3. Settings (⚙️) > Project Settings > Service Accounts
4. Click "Generate new private key"
5. Save as one of:
   - `scripts/serviceAccountKey.json`
   - `scripts/principia-metaphysica-firebase-adminsdk-fbsvc-8cbaa9f520.json`
   - `./principia-metaphysica-firebase-adminsdk-fbsvc-8cbaa9f520.json`

### 2. Install Dependencies

```bash
npm install firebase-admin
```

### 3. Test Connection

```bash
node scripts/firebase-helper.js test
```

Should show:
```
✅ All tests passed!
The sync script should work correctly.
```

### 4. First Sync

```bash
node scripts/firebase-helper.js sync
```

## Advanced Usage

### Force Mode (Show All Changes)

```bash
node scripts/firebase-sync-with-history.js --force
```

Shows all changes instead of limiting to 20-30.

### Direct Script Execution

```bash
# Sync only
node scripts/firebase-sync-with-history.js

# Full upload
node scripts/firebase-upload-all.js

# Validated push
node scripts/firebase-push-validated.js
```

### Programmatic Usage

```javascript
const { firebaseSyncWithHistory } = require('./scripts/firebase-sync-with-history.js');

async function myScript() {
  const result = await firebaseSyncWithHistory();

  if (result.updated) {
    console.log(`Synced ${result.diffs} changes`);
    console.log(`Backup: ${result.backupId}`);
  } else {
    console.log('No changes');
  }
}
```

## Rollback Procedure

If you need to restore a previous version:

### Option 1: Firebase Console

1. Go to Firebase Console > Firestore
2. Navigate to `theory_constants/history/backups/`
3. Find the backup you want (e.g., `2025-12-13_14-30-45`)
4. Copy all fields
5. Go to `theory_constants/current`
6. Replace all fields
7. Remove backup metadata fields: `backup_timestamp`, `backed_up_at`, `replaced_by_version`, `metadata`

### Option 2: Script (Create if needed)

```javascript
// scripts/firebase-rollback.js
const admin = require('firebase-admin');
const backupId = '2025-12-13_14-30-45';

async function rollback() {
  const db = admin.firestore();

  const backup = await db.collection('theory_constants')
    .doc('history')
    .collection('backups')
    .doc(backupId)
    .get();

  const data = backup.data();
  delete data.backup_timestamp;
  delete data.backed_up_at;
  delete data.replaced_by_version;
  delete data.metadata;

  await db.collection('theory_constants').doc('current').set({
    ...data,
    restoredFrom: backupId,
    restoredAt: admin.firestore.FieldValue.serverTimestamp()
  });

  console.log(`Restored from ${backupId}`);
}
```

## Troubleshooting

### "Service account key not found"

**Problem:** Script can't find Firebase credentials

**Solution:**
1. Download key from Firebase Console (see Setup Instructions)
2. Save to one of the expected locations
3. Make sure filename matches exactly

### "No changes detected" but I expect changes

**Problem:** Diff shows no changes

**Solution:**
1. Verify you edited `theory-constants-enhanced.js`
2. Check file was saved
3. Run `node scripts/test-firebase-sync.js` to test parsing
4. Check Firebase Console to see current data

### Changes are too large/too deep

**Problem:** Firestore depth limit errors

**Solution:**
The script automatically handles this by:
- Flattening objects beyond 15 levels
- Converting deep structures to JSON strings
- This should be automatic

### Want to see detailed diff

**Problem:** Output is truncated

**Solution:**
```bash
node scripts/firebase-sync-with-history.js --force
```

## Safety Features

✅ **No data loss** - Current data always backed up before overwrite
✅ **Transparent** - See exactly what changes before pushing
✅ **Idempotent** - Safe to run multiple times with same data
✅ **Versioned** - All backups tagged with timestamp
✅ **Rollback ready** - Can restore any previous version

## Performance

- **Diff computation:** Fast (< 1 second for typical data)
- **Network calls:** 2-3 per sync (1 read, 1-2 writes)
- **Firestore reads:** 1 document read per sync
- **Firestore writes:** 2-3 documents per sync (current + version + backup)

## Security

- Service account key stored locally (not in repo)
- Add to `.gitignore`: `**/serviceAccountKey.json`
- Firestore security rules control write access
- No credentials in code

## Documentation Files

- `FIREBASE_SYNC_README.md` - Full technical documentation
- `QUICK_START_FIREBASE_SYNC.md` - Quick start guide
- `FIREBASE_SYNC_SUMMARY.md` - Implementation details
- `README_FIREBASE.md` - This file (complete guide)

## License

Copyright (c) 2025-2026 Andrew Keith Watts. All rights reserved.

## Support

For issues or questions:
1. Check this documentation
2. Run `node scripts/firebase-helper.js help`
3. Test locally: `node scripts/firebase-helper.js test`
4. Review Firebase Console for current data state
