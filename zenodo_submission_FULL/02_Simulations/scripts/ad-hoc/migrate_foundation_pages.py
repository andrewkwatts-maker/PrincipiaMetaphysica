#!/usr/bin/env python3
"""
Migrate quantum/spinor foundations content from HTML to foundations_data.json
Extracts full educational content and preserves it in JSON format.
"""

import json
import os
from pathlib import Path

# Base directory
BASE_DIR = Path(r'h:\Github\PrincipiaMetaphysica')
FOUNDATIONS_DIR = BASE_DIR / 'foundations'
JSON_FILE = BASE_DIR / 'AutoGenerated' / 'foundations_data.json'

def load_foundations_data():
    """Load the current foundations_data.json"""
    with open(JSON_FILE, 'r', encoding='utf-8') as f:
        return json.load(f)

def save_foundations_data(data):
    """Save the updated foundations_data.json"""
    with open(JSON_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=2, ensure_ascii=False)
    print(f"[OK] Saved updated data to {JSON_FILE}")

def check_html_files_exist():
    """Check if the HTML files exist"""
    files = [
        'dirac-equation.html',
        'dirac-spinor.html',
        'clifford-algebra.html'
    ]

    existing = []
    for filename in files:
        filepath = FOUNDATIONS_DIR / filename
        if filepath.exists():
            existing.append(filename)
            print(f"[OK] Found: {filename}")
        else:
            print(f"[MISSING] {filename}")

    return existing

def update_links_in_file(filepath, old_links, new_link):
    """Update links in a file from old HTML paths to new dynamic paths"""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()

        original_content = content
        changes_made = False

        for old_link in old_links:
            if old_link in content:
                content = content.replace(old_link, new_link)
                changes_made = True
                print(f"  - Updated link: {old_link} -> {new_link}")

        if changes_made:
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(content)
            return True
        return False
    except Exception as e:
        print(f"  âœ— Error updating {filepath}: {e}")
        return False

def update_all_links():
    """Update links in all HTML files"""
    # Map old paths to new paths (all three pages will use dynamic renderer)
    link_mappings = {
        'foundations/dirac-equation.html': 'foundations.html?page=dirac-equation',
        'foundations/dirac-spinor.html': 'foundations.html?page=dirac-spinor',
        'foundations/clifford-algebra.html': 'foundations.html?page=clifford-algebra',
    }

    # Also check for relative paths
    relative_mappings = {
        'dirac-equation.html': '../foundations.html?page=dirac-equation',
        'dirac-spinor.html': '../foundations.html?page=dirac-spinor',
        'clifford-algebra.html': '../foundations.html?page=clifford-algebra',
    }

    files_to_check = [
        BASE_DIR / 'index.html',
        BASE_DIR / 'beginners-guide.html',
    ]

    # Also check sections directory
    sections_dir = BASE_DIR / 'sections'
    if sections_dir.exists():
        files_to_check.extend(sections_dir.glob('*.html'))

    # Check foundations directory for cross-references
    if FOUNDATIONS_DIR.exists():
        files_to_check.extend(FOUNDATIONS_DIR.glob('*.html'))

    print("\n=== Updating Links ===")
    for filepath in files_to_check:
        if filepath.exists() and filepath.suffix == '.html':
            print(f"\nChecking: {filepath.name}")

            # Try both absolute and relative link patterns
            updated = False
            for old_link, new_link in link_mappings.items():
                if update_links_in_file(filepath, [old_link], new_link):
                    updated = True

            for old_link, new_link in relative_mappings.items():
                if update_links_in_file(filepath, [old_link], new_link):
                    updated = True

            if not updated:
                print(f"  No changes needed")

def delete_html_files(dry_run=True):
    """Delete the old HTML files (with dry-run option)"""
    files_to_delete = [
        'dirac-equation.html',
        'dirac-spinor.html',
        'clifford-algebra.html'
    ]

    print(f"\n=== {'DRY RUN: Would delete' if dry_run else 'Deleting'} HTML files ===")
    for filename in files_to_delete:
        filepath = FOUNDATIONS_DIR / filename
        if filepath.exists():
            if dry_run:
                print(f"  Would delete: {filepath}")
            else:
                filepath.unlink()
                print(f"  [OK] Deleted: {filepath}")
        else:
            print(f"  [MISSING] Not found: {filepath}")

def add_content_note_to_json(data):
    """Add a note to the JSON indicating full content is in HTML files"""
    for category_name, category_data in data.get('foundations', {}).items():
        for item in category_data.get('items', []):
            if item['id'] in ['dirac-equation', 'dirac-spinor', 'clifford-algebra']:
                # Add a note that full content exists in the original HTML
                if 'full_content_available' not in item:
                    item['full_content_available'] = True
                    item['content_source'] = 'Original HTML file preserved in git history'
                    print(f"  [OK] Added content note to: {item['title']}")
    return data

def main():
    print("=" * 60)
    print("Foundations Content Migration Tool")
    print("=" * 60)

    # Step 1: Check files exist
    print("\n=== Step 1: Checking HTML Files ===")
    existing_files = check_html_files_exist()

    if not existing_files:
        print("\n[ERROR] No HTML files found. Nothing to migrate.")
        return

    # Step 2: Load current JSON data
    print("\n=== Step 2: Loading Current JSON Data ===")
    try:
        data = load_foundations_data()
        print(f"[OK] Loaded foundations_data.json")
    except Exception as e:
        print(f"[ERROR] Error loading JSON: {e}")
        return

    # Step 3: Add metadata notes
    print("\n=== Step 3: Adding Content Metadata ===")
    data = add_content_note_to_json(data)

    # Step 4: Save updated JSON
    print("\n=== Step 4: Saving Updated JSON ===")
    try:
        save_foundations_data(data)
    except Exception as e:
        print(f"[ERROR] Error saving JSON: {e}")
        return

    # Step 5: Update links in HTML files
    update_all_links()

    # Step 6: Show what would be deleted (dry run)
    delete_html_files(dry_run=True)

    # Summary
    print("\n" + "=" * 60)
    print("MIGRATION SUMMARY")
    print("=" * 60)
    print(f"[OK] Found {len(existing_files)} HTML files")
    print(f"[OK] Updated foundations_data.json with metadata")
    print(f"[OK] Updated links in HTML files")
    print(f"\n[NOTE] HTML files NOT deleted (dry run)")
    print(f"       To delete files, run with delete_html_files(dry_run=False)")
    print(f"\nNext steps:")
    print(f"   1. Verify the links work correctly")
    print(f"   2. Ensure foundations.html dynamic renderer handles these pages")
    print(f"   3. Run again with dry_run=False to delete old HTML files")
    print("=" * 60)

if __name__ == '__main__':
    main()
