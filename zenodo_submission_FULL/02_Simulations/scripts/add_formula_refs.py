#!/usr/bin/env python3
"""
Add formula references to parameters.json metadata.

This script:
1. Reads formulas.json to build output_param -> formula mapping
2. Updates parameters.json to include deriving_formula in metadata
"""

import json
import os
from pathlib import Path

def main():
    # Paths
    project_root = Path(__file__).parent.parent
    formulas_path = project_root / "AutoGenerated" / "formulas.json"
    params_path = project_root / "AutoGenerated" / "parameters.json"

    # Load formulas
    print(f"Loading formulas from {formulas_path}")
    with open(formulas_path, 'r', encoding='utf-8') as f:
        formulas_data = json.load(f)

    # Build param -> formula mapping
    param_to_formula = {}
    for formula_id, formula in formulas_data.get("formulas", {}).items():
        output_params = formula.get("output_params", [])
        for param in output_params:
            if param not in param_to_formula:
                param_to_formula[param] = []
            param_to_formula[param].append({
                "id": formula_id,
                "label": formula.get("label", ""),
                "latex": formula.get("latex", ""),
                "description": formula.get("description", ""),
                "category": formula.get("category", "")
            })

    print(f"Found {len(param_to_formula)} parameters with deriving formulas")

    # Load parameters
    print(f"Loading parameters from {params_path}")
    with open(params_path, 'r', encoding='utf-8') as f:
        params_data = json.load(f)

    # Update parameters with formula references
    updated_count = 0
    for param_path, param in params_data.get("parameters", {}).items():
        if param_path in param_to_formula:
            if "metadata" not in param:
                param["metadata"] = {}
            param["metadata"]["deriving_formulas"] = param_to_formula[param_path]
            updated_count += 1

    print(f"Updated {updated_count} parameters with formula references")

    # Also add gate references for validation parameters
    gate_params = [p for p in params_data.get("parameters", {}).keys()
                   if p.startswith("gates.") or p.startswith("certificates.")]
    print(f"Found {len(gate_params)} gate/certificate parameters")

    # Save updated parameters
    print(f"Saving updated parameters to {params_path}")
    with open(params_path, 'w', encoding='utf-8') as f:
        json.dump(params_data, f, indent=2, ensure_ascii=False)

    print("Done!")

    # Print some examples
    print("\nExample parameter-formula mappings:")
    for param, formulas in list(param_to_formula.items())[:10]:
        print(f"  {param}:")
        for f in formulas:
            print(f"    - {f['id']} ({f['label']})")


if __name__ == "__main__":
    main()
